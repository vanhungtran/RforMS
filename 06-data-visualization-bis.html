<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>data-visualization-bis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="06-data-visualization-bis_files/libs/clipboard/clipboard.min.js"></script>
<script src="06-data-visualization-bis_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="06-data-visualization-bis_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="06-data-visualization-bis_files/libs/quarto-html/popper.min.js"></script>
<script src="06-data-visualization-bis_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="06-data-visualization-bis_files/libs/quarto-html/anchor.min.js"></script>
<link href="06-data-visualization-bis_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="06-data-visualization-bis_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="06-data-visualization-bis_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="06-data-visualization-bis_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="06-data-visualization-bis_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">




<section id="data-visualization-for-mass-spectrometry-a-comprehensive-r-based-workflow" class="level1">
<h1>Data Visualization for Mass Spectrometry: A Comprehensive R-Based Workflow</h1>
<section id="executive-summary" class="level2">
<h2 class="anchored" data-anchor-id="executive-summary">Executive Summary</h2>
<p>This report provides a comprehensive, expert-level guide to the visualization of mass spectrometry (MS) data using the R programming language. It is structured as a complete workflow, guiding the user from the foundational concepts of MS data formats and the R/Bioconductor ecosystem to the generation of publication-quality figures for proteomics and metabolomics. The analysis covers raw data visualizations (spectra, chromatograms), identification-level plots (annotated MS/MS, mirror plots, peptide maps), and high-level statistical visualizations (PCA, t-SNE, heatmaps, volcano plots). The report emphasizes modern, scalable R packages and provides reproducible code examples for each visualization type, culminating in two end-to-end case studies that synthesize these concepts into reproducible data analysis pipelines.</p>
</section>
<section id="the-rbioconductor-ecosystem-for-mass-spectrometry-data" class="level2">
<h2 class="anchored" data-anchor-id="the-rbioconductor-ecosystem-for-mass-spectrometry-data">The R/Bioconductor Ecosystem for Mass Spectrometry Data</h2>
<p>To effectively visualize mass spectrometry data, one must first understand the structure of the data itself and the specialized software ecosystem designed to handle it. The R programming language, augmented by the Bioconductor project, provides the most powerful and flexible environment for this task.</p>
<section id="the-mass-spectrometry-data-challenge-formats-and-complexity" class="level3">
<h3 class="anchored" data-anchor-id="the-mass-spectrometry-data-challenge-formats-and-complexity">The Mass Spectrometry Data Challenge: Formats and Complexity</h3>
<p>Mass spectrometry experiments generate vast and complex datasets. The primary data types are spectra, which represent the relative abundance of ions as a function of their mass-to-charge ratio (<span class="math inline">\(m/z\)</span>), and chromatograms, which represent signal intensity over time. This data is inherently hierarchical, with individual peaks existing within spectra, which are acquired sequentially in a run, which is part of a larger experiment.</p>
<p>This complexity is compounded by a fragmented landscape of data formats. Historically, each instrument vendor developed proprietary, binary formats for their raw data (e.g., Bruker’s.BAF and.TDF, Agilent’s.AEV).[1] This created significant barriers to data sharing and reproducible analysis. To solve this, a community-driven effort established open, standardized, XML-based formats, most notably <code>mzML</code>, <code>mzXML</code>, and <code>mzData</code>, which are now the <em>lingua franca</em> for raw MS data.[2, 3, 4, 5] These have been complemented by similar standards for identification results (<code>mzIdentML</code>) and quantitative data (<code>mzQuantML</code>).[2, 4]</p>
<p>The challenge, however, remains. Spectra produced during MS experiments contain an enormous volume of data, but “only a small portion contains potentially relevant information for biological studies”. The central task of any MS analysis pipeline is to extract this relevant information and distinguish it from experimental noise. This task is severely hindered by a lack of methodological standardization. Many published studies fail to provide sufficient detail to allow for replication, highlighting a critical need for “standardised workflows and reporting systems”.[6] The R and Bioconductor ecosystem is the definitive solution to this problem.</p>
</section>
<section id="the-bioconductor-solution-a-modern-interoperable-framework" class="level3">
<h3 class="anchored" data-anchor-id="the-bioconductor-solution-a-modern-interoperable-framework">The Bioconductor Solution: A Modern, Interoperable Framework</h3>
<p>While the Comprehensive R Archive Network (CRAN) is a general-purpose repository for R packages [7], the Bioconductor project is a specialized repository designed explicitly for the analysis and comprehension of high-throughput genomic and ’omics data, including mass spectrometry.[8] The core philosophy of Bioconductor is interoperability. It achieves this by mandating that packages “interoperate with other Bioconductor packages by re-using common data structures” and “adopt software best practices that enable reproducible research,” such as comprehensive documentation and vignettes.[8]</p>
<p>This philosophy is central to understanding the evolution of MS data handling in R. For many years, the <code>MSnbase</code> package was the cornerstone of proteomics analysis.[9, 10] It introduced the foundational <code>MSnExp</code> object, a data structure that typically loaded an entire experiment’s raw data into system memory (RAM).[11, 12] While revolutionary, this “in-memory” approach created a significant scalability bottleneck as instrument speed and file sizes grew.[5, 11] The <code>MSnbase</code> vignettes themselves document this challenge, noting that large files “require large amounts of RAM” and promoting “on-disk random access to the content of mzXML/mzML data files on demand” as the necessary solution.[5, 10]</p>
<p>This necessity drove the development of a modern, “next-gen” [12] infrastructure: the <code>RforMassSpectrometry</code> (RforMS) initiative.[13, 14, 15] This collaborative effort built a new suite of packages designed from the ground up for efficiency, scalability, and modularity, addressing the limitations of the classic in-memory approach.[14]</p>
</section>
<section id="core-infrastructure-the-pillars-of-modern-ms-data-handling" class="level3">
<h3 class="anchored" data-anchor-id="core-infrastructure-the-pillars-of-modern-ms-data-handling">Core Infrastructure: The Pillars of Modern MS Data Handling</h3>
<p>The <code>RforMassSpectrometry</code> initiative is built on a modular set of core packages, each handling a different level of the hierarchical MS data. This separation of concerns is its primary architectural advantage.</p>
<ol type="1">
<li><p><strong><code>Spectra</code>:</strong> This is the core package for handling raw spectral data (both MS1 and tandem MS/MS).[13] Its key innovation is a flexible backend system (e.g., <code>MsBackendMzR</code>) that allows data to be queried directly from on-disk files (<code>mzML</code>, <code>mzXML</code>) without loading the entire dataset into memory.[16, 17] This “on-disk” paradigm “is designed with efficiency, both in terms of memory footprint and processing time in mind”.[13, 16]</p></li>
<li><p><strong><code>Chromatograms</code>:</strong> This package is purpose-built to “provide base classes and processing methods for chromatographic data”.[13, 18] It cleanly separates the handling of 1D chromatogram data from the 2D spectral data managed by <code>Spectra</code>.</p></li>
<li><p><strong><code>QFeatures</code>:</strong> This essential package provides the infrastructure “to manage and process quantitative features for high-throughput mass spectrometry assays”.[13] In proteomics, data is aggregated from spectra to peptides and then to proteins. <code>QFeatures</code> manages these complex, multi-level relationships (assays) within a single experiment, linking the raw data to the final quantitative matrix.[19]</p></li>
</ol>
<p>These modern packages are powered by an “engine” and extended by a “specialist”:</p>
<ul>
<li><p><strong>The Engine: <code>mzR</code>:</strong> This foundational Bioconductor package provides the low-level, high-speed parsing functions to read the raw <code>mzML</code>, <code>mzXML</code>, and <code>mzData</code> files.[3, 4, 5] Both the classic <code>MSnbase</code> and modern <code>Spectra</code> packages rely on <code>mzR</code> to access the data.</p></li>
<li><p><strong>The Metabolomics Specialist: <code>xcms</code>:</strong> This is the definitive, end-to-end package for differential profiling in metabolomics.[20, 21, 22] Modern versions of <code>xcms</code> are built directly on the <code>RforMassSpectrometry</code> infrastructure, using <code>Spectra</code> and <code>MsExperiment</code> objects to perform its workflow of chromatographic peak detection, retention time correction, and feature alignment.[20]</p></li>
</ul>
</section>
<section id="table-1-key-r-packages-for-mass-spectrometry-visualization" class="level3">
<h3 class="anchored" data-anchor-id="table-1-key-r-packages-for-mass-spectrometry-visualization">Table 1: Key R Packages for Mass Spectrometry Visualization</h3>
<p>The following table provides a “map” to the complex but powerful R package ecosystem for MS data analysis and visualization.</p>
<table class="caption-top table">
<colgroup>
<col style="width: 33%">
<col style="width: 33%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Package</th>
<th style="text-align: left;">Repository</th>
<th style="text-align: left;">Primary Function(s)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>mzR</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Data Access: The foundational parser for <code>mzML</code>, <code>mzXML</code>, <code>mzData</code> files.[3, 4]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>MSnbase</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Classic Data Structure: Defines <code>MSnExp</code> (in-memory) and <code>OnDiskMSnExp</code> objects; provides plotting, processing, and quantification functions.[3, 9, 11]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Spectra</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Modern Data Structure: Defines <code>Spectra</code> objects for scalable, on-disk handling of raw spectral data.[13, 16]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Chromatograms</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Chromatogram Structure: Defines objects and methods for chromatographic data.[13, 18]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>QFeatures</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Quantitative Data: Manages complex quantitative proteomics/metabolomics experiments, linking assays (PSM, peptide, protein).[13, 19]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>xcms</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Metabolomics Workflow: End-to-end processing (peak detection, alignment) and visualization (TIC, BPC, XIC).[20, 22, 23]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>ropls</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Multivariate Statistics &amp; Viz: The ’omics-standard for PCA, PLS-DA, and OPLS-DA.[24, 25, 26]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>EnhancedVolcano</code></td>
<td style="text-align: left;">Bioconductor</td>
<td style="text-align: left;">Differential Abundance Viz: Publication-ready, highly-customizable volcano plots.[27]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>PepMapViz</code></td>
<td style="text-align: left;">CRAN</td>
<td style="text-align: left;">Peptide Mapping Viz: Plots peptide coverage on protein sequences, with domains and PTMs.[28, 29, 30]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>pheatmap</code></td>
<td style="text-align: left;">CRAN</td>
<td style="text-align: left;">Heatmap Viz: Publication-ready, annotated heatmaps with clustering.[31]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>Rtsne</code></td>
<td style="text-align: left;">CRAN</td>
<td style="text-align: left;">t-SNE Calculation: The R implementation of the t-SNE algorithm.[32, 33, 34]</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ggplot2</code></td>
<td style="text-align: left;">CRAN</td>
<td style="text-align: left;">Grammar of Graphics: The foundational visualization library used to create custom plots.[35, 36, 37]</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>plotly</code></td>
<td style="text-align: left;">CRAN</td>
<td style="text-align: left;">Interactivity: Converts static <code>ggplot2</code> plots into interactive web graphics.[38, 39, 40]</td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="foundational-visualizations-raw-data-exploration-lc-ms" class="level2">
<h2 class="anchored" data-anchor-id="foundational-visualizations-raw-data-exploration-lc-ms">Foundational Visualizations: Raw Data Exploration (LC-MS)</h2>
<p>The first step in any analysis pipeline is the visualization and quality control of the raw liquid chromatography-mass spectrometry (LC-MS) data. This involves inspecting both individual spectra and whole-run chromatograms.</p>
<section id="visualizing-mass-spectra-ms1" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-mass-spectra-ms1">Visualizing Mass Spectra (MS1)</h3>
<p>A mass spectrum plot (m/z vs.&nbsp;intensity) is the most fundamental visualization in mass spectrometry. It is used to inspect signal quality, mass calibration, and peak shapes (i.e., “profile” vs.&nbsp;“centroided” data).</p>
</section>
<section id="method-1-classic-using-msnbaseplot" class="level3">
<h3 class="anchored" data-anchor-id="method-1-classic-using-msnbaseplot">Method 1 (Classic): Using <code>MSnbase::plot()</code></h3>
<p>The <code>MSnbase</code> package provides a robust <code>plot</code> method for its objects. Data is first read into an <code>MSnExp</code> object, and then individual spectra can be accessed by index (e.g., ``) and plotted.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Final robust loader for mzXML / mzML (handles MS1 or MS2-only files)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: MSnbase, mzR, (optional) msdata for example files</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"MSnbase"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"MSnbase"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in fun(libname, pkgname): mzR has been built against a different Rcpp version (1.0.14)
than is installed on your system (1.1.0). This might lead to errors
when loading mzR. If you encounter such issues, please send a report,
including the output of sessionInfo() to the Bioc support forum at 
https://support.bioconductor.org/. For details see also
https://github.com/sneumann/mzR/wiki/mzR-Rcpp-compiler-linker-issue.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"mzR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"mzR"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"msdata"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"msdata"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MSnbase)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: BiocGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: generics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'generics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.difftime, as.factor, as.ordered, intersect, is.element, setdiff,
    setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'BiocGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    IQR, mad, sd, var, xtabs</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    anyDuplicated, aperm, append, as.data.frame, basename, cbind,
    colnames, dirname, do.call, duplicated, eval, evalq, Filter, Find,
    get, grep, grepl, is.unsorted, lapply, Map, mapply, match, mget,
    order, paste, pmax, pmax.int, pmin, pmin.int, Position, rank,
    rbind, Reduce, rownames, sapply, saveRDS, table, tapply, unique,
    unsplit, which.max, which.min</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Biobase</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Welcome to Bioconductor

    Vignettes contain introductory material; view with
    'browseVignettes()'. To cite Bioconductor, see
    'citation("Biobase")', and for packages 'citation("pkgname")'.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: mzR</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Rcpp</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: S4Vectors</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: stats4</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'S4Vectors'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:utils':

    findMatches</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    expand.grid, I, unname</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: ProtGenerics</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'ProtGenerics'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:stats':

    smooth</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
This is MSnbase version 2.34.1 
  Visit https://lgatto.github.io/MSnbase/ to get started.
 Consider switching to the 'R for Mass Spectrometry'
 packages - see https://RforMassSpectrometry.org for details.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MSnbase'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    trimws</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mzR)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(msdata)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Collect candidate files from MSnbase and msdata example folders</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>files_msnbase <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"MSnbase"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>files_msdata  <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"msdata"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">c</span>(files_msnbase, files_msdata))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No mzXML/mzML files found in example folders."</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect MS levels present in each file and print summary</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>info <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, <span class="cf">function</span>(f) {</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  msobj <span class="ot">&lt;-</span> <span class="fu">openMSfile</span>(f)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  hdr <span class="ot">&lt;-</span> <span class="fu">header</span>(msobj)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  lvls <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(hdr<span class="sc">$</span>msLevel))</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(msobj)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">file =</span> f, <span class="at">mslevels =</span> lvls)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (it <span class="cf">in</span> info) {</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"File:"</span>, it<span class="sc">$</span>file, <span class="st">"</span><span class="sc">\n</span><span class="st">  MS levels present:"</span>, <span class="fu">paste</span>(it<span class="sc">$</span>mslevels, <span class="at">collapse =</span> <span class="st">", "</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>File: C:/Users/tranh/AppData/Local/R/win-library/4.5/MSnbase/extdata/dummyiTRAQ.mzXML 
  MS levels present: 2 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Choose a file containing MS1 if available, otherwise fall back to first file</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>file_with_ms1 <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (it <span class="cf">in</span> info) <span class="cf">if</span> (<span class="dv">1</span> <span class="sc">%in%</span> it<span class="sc">$</span>mslevels) { file_with_ms1 <span class="ot">&lt;-</span> it<span class="sc">$</span>file; <span class="cf">break</span> }</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(file_with_ms1)) {</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  chosen_file <span class="ot">&lt;-</span> file_with_ms1</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  mslevel_to_read <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Selected file with MS1: "</span>, chosen_file)</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  chosen_file <span class="ot">&lt;-</span> info[[<span class="dv">1</span>]]<span class="sc">$</span>file</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  mslevel_to_read <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No file contains MS1. Will read all spectra from: "</span>, chosen_file)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No file contains MS1. Will read all spectra from: C:/Users/tranh/AppData/Local/R/win-library/4.5/MSnbase/extdata/dummyiTRAQ.mzXML</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data (onDisk recommended for real/large files)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>msexp <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="fu">is.null</span>(mslevel_to_read)) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readMSData</span>(<span class="at">files =</span> chosen_file, <span class="at">mode =</span> <span class="st">"onDisk"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">readMSData</span>(<span class="at">files =</span> chosen_file, <span class="at">msLevel. =</span> mslevel_to_read, <span class="at">mode =</span> <span class="st">"onDisk"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(msexp)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn experiment data ("OnDiskMSnExp")
Object size in memory: 0.03 Mb
- - - Spectra data - - -
 MS level(s): 2 
 Number of spectra: 5 
 MSn retention times: 25:01 - 25:02 minutes
- - - Processing information - - -
Data loaded [Wed Nov 19 10:18:56 2025] 
 MSnbase version: 2.34.1 
- - - Meta data  - - -
phenoData
  rowNames: dummyiTRAQ.mzXML
  varLabels: sampleNames
  varMetadata: labelDescription
Loaded from:
  dummyiTRAQ.mzXML 
protocolData: none
featureData
  featureNames: F1.S1 F1.S2 ... F1.S5 (5 total)
  fvarLabels: fileIdx spIdx ... spectrum (36 total)
  fvarMetadata: labelDescription
experimentData: use 'experimentData(object)'</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Number of spectra read:"</span>, <span class="fu">length</span>(msexp), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of spectra read: 5 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"MS level distribution:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">table</span>(<span class="fu">msLevel</span>(msexp)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MS level distribution:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
2 
5 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting examples</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(msexp) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No spectra were read."</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot first spectrum (works for MS1 or MS2)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(msexp[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-data-visualization-bis_files/figure-html/plot-spectrum-msnbase-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Additional helpful snippets (uncomment as needed)</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Plot TIC (Total Ion Chromatogram)</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># rt &lt;- rtime(msexp) / 60  # convert seconds to minutes if needed</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot(rt, tic(msexp), type = "l", xlab = "Retention time (min)", ylab = "TIC")</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Inspect precursor table (useful for MS2)</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># hdr &lt;- fData(msexp)</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># print(head(hdr[, c("precursorMZ", "precursorCharge", "precursorIntensity", "rt")], 10))</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Extract mz/intensity matrix for first spectrum</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># sp &lt;- spectra(msexp[1])[[1]]</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># mzs &lt;- mz(sp); ints &lt;- intensity(sp)</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="co"># head(cbind(mz = mzs, intensity = ints))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="method-2-modern-using-spectraplotspectra" class="level4">
<h4 class="anchored" data-anchor-id="method-2-modern-using-spectraplotspectra">Method 2 (Modern): Using <code>Spectra::plotSpectra()</code></h4>
<p>The <code>Spectra</code> package provides the modern <code>plotSpectra</code> function, which operates on <code>Spectra</code> objects. This function is highly flexible, capable of plotting a single spectrum or overlaying multiple spectra in a single panel with specified colors and labels.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Robust extraction and plotting of the first spectrum's peaks</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: mzR, Spectra (optional), MSnbase (optional)</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"mzR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"mzR"</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mzR)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Spectra is optional; if you already used it, keep it loaded</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"Spectra"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(Spectra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: BiocParallel</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'Spectra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:MSnbase':

    combineSpectra, pickPeaks, plotMzDelta</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># locate file(s) - adjust to your actual file if needed</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"MSnbase"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No mzXML/mzML example files found; set 'files' to your data file path."</span>)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>chosen_file <span class="ot">&lt;-</span> files[<span class="dv">1</span>]</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Using file: "</span>, chosen_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using file: C:/Users/tranh/AppData/Local/R/win-library/4.5/MSnbase/extdata/dummyiTRAQ.mzXML</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Attempt 1: use Spectra::peaksData if available and usable</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>pks_list <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="st">"Spectra"</span> <span class="sc">%in%</span> <span class="fu">loadedNamespaces</span>()) {</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">try</span>({</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    sp_obj <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">Spectra</span>(chosen_file), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(sp_obj)) {</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>      pks_list <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">peaksData</span>(sp_obj), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="co"># If peaksData returned a usable list/matrix, use it; otherwise fall back to mzR</span></span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.list</span>(pks_list) <span class="sc">&amp;&amp;</span> <span class="fu">length</span>(pks_list) <span class="sc">&gt;=</span> <span class="dv">1</span> <span class="sc">&amp;&amp;</span> <span class="sc">!</span><span class="fu">is.null</span>(pks_list[[<span class="dv">1</span>]])) {</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Using peaksData from Spectra."</span>)</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>  first_pk <span class="ot">&lt;-</span> pks_list[[<span class="dv">1</span>]]</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"peaksData unavailable or empty; falling back to mzR::openMSfile + peaks()."</span>)</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  msobj <span class="ot">&lt;-</span> <span class="fu">openMSfile</span>(chosen_file)</span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  hdr <span class="ot">&lt;-</span> <span class="fu">header</span>(msobj)</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(hdr) <span class="sc">&lt;</span> <span class="dv">1</span>) {</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">close</span>(msobj)</span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"File contains no spectra according to mzR header."</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pick the first spectrum index (you can choose a different index)</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a>  first_index <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a>  first_pk <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">peaks</span>(msobj, first_index), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(msobj)</span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.null</span>(first_pk) <span class="sc">||</span> <span class="fu">nrow</span>(first_pk) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"mzR failed to return peak list for the first spectrum."</span>)</span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>peaksData unavailable or empty; falling back to mzR::openMSfile + peaks().</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first_pk should be a matrix/data.frame with at least 2 columns: m/z and intensity</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="fu">is.matrix</span>(first_pk) <span class="sc">||</span> <span class="fu">is.data.frame</span>(first_pk)) <span class="sc">||</span> <span class="fu">ncol</span>(first_pk) <span class="sc">&lt;</span> <span class="dv">2</span>) {</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Unexpected peak-list format; expected a 2-column matrix or data.frame (m/z, intensity)."</span>)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>mzvals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(first_pk[, <span class="dv">1</span>])</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>intvals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(first_pk[, <span class="dv">2</span>])</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>ok <span class="ot">&lt;-</span> <span class="sc">!</span>(<span class="fu">is.na</span>(mzvals) <span class="sc">|</span> <span class="fu">is.na</span>(intvals))</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>mzvals <span class="ot">&lt;-</span> mzvals[ok]; intvals <span class="ot">&lt;-</span> intvals[ok]</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(mzvals) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No valid m/z / intensity values to plot."</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Open screen device if possible; otherwise write PNG</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>open_screen_device <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">w =</span> <span class="dv">10</span>, <span class="at">h =</span> <span class="dv">7</span>) {</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  ok <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dev.new</span>(<span class="at">width =</span> w, <span class="at">height =</span> h)</span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) ok <span class="ot">&lt;&lt;-</span> <span class="cn">FALSE</span>)</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>  ok</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>opened <span class="ot">&lt;-</span> <span class="fu">open_screen_device</span>(<span class="dv">10</span>, <span class="dv">7</span>)</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>opened) {</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>  pngfile <span class="ot">&lt;-</span> <span class="st">"spectrum1.png"</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">png</span>(pngfile, <span class="at">width =</span> <span class="dv">1600</span>, <span class="at">height =</span> <span class="dv">900</span>, <span class="at">res =</span> <span class="dv">150</span>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Screen device not available — plotting to file: "</span>, pngfile)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot stick (vertical) spectrum</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>oldpar <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">no.readonly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">4</span>, <span class="dv">2</span>, <span class="dv">1</span>))</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mzvals, intvals, <span class="at">type =</span> <span class="st">"h"</span>, <span class="at">xlab =</span> <span class="st">"m/z"</span>, <span class="at">ylab =</span> <span class="st">"Intensity"</span>,</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Spectrum 1 from"</span>, <span class="fu">basename</span>(chosen_file)))</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(oldpar)</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>opened) <span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="method-3-publication-ready-using-ggplot2-geom_segment" class="level4">
<h4 class="anchored" data-anchor-id="method-3-publication-ready-using-ggplot2-geom_segment">Method 3 (Publication-Ready): Using <code>ggplot2 + geom_segment</code></h4>
<p>For maximum control over aesthetics for publication, a spectrum plot can be constructed manually using <code>ggplot2</code>. The key is to use <code>geom_segment</code> to draw a vertical line (a “stick”) for each <span class="math inline">\(m/z\)</span>-intensity pair, connecting the peak’s intensity to the zero baseline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Publication-ready stick spectrum using ggplot2::geom_segment</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: ggplot2, mzR (Spectra optional)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"mzR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>  BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"mzR"</span>)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mzR)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a><span class="co"># --- locate file (adjust path to your own data file) ---</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"MSnbase"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No mzXML/mzML example files found; set 'files' to your data file path."</span>)</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>chosen_file <span class="ot">&lt;-</span> files[<span class="dv">1</span>]</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- extract first spectrum peaks robustly via mzR (fallback if Spectra/peaksData fails) ---</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>msobj <span class="ot">&lt;-</span> <span class="fu">openMSfile</span>(chosen_file)</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>hdr <span class="ot">&lt;-</span> <span class="fu">header</span>(msobj)</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(hdr) <span class="sc">&lt;</span> <span class="dv">1</span>) { <span class="fu">close</span>(msobj); <span class="fu">stop</span>(<span class="st">"File contains no spectra according to mzR header."</span>) }</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>pk <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="fu">peaks</span>(msobj, <span class="dv">1</span>L), <span class="at">error =</span> <span class="cf">function</span>(e) <span class="cn">NULL</span>)</span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="fu">close</span>(msobj)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(pk) <span class="sc">||</span> <span class="fu">nrow</span>(pk) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Failed to extract peak list for the first spectrum."</span>)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a><span class="co"># pk is typically a two-column matrix: [,1] = m/z, [,2] = intensity</span></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="fu">is.matrix</span>(pk) <span class="sc">||</span> <span class="fu">is.data.frame</span>(pk)) <span class="sc">||</span> <span class="fu">ncol</span>(pk) <span class="sc">&lt;</span> <span class="dv">2</span>) <span class="fu">stop</span>(<span class="st">"Unexpected peak-list format; expected 2-column matrix/data.frame."</span>)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>mzvals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pk[, <span class="dv">1</span>])</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>intvals <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(pk[, <span class="dv">2</span>])</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a>ok <span class="ot">&lt;-</span> <span class="sc">!</span>(<span class="fu">is.na</span>(mzvals) <span class="sc">|</span> <span class="fu">is.na</span>(intvals) <span class="sc">|</span> <span class="fu">is.infinite</span>(mzvals) <span class="sc">|</span> <span class="fu">is.infinite</span>(intvals))</span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>mzvals <span class="ot">&lt;-</span> mzvals[ok]; intvals <span class="ot">&lt;-</span> intvals[ok]</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(mzvals) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No valid m/z or intensity values to plot after filtering."</span>)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --- prepare data.frame for ggplot2 ---</span></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">mz =</span> mzvals, <span class="at">intensity =</span> intvals)</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional: scale intensity to relative height (0-100) or keep absolute</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>int_rel <span class="ot">&lt;-</span> df<span class="sc">$</span>intensity <span class="sc">/</span> <span class="fu">max</span>(df<span class="sc">$</span>intensity, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a><span class="co"># --- ggplot2 stick plot using geom_segment ---</span></span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> mz, <span class="at">xend =</span> mz, <span class="at">y =</span> <span class="dv">0</span>, <span class="at">yend =</span> intensity)) <span class="sc">+</span></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Spectrum 1 —"</span>, <span class="fu">basename</span>(chosen_file)),</span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"m/z"</span>, <span class="at">y =</span> <span class="st">"Intensity"</span>) <span class="sc">+</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If you prefer relative intensities (0-100) use yend = int_rel and y = 0</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="co"># p &lt;- ggplot(df, aes(x = mz, xend = mz, y = 0, yend = int_rel)) + ...</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print or save</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-data-visualization-bis_files/figure-html/plot-spectrum-ggplot2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To save: ggsave("spectrum1_ggplot.png", p, width = 10, height = 6, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualizing-chromatographic-data-tic-bpc-xic" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-chromatographic-data-tic-bpc-xic">Visualizing Chromatographic Data (TIC, BPC, XIC)</h3>
<p>Plotting chromatograms is arguably the most critical <em>first step</em> for quality control in any LC-MS experiment. These plots of intensity versus retention time reveal injection quality, gradient performance, signal stability, and the overall similarity (or dissimilarity) between runs.[41, 42] The <code>chromatogram()</code> function, available in both <code>MSnbase</code> and <code>xcms</code>, is the unified interface for generating this data.[20, 23, 43]</p>
<section id="total-ion-chromatogram-tic" class="level4">
<h4 class="anchored" data-anchor-id="total-ion-chromatogram-tic">Total Ion Chromatogram (TIC)</h4>
<p>The TIC plots the sum of all ion intensities in every spectrum against retention time. It is used to assess overall signal stability and to compare the total ion current injected between different runs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Install if needed: BiocManager::install("MSnbase")</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MSnbase)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># load file(s) -- adjust to your file(s)</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"MSnbase"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>             <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>chosen <span class="ot">&lt;-</span> files[<span class="dv">1</span>]</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># read all MS levels (onDisk recommended for large files)</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>ms <span class="ot">&lt;-</span> <span class="fu">readMSData</span>(<span class="at">files =</span> chosen, <span class="at">mode =</span> <span class="st">"onDisk"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co"># compute TIC per spectrum (returns numeric vector)</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>tic_vals <span class="ot">&lt;-</span> <span class="fu">tic</span>(ms)            <span class="co"># total ion current for each spectrum</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>rt_vals  <span class="ot">&lt;-</span> <span class="fu">rtime</span>(ms) <span class="sc">/</span> <span class="dv">60</span>     <span class="co"># retention time in minutes</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># assemble data.frame</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>tic_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">rt_min =</span> rt_vals, <span class="at">tic =</span> tic_vals)</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Base plot</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tic_df<span class="sc">$</span>rt_min, tic_df<span class="sc">$</span>tic, <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"Retention time (min)"</span>, <span class="at">ylab =</span> <span class="st">"TIC"</span>,</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"TIC —"</span>, <span class="fu">basename</span>(chosen)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="06-data-visualization-bis_files/figure-html/plot-tic-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot2 (optional)</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># library(ggplot2)</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ggplot(tic_df, aes(x = rt_min, y = tic)) + geom_line() + labs(x="RT (min)", y="TIC")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="base-peak-chromatogram-bpc" class="level4">
<h4 class="anchored" data-anchor-id="base-peak-chromatogram-bpc">Base Peak Chromatogram (BPC)</h4>
<p>The BPC plots the intensity of only the <em>most intense</em> peak in every spectrum against retention time. This plot is often “cleaner” than the TIC, as it is less susceptible to baseline noise, and is excellent for visually assessing the alignment of major chromatographic peaks between runs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># BPC (Base Peak Chromatogram) plotting script</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Requires: MSnbase (preferred) and/or mzR; ggplot2 for plotting</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"ggplot2"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"MSnbase"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>  BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"MSnbase"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"mzR"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"BiocManager"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">install.packages</span>(<span class="st">"BiocManager"</span>)</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>  BiocManager<span class="sc">::</span><span class="fu">install</span>(<span class="st">"mzR"</span>)</span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MSnbase)</span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mzR)</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Set your file path here (or use example files from MSnbase)</span></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Replace with your file: myfile &lt;- "path/to/yourfile.mzML"</span></span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>files_example <span class="ot">&lt;-</span> <span class="fu">dir</span>(<span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">"MSnbase"</span>, <span class="at">dir =</span> <span class="st">"extdata"</span>),</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a>                     <span class="at">full.names =</span> <span class="cn">TRUE</span>, <span class="at">pattern =</span> <span class="st">"mzXML$|mzML$"</span>)</span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(files_example) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No example mzXML/mzML files found; set 'myfile' to your data file."</span>)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a>myfile <span class="ot">&lt;-</span> files_example[<span class="dv">1</span>]</span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Attempt MSnbase approach first (fast for on-disk objects)</span></span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>bpc_df <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>({</span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>  ms <span class="ot">&lt;-</span> <span class="fu">readMSData</span>(<span class="at">files =</span> myfile, <span class="at">mode =</span> <span class="st">"onDisk"</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>)</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prefer MS1 spectra for chromatograms when available</span></span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">any</span>(<span class="fu">msLevel</span>(ms) <span class="sc">==</span> <span class="dv">1</span>)) ms <span class="ot">&lt;-</span> ms[<span class="fu">msLevel</span>(ms) <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a>  bpi_vals <span class="ot">&lt;-</span> <span class="fu">bpi</span>(ms)                  <span class="co"># base peak intensity per spectrum</span></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>  rt_vals  <span class="ot">&lt;-</span> <span class="fu">rtime</span>(ms) <span class="sc">/</span> <span class="dv">60</span>           <span class="co"># retention time in minutes</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>  bpc_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">rt_min =</span> rt_vals, <span class="at">bpi =</span> bpi_vals)</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>}, <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Fallback to mzR if MSnbase approach failed or returned no data</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(bpc_df) <span class="sc">||</span> <span class="fu">nrow</span>(bpc_df) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"MSnbase path failed or returned no MS1 spectra — using mzR fallback."</span>)</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a>  msobj <span class="ot">&lt;-</span> <span class="fu">openMSfile</span>(myfile)</span>
<span id="cb54-39"><a href="#cb54-39" aria-hidden="true" tabindex="-1"></a>  hdr <span class="ot">&lt;-</span> <span class="fu">header</span>(msobj)</span>
<span id="cb54-40"><a href="#cb54-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Restrict to MS1 if header has msLevel</span></span>
<span id="cb54-41"><a href="#cb54-41" aria-hidden="true" tabindex="-1"></a>  idx <span class="ot">&lt;-</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(hdr))</span>
<span id="cb54-42"><a href="#cb54-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="st">"msLevel"</span> <span class="sc">%in%</span> <span class="fu">colnames</span>(hdr)) idx <span class="ot">&lt;-</span> idx[hdr<span class="sc">$</span>msLevel <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb54-43"><a href="#cb54-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(idx) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No MS1 spectra found in file."</span>)</span>
<span id="cb54-44"><a href="#cb54-44" aria-hidden="true" tabindex="-1"></a>  bpi_vals <span class="ot">&lt;-</span> <span class="fu">vapply</span>(idx, <span class="cf">function</span>(i) {</span>
<span id="cb54-45"><a href="#cb54-45" aria-hidden="true" tabindex="-1"></a>    pk <span class="ot">&lt;-</span> <span class="fu">peaks</span>(msobj, i)</span>
<span id="cb54-46"><a href="#cb54-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(pk) <span class="sc">||</span> <span class="fu">nrow</span>(pk) <span class="sc">==</span> <span class="dv">0</span>) <span class="dv">0</span> <span class="cf">else</span> <span class="fu">max</span>(pk[,<span class="dv">2</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb54-47"><a href="#cb54-47" aria-hidden="true" tabindex="-1"></a>  }, <span class="fu">numeric</span>(<span class="dv">1</span>))</span>
<span id="cb54-48"><a href="#cb54-48" aria-hidden="true" tabindex="-1"></a>  rt_vals <span class="ot">&lt;-</span> hdr<span class="sc">$</span>retentionTime[idx] <span class="sc">/</span> <span class="dv">60</span></span>
<span id="cb54-49"><a href="#cb54-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">close</span>(msobj)</span>
<span id="cb54-50"><a href="#cb54-50" aria-hidden="true" tabindex="-1"></a>  bpc_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">rt_min =</span> rt_vals, <span class="at">bpi =</span> bpi_vals)</span>
<span id="cb54-51"><a href="#cb54-51" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb54-52"><a href="#cb54-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Basic checks</span></span>
<span id="cb54-54"><a href="#cb54-54" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(bpc_df) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"No chromatogram data to plot after extraction."</span>)</span>
<span id="cb54-55"><a href="#cb54-55" aria-hidden="true" tabindex="-1"></a>bpc_df <span class="ot">&lt;-</span> bpc_df[<span class="fu">order</span>(bpc_df<span class="sc">$</span>rt_min), ]</span>
<span id="cb54-56"><a href="#cb54-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-57"><a href="#cb54-57" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Optional smoothing (uncomment if desired)</span></span>
<span id="cb54-58"><a href="#cb54-58" aria-hidden="true" tabindex="-1"></a><span class="co"># sm &lt;- loess(bpi ~ rt_min, data = bpc_df, span = 0.1)</span></span>
<span id="cb54-59"><a href="#cb54-59" aria-hidden="true" tabindex="-1"></a><span class="co"># bpc_df$bpi_smooth &lt;- predict(sm)</span></span>
<span id="cb54-60"><a href="#cb54-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-61"><a href="#cb54-61" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Plot with ggplot2</span></span>
<span id="cb54-62"><a href="#cb54-62" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(bpc_df, <span class="fu">aes</span>(<span class="at">x =</span> rt_min, <span class="at">y =</span> bpi)) <span class="sc">+</span></span>
<span id="cb54-63"><a href="#cb54-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">color =</span> <span class="st">"black"</span>, <span class="at">size =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb54-64"><a href="#cb54-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">#geom_line(aes(y = bpi_smooth), color = "red", size = 0.6) + # if smoothing used</span></span>
<span id="cb54-65"><a href="#cb54-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste</span>(<span class="st">"Base Peak Chromatogram (BPC) —"</span>, <span class="fu">basename</span>(myfile)),</span>
<span id="cb54-66"><a href="#cb54-66" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Retention time (min)"</span>, <span class="at">y =</span> <span class="st">"Base peak intensity"</span>) <span class="sc">+</span></span>
<span id="cb54-67"><a href="#cb54-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>)</span>
<span id="cb54-68"><a href="#cb54-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-69"><a href="#cb54-69" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p)</span>
<span id="cb54-70"><a href="#cb54-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-71"><a href="#cb54-71" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Save to file (optional)</span></span>
<span id="cb54-72"><a href="#cb54-72" aria-hidden="true" tabindex="-1"></a><span class="co"># ggsave("BPC_plot.png", p, width = 10, height = 4.5, dpi = 300)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="extracted-ion-chromatogram-xic" class="level4">
<h4 class="anchored" data-anchor-id="extracted-ion-chromatogram-xic">Extracted Ion Chromatogram (XIC)</h4>
<p>Unlike the TIC and BPC, the XIC is a <em>targeted</em> visualization. It plots the intensity of ions within a very specific <span class="math inline">\(m/z\)</span> range against retention time. This is used to inspect the chromatographic peak shape for a specific metabolite or peptide of interest, and is a fundamental tool for validating quantitative results.[20, 22, 44]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the 'raw_data' object from the TIC example</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We will extract an XIC for a known ion</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="co"># m/z range for serine [M+H]+</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>serine_mz <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">106.04</span>, <span class="fl">106.06</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Retention time range where serine is expected</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>serine_rt <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">175</span>, <span class="dv">190</span>)</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Filter the raw data object to this specific region</span></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>raw_serine <span class="ot">&lt;-</span> <span class="fu">filterRt</span>(raw_data, <span class="at">rt =</span> serine_rt)</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>raw_serine <span class="ot">&lt;-</span> <span class="fu">filterMz</span>(raw_serine, <span class="at">mz =</span> serine_mz)</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Plot the object with type = "XIC"</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(raw_serine, <span class="at">type =</span> <span class="st">"XIC"</span>, </span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> group_colors[raw_serine<span class="sc">$</span>sample_group],</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"XIC for Serine (m/z 106.04-106.06)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
</section>
<section id="iii.-visualizing-identifications-tandem-ms-msms-and-peptide-mapping" class="level1">
<h1>III. Visualizing Identifications: Tandem MS (MS/MS) and Peptide Mapping</h1>
<p>After processing raw data, the next step is identification. For proteomics, this involves matching MS/MS (or <span class="math inline">\(MS^n\)</span>) spectra to peptide sequences from a database (a Peptide-Spectrum Match, or PSM). Visualizations in this category are essential for validating these identifications and placing them in a biological context.</p>
<section id="annotating-msms-spectra-for-psm-validation" class="level3">
<h3 class="anchored" data-anchor-id="annotating-msms-spectra-for-psm-validation">Annotating MS/MS Spectra for PSM Validation</h3>
<p>After a search engine generates a PSM, the gold standard for validation is to visually inspect the MS/MS spectrum. A high-quality match will show clear peaks corresponding to the theoretical fragment ions (primarily b- and y-ions) for the matched peptide sequence. The <code>MSnbase</code> package provides a powerful and convenient <code>plot</code> method that automates this annotation.[45, 46]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load library</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MSnbase)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the itraqdata example dataset</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(itraqdata)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Process the data (centroiding) to make peaks clearer</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>itraqdata_peaks <span class="ot">&lt;-</span> <span class="fu">pickPeaks</span>(itraqdata)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Select a spectrum to plot (e.g., spectrum index 14)</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">14</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the identified peptide sequence for that spectrum</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co"># This sequence is stored in the featureData (fData)</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span> <span class="fu">as.character</span>(<span class="fu">fData</span>(itraqdata_peaks))</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the MS/MS spectrum (itraqdata_peaks[[i]]) against the sequence (s)</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(itraqdata_peaks[[i]], </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>     s, </span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Annotated MS/MS Spectrum for:"</span>, s))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This command plots the <code>Spectrum2</code> object and, because a character string (the peptide sequence) was provided as the second argument, it automatically calculates the theoretical <span class="math inline">\(m/z\)</span> values for fragment ions and overlays them onto the spectrum, allowing for immediate visual validation of the PSM.</p>
</section>
<section id="comparative-spectral-visualization-the-mirror-plot" class="level3">
<h3 class="anchored" data-anchor-id="comparative-spectral-visualization-the-mirror-plot">Comparative Spectral Visualization: The Mirror Plot</h3>
<p>The mirror plot is the visual gold standard for comparing two MS/MS spectra, such as an experimental spectrum against a reference spectrum from a database or spectral library.[47, 48] This is a cornerstone of confident metabolite identification and PSM validation.[49] The top spectrum is plotted with positive intensity, and the bottom spectrum is plotted with negative intensity, allowing their <span class="math inline">\(m/z\)</span> axes to be perfectly aligned for comparison.</p>
<section id="method-1-modern-using-spectraplotspectramirror" class="level4">
<h4 class="anchored" data-anchor-id="method-1-modern-using-spectraplotspectramirror">Method 1 (Modern): Using <code>Spectra::plotSpectraMirror()</code></h4>
<p>The <code>Spectra</code> package provides a built-in, highly-configurable function for this exact purpose.[50] It can automatically identify and highlight matching peaks between the two spectra within a given <span class="math inline">\(m/z\)</span> tolerance.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load library</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Spectra)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(DataFrame) <span class="co"># Part of S4Vectors, loaded with Spectra</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create a dummy Spectra object with two similar spectra ---</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>ints <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="fl">4.3</span>, <span class="dv">12</span>, <span class="dv">8</span>, <span class="dv">34</span>, <span class="fl">23.4</span>), <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">25</span>, <span class="dv">16</span>, <span class="dv">32</span>, <span class="fl">23.5</span>)) </span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>mzs <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="fl">13.45</span>, <span class="fl">43.43</span>, <span class="fl">46.66</span>, <span class="fl">129.11</span>, <span class="fl">322.24</span>), </span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">c</span>(<span class="fl">13.45</span>, <span class="fl">43.51</span>, <span class="fl">129.11</span>, <span class="fl">322.25</span>, <span class="fl">400.1</span>)) </span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">DataFrame</span>(<span class="at">msLevel =</span> <span class="fu">c</span>(<span class="dv">2</span>L, <span class="dv">2</span>L), <span class="at">rtime =</span> <span class="fu">c</span>(<span class="fl">123.12</span>, <span class="dv">124</span>)) </span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>mz <span class="ot">&lt;-</span> mzs </span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>df<span class="sc">$</span>intensity <span class="ot">&lt;-</span> ints </span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>sp <span class="ot">&lt;-</span> <span class="fu">Spectra</span>(df)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co"># --- End of dummy data creation ---</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the mirror plot, comparing spectrum 1 vs. spectrum 2</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plotSpectraMirror</span>(</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>  sp, </span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  sp,</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Spectral Mirror Plot"</span>,</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Parameters to match and color shared peaks</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">tolerance =</span> <span class="fl">0.01</span>,      <span class="co"># m/z tolerance to define a "match"</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">ppm =</span> <span class="dv">0</span>,             <span class="co"># Use absolute tolerance</span></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">matchCol =</span> <span class="st">"red"</span>,  <span class="co"># Color for matching peaks</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">matchLwd =</span> <span class="dv">2</span>,        <span class="co"># Line width for matching peaks</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">matchPch =</span> <span class="dv">16</span>        <span class="co"># Point character for matching peaks</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>() <span class="co"># Add a grid for easier comparison</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="method-2-publication-ready-custom-ggplot2-mirror-plot" class="level4">
<h4 class="anchored" data-anchor-id="method-2-publication-ready-custom-ggplot2-mirror-plot">Method 2 (Publication-Ready): Custom <code>ggplot2</code> Mirror Plot</h4>
<p>For full control over every visual element, a mirror plot can be built using <code>ggplot2</code>. The core logic involves binding the data from two spectra into a single data frame, inverting the intensity of the second spectrum, and using <code>geom_segment</code> for the stick plot. This approach requires several packages from the <code>tidyverse</code> ecosystem.[48]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the 'sp' object from the previous example</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Get data for spectrum 1</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>spec1 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">peaksData</span>(sp))</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(spec1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mz"</span>, <span class="st">"intensity"</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>spec1<span class="sc">$</span>spectrum <span class="ot">&lt;-</span> <span class="st">"Experimental"</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Get data for spectrum 2 and invert intensity</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>spec2 <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">peaksData</span>(sp))</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(spec2) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"mz"</span>, <span class="st">"intensity"</span>)</span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>spec2<span class="sc">$</span>intensity <span class="ot">&lt;-</span> <span class="sc">-</span>spec2<span class="sc">$</span>intensity <span class="co"># The key step for the mirror plot</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>spec2<span class="sc">$</span>spectrum <span class="ot">&lt;-</span> <span class="st">"Reference"</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into one data frame</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>mirror_data <span class="ot">&lt;-</span> <span class="fu">rbind</span>(spec1, spec2)</span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(mirror_data, <span class="fu">aes</span>(<span class="at">x =</span> mz, <span class="at">y =</span> intensity, <span class="at">color =</span> spectrum)) <span class="sc">+</span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw segments from the baseline (y=0) to the intensity</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> mz, <span class="at">yend =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add a horizontal line at y=0</span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use ggrepel to label some peaks without overlap</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>  ggrepel<span class="sc">::</span><span class="fu">geom_text_repel</span>(</span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">subset</span>(mirror_data, <span class="fu">abs</span>(intensity) <span class="sc">&gt;</span> <span class="dv">10</span>),</span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(mz, <span class="dv">2</span>)),</span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>, <span class="at">vjust =</span> <span class="sc">-</span><span class="fl">0.5</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Clean up labels and theme</span></span>
<span id="cb58-36"><a href="#cb58-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"m/z"</span>, <span class="at">y =</span> <span class="st">"Intensity"</span>, </span>
<span id="cb58-37"><a href="#cb58-37" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Custom ggplot2 Mirror Plot"</span>) <span class="sc">+</span></span>
<span id="cb58-38"><a href="#cb58-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">labels =</span> <span class="cf">function</span>(x) <span class="fu">abs</span>(x)) <span class="sc">+</span> <span class="co"># Show absolute intensity</span></span>
<span id="cb58-39"><a href="#cb58-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb58-40"><a href="#cb58-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="visualizing-peptide-coverage-on-protein-sequences" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-peptide-coverage-on-protein-sequences">Visualizing Peptide Coverage on Protein Sequences</h3>
<p>A common biological question is: “Where on the protein sequence are my identified peptides located?” This is critical for studying protein domains, post-translational modifications (PTMs), splice isoforms, and immunogenicity.[28, 29] The <code>PepMapViz</code> package (available on CRAN) is an excellent tool for this, creating detailed, multi-layered “peptide maps”.[29, 30, 51]</p>
<p>The example below, based on the <code>PepMapViz</code> vignette, demonstrates how to plot peptide coverage for multiple samples (Donors) across different protein chains, all while annotating protein domains (e.g., VH, CH1) and PTMs.[28, 52]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(PepMapViz)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Create Example Peptide Data ---</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This simulates a typical search engine output</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>data_with_psm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Peptide =</span> <span class="fu">c</span>(<span class="st">"PEPTIDEONE"</span>, <span class="st">"PEPTIDETWO"</span>, <span class="st">"PEPTIDETHREE"</span>, <span class="st">"DIFFERENTPEPTIDE"</span>),</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Start =</span> <span class="fu">c</span>(<span class="dv">20</span>, <span class="dv">50</span>, <span class="dv">130</span>, <span class="dv">20</span>),</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">End =</span> <span class="fu">c</span>(<span class="dv">29</span>, <span class="dv">59</span>, <span class="dv">141</span>, <span class="dv">36</span>),</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">Donor =</span> <span class="fu">c</span>(<span class="st">"D1"</span>, <span class="st">"D1"</span>, <span class="st">"D1"</span>, <span class="st">"D2"</span>), <span class="co"># Sample information</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">Chain =</span> <span class="fu">c</span>(<span class="st">"HC"</span>, <span class="st">"HC"</span>, <span class="st">"HC"</span>, <span class="st">"HC"</span>), <span class="co"># Protein information</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">Character =</span> <span class="fu">strsplit</span>(</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"EVQLVESGGGLVQPGGSLRLSCAASGFTFSSYAMSWVRQAPGKGLEWVSAISGSGGSTYYADSVKGRFTISRDNSKNTLYLQMNSLRAEDTAVYYCAKVSYLSTASSLDYWGQGTLVTVSSASTKGPSVFPLAPSSKSTSGGTAALGCLVKDYFPEPVTVSWNSGALTSGVHTFPAVLQSSGLYSLSSVVTVPSSSLGTQTYICNVNHKPSNTKVDKKVEPKSC"</span>, </span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">""</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>  )[<span class="dv">1</span><span class="sc">:</span><span class="dv">150</span>], <span class="co"># Dummy sequence letters</span></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">Position =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">150</span>,</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">PTM_type =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="st">"Ox"</span>, <span class="cn">NA</span>, <span class="st">"Deamid"</span>, <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">146</span>)), <span class="co"># PTM info</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">PSM =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">8</span>, <span class="dv">12</span>, <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="dv">146</span>)) <span class="co"># Quantitative info</span></span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Define Domain Data Frame ---</span></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="co"># This specifies the regions of the protein</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a>domain <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_type =</span> <span class="fu">c</span>(<span class="st">"VH"</span>, <span class="st">"CH1"</span>, <span class="st">"CDR H1"</span>, <span class="st">"CDR H2"</span>),</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">Chain =</span> <span class="fu">c</span>(<span class="st">"HC"</span>, <span class="st">"HC"</span>, <span class="st">"HC"</span>, <span class="st">"HC"</span>),</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_start =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">119</span>, <span class="dv">26</span>, <span class="dv">50</span>),</span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_end =</span> <span class="fu">c</span>(<span class="dv">118</span>, <span class="dv">150</span>, <span class="dv">35</span>, <span class="dv">66</span>),</span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_color =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"black"</span>, <span class="st">"#F8766D"</span>, <span class="st">"#B79F00"</span>),</span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_fill_color =</span> <span class="fu">c</span>(<span class="st">"white"</span>, <span class="st">"white"</span>, <span class="st">"yellow"</span>, <span class="st">"yellow"</span>),</span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_label_y =</span> <span class="fu">c</span>(<span class="fl">1.7</span>, <span class="fl">1.7</span>, <span class="fl">1.4</span>, <span class="fl">1.4</span>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Define Plot Variables and Colors ---</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a>x_axis_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Chain"</span>)</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a>y_axis_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Donor"</span>)</span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a>column_order <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">Donor =</span> <span class="st">"D1,D2"</span>, <span class="at">Chain =</span> <span class="st">"HC"</span>)</span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a>PTM_color <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Ox"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Deamid"</span> <span class="ot">=</span> <span class="st">"cyan"</span>)</span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Call the create_peptide_plot function ---</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a>p_psm <span class="ot">&lt;-</span> <span class="fu">create_peptide_plot</span>(</span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a>  data_with_psm,</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_axis_vars =</span> y_axis_vars,</span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_axis_vars =</span> x_axis_vars,</span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_expand =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.2</span>),</span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">theme_options =</span> <span class="fu">list</span>(<span class="at">legend.position =</span> <span class="st">"bottom"</span>),</span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">labs_options =</span> <span class="fu">list</span>(<span class="at">title =</span> <span class="st">"Peptide Coverage Map"</span>, <span class="at">x =</span> <span class="st">"Position"</span>),</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">color_fill_column =</span> <span class="st">'PSM'</span>,</span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_domain =</span> <span class="cn">TRUE</span>,</span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain =</span> domain,</span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_start_column =</span> <span class="st">"domain_start"</span>,</span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_end_column =</span> <span class="st">"domain_end"</span>,</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_type_column =</span> <span class="st">"domain_type"</span>,</span>
<span id="cb59-54"><a href="#cb59-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_border_color_column =</span> <span class="st">"domain_color"</span>,</span>
<span id="cb59-55"><a href="#cb59-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_fill_color_column =</span> <span class="st">"domain_fill_color"</span>,</span>
<span id="cb59-56"><a href="#cb59-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_domain_label =</span> <span class="cn">TRUE</span>,</span>
<span id="cb59-57"><a href="#cb59-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_label_size =</span> <span class="dv">3</span>,</span>
<span id="cb59-58"><a href="#cb59-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">domain_label_y_column =</span> <span class="st">"domain_label_y"</span>,</span>
<span id="cb59-59"><a href="#cb59-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">PTM =</span> <span class="cn">TRUE</span>, <span class="co"># Enable PTM plotting</span></span>
<span id="cb59-60"><a href="#cb59-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">PTM_type_column =</span> <span class="st">"PTM_type"</span>,</span>
<span id="cb59-61"><a href="#cb59-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">PTM_color =</span> PTM_color,</span>
<span id="cb59-62"><a href="#cb59-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_label =</span> <span class="cn">TRUE</span>, <span class="co"># Add sequence labels</span></span>
<span id="cb59-63"><a href="#cb59-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_column =</span> <span class="st">"Character"</span>,</span>
<span id="cb59-64"><a href="#cb59-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_filter =</span> <span class="fu">list</span>(<span class="at">Donor =</span> <span class="st">"D1"</span>), <span class="co"># Only label sequence for D1</span></span>
<span id="cb59-65"><a href="#cb59-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">label_y =</span> <span class="dv">1</span>,</span>
<span id="cb59-66"><a href="#cb59-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">column_order =</span> column_order</span>
<span id="cb59-67"><a href="#cb59-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb59-68"><a href="#cb59-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-69"><a href="#cb59-69" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p_psm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="high-level-statistical-visualization-for-quantitative-omics" class="level2">
<h2 class="anchored" data-anchor-id="high-level-statistical-visualization-for-quantitative-omics">High-Level Statistical Visualization for Quantitative ’Omics</h2>
<p>After raw data is processed, peaks are detected, and features (peptides or metabolites) are quantified, the result is a quantitative matrix (features <span class="math inline">\(\times\)</span> samples). The next-level visualizations are statistical, designed to reveal biological patterns, identify outliers, and discover differentially abundant features.</p>
</section>
<section id="a.-visualizing-sample-clustering-and-relationships-dimensionality-reduction" class="level2">
<h2 class="anchored" data-anchor-id="a.-visualizing-sample-clustering-and-relationships-dimensionality-reduction">A. Visualizing Sample Clustering and Relationships: Dimensionality Reduction</h2>
<p>The first step in any statistical analysis of ’omics data is <em>always</em> to visualize the relationships <em>between samples</em>. This is an essential quality control step to detect batch effects, identify sample outliers, and get a first look at whether the biological groups (e.g., “control” vs.&nbsp;“treated”) are separating as expected.</p>
<section id="method-1-linear-principal-component-analysis-pca" class="level4">
<h4 class="anchored" data-anchor-id="method-1-linear-principal-component-analysis-pca">Method 1 (Linear): Principal Component Analysis (PCA)</h4>
<p>PCA is a linear dimensionality reduction technique that summarizes the largest sources of variance in the data into a few “principal components” (PCs).[53, 54] Plotting PC1 vs.&nbsp;PC2 shows the dominant structure in the data. While base R’s <code>prcomp</code> function can be used [53], the Bioconductor package <code>ropls</code> is purpose-built for ’omics data, which is often characterized by high multicollinearity and more variables than samples.[24, 25, 26, 55, 56]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the ropls package</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ropls)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the 'sacurine' metabolomics example dataset</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="co"># This dataset includes a dataMatrix (features) and sampleMetadata</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(sacurine)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA on the dataMatrix</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a><span class="co"># The 'opls' function is used for PCA, PLS-DA, and OPLS-DA</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>sacurine.pca <span class="ot">&lt;-</span> <span class="fu">opls</span>(sacurine<span class="sc">$</span>dataMatrix)</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the 'gender' variable from the metadata for coloring</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>genderFc <span class="ot">&lt;-</span> sacurine<span class="sc">$</span>sampleMetadata[, <span class="st">"gender"</span>]</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate the PCA "x-score" plot</span></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 'parAsColFcVn' colors the points based on the provided factor</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(sacurine.pca,</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">typeVc =</span> <span class="st">"x-score"</span>,       <span class="co"># Specify a scores plot</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">parAsColFcVn =</span> genderFc,  <span class="co"># Color by gender</span></span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">main =</span> <span class="st">"PCA Scores Plot of Sacurine Metabolomics Data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="method-2-non-linear-t-distributed-stochastic-neighbor-embedding-t-sne" class="level4">
<h4 class="anchored" data-anchor-id="method-2-non-linear-t-distributed-stochastic-neighbor-embedding-t-sne">Method 2 (Non-linear): t-Distributed Stochastic Neighbor Embedding (t-SNE)</h4>
<p>t-SNE is a popular <em>non-linear</em> dimensionality reduction algorithm.[33] Unlike PCA, which aims to preserve global variance, t-SNE focuses on preserving the <em>local</em> neighborhood structure of data points.[57] This makes it extremely powerful for visualizing complex, non-linear clusters, and it is a standard in fields like single-cell ’omics and mass cytometry.[33, 58, 59] The standard R implementation is the <code>Rtsne</code> package.[32, 34]</p>
<p>A critical caveat: t-SNE plots can be easily misread. The size of clusters, and the distance <em>between</em> clusters, are not directly interpretable or meaningful.[32, 60] Its sole purpose is to visualize the <em>groupings</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rtsne)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the classic 'iris' dataset for demonstration</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove duplicate data points, as Rtsne requires unique rows</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>iris_unique <span class="ot">&lt;-</span> iris[<span class="sc">!</span><span class="fu">duplicated</span>(iris[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>]),]</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>iris_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(iris_unique[,<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>])</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the species labels for coloring</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>iris_labels <span class="ot">&lt;-</span> iris_unique<span class="sc">$</span>Species</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Run the Rtsne algorithm</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>) <span class="co"># t-SNE is stochastic, set seed for reproducibility</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a>tsne_out <span class="ot">&lt;-</span> <span class="fu">Rtsne</span>(iris_matrix, </span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a>                  <span class="at">dims =</span> <span class="dv">2</span>, </span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a>                  <span class="at">perplexity =</span> <span class="dv">25</span>, </span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a>                  <span class="at">verbose =</span> <span class="cn">TRUE</span>, </span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a>                  <span class="at">max_iter =</span> <span class="dv">1500</span>)</span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Create a "plottable" data frame from the results</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a>tsne_plot_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">X =</span> tsne_out<span class="sc">$</span>Y[,<span class="dv">1</span>],</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">Y =</span> tsne_out<span class="sc">$</span>Y[,<span class="dv">2</span>],</span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">Label =</span> iris_labels</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Plot the 2D embedding using ggplot2</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(tsne_plot_df, <span class="fu">aes</span>(<span class="at">x =</span> X, <span class="at">y =</span> Y, <span class="at">color =</span> Label)) <span class="sc">+</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"t-SNE 2D Embedding of Iris Dataset"</span>,</span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"t-SNE Dimension 1"</span>,</span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"t-SNE Dimension 2"</span>) <span class="sc">+</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-feature-trends-the-heatmap" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-feature-trends-the-heatmap">Visualizing Feature Trends: The Heatmap</h3>
<p>The heatmap is the definitive visualization for showing the global behavior of <em>all features</em> across <em>all samples</em> simultaneously.[61, 62] When combined with hierarchical clustering (which produces the dendrograms), it reveals which groups of features (e.g., proteins) show similar expression patterns, and which groups of samples have similar feature profiles.[61] The <code>pheatmap</code> package is a popular and powerful tool for creating publication-ready, annotated heatmaps.[31, 63, 64]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pheatmap)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Create Example Data Matrix ---</span></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 50 features (genes/proteins) x 20 samples</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>data_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">1000</span>), <span class="dv">50</span>, <span class="dv">20</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data_matrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Sample"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(data_matrix) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Protein"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce a biological signal:</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Make proteins 1-20 higher in samples 1-10 (Group A)</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>data_matrix[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">&lt;-</span> data_matrix[<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>] <span class="sc">+</span> <span class="dv">3</span></span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Make proteins 21-40 higher in samples 11-20 (Group B)</span></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>data_matrix[<span class="dv">21</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">11</span><span class="sc">:</span><span class="dv">20</span>] <span class="ot">&lt;-</span> data_matrix[<span class="dv">21</span><span class="sc">:</span><span class="dv">40</span>, <span class="dv">11</span><span class="sc">:</span><span class="dv">20</span>] <span class="sc">+</span> <span class="dv">3</span></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Create Sample Annotation Data Frame ---</span></span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a><span class="co"># This data frame tells pheatmap how to group the columns</span></span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>annotation_col <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">Group =</span> <span class="fu">factor</span>(<span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Group_A"</span>, <span class="st">"Group_B"</span>), <span class="at">each =</span> <span class="dv">10</span>))</span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(annotation_col) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(data_matrix)</span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 3. Define Colors for Annotations ---</span></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="co"># This list maps annotation values to specific colors</span></span>
<span id="cb62-27"><a href="#cb62-27" aria-hidden="true" tabindex="-1"></a>annotation_colors <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb62-28"><a href="#cb62-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">Group =</span> <span class="fu">c</span>(<span class="at">Group_A =</span> <span class="st">"navy"</span>, <span class="at">Group_B =</span> <span class="st">"darkorange"</span>)</span>
<span id="cb62-29"><a href="#cb62-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb62-30"><a href="#cb62-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-31"><a href="#cb62-31" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 4. Create the Heatmap ---</span></span>
<span id="cb62-32"><a href="#cb62-32" aria-hidden="true" tabindex="-1"></a><span class="fu">pheatmap</span>(</span>
<span id="cb62-33"><a href="#cb62-33" aria-hidden="true" tabindex="-1"></a>  data_matrix,</span>
<span id="cb62-34"><a href="#cb62-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Heatmap of Protein Abundance"</span>,</span>
<span id="cb62-35"><a href="#cb62-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-36"><a href="#cb62-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># --- Key Parameters ---</span></span>
<span id="cb62-37"><a href="#cb62-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 'scale = "row"' is essential for 'omics: </span></span>
<span id="cb62-38"><a href="#cb62-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># It converts values to Z-scores (mean 0, SD 1) for each row</span></span>
<span id="cb62-39"><a href="#cb62-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="st">"row"</span>,</span>
<span id="cb62-40"><a href="#cb62-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-41"><a href="#cb62-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add the column annotation bar</span></span>
<span id="cb62-42"><a href="#cb62-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">annotation_col =</span> annotation_col,</span>
<span id="cb62-43"><a href="#cb62-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">annotation_colors =</span> annotation_colors,</span>
<span id="cb62-44"><a href="#cb62-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-45"><a href="#cb62-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Control clustering</span></span>
<span id="cb62-46"><a href="#cb62-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_rows =</span> <span class="cn">TRUE</span>, <span class="co"># Cluster the proteins</span></span>
<span id="cb62-47"><a href="#cb62-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">cluster_cols =</span> <span class="cn">TRUE</span>, <span class="co"># Cluster the samples</span></span>
<span id="cb62-48"><a href="#cb62-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb62-49"><a href="#cb62-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Aesthetics</span></span>
<span id="cb62-50"><a href="#cb62-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_rownames =</span> <span class="cn">FALSE</span>, <span class="co"># Hide protein names (too many)</span></span>
<span id="cb62-51"><a href="#cb62-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">show_colnames =</span> <span class="cn">TRUE</span>, <span class="co"># Show sample names</span></span>
<span id="cb62-52"><a href="#cb62-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">border_color =</span> <span class="cn">NA</span>,    <span class="co"># Remove cell borders</span></span>
<span id="cb62-53"><a href="#cb62-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">color =</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"white"</span>, <span class="st">"red"</span>))(<span class="dv">100</span>) <span class="co"># Color scale</span></span>
<span id="cb62-54"><a href="#cb62-54" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualizing-differential-abundance-the-volcano-plot" class="level3">
<h3 class="anchored" data-anchor-id="visualizing-differential-abundance-the-volcano-plot">Visualizing Differential Abundance: The Volcano Plot</h3>
<p>The volcano plot is the cornerstone of differential expression analysis in all ’omics fields.[35, 65] It plots statistical significance (typically as <span class="math inline">\(-\log_{10}(p\text{-value})\)</span>) on the y-axis against biological magnitude (typically as <span class="math inline">\(\log_{2}(\text{fold change})\)</span>) on the x-axis. This immediately identifies features that are both statistically significant (high on the y-axis) and biologically meaningful (far left or right on the x-axis).[35]</p>
<section id="method-1-basic-using-ggplot2" class="level4">
<h4 class="anchored" data-anchor-id="method-1-basic-using-ggplot2">Method 1 (Basic): Using <code>ggplot2</code></h4>
<p>A simple volcano plot can be built with <code>ggplot2</code>’s <code>geom_point</code>, with lines for significance cutoffs added using <code>geom_hline</code> and <code>geom_vline</code>.[65]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load ggplot2</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Example Differential Expression (DE) Results ---</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>de_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">log2fc =</span> <span class="fu">rnorm</span>(<span class="dv">2000</span>, <span class="dv">0</span>, <span class="fl">1.5</span>),</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pval =</span> <span class="fu">runif</span>(<span class="dv">2000</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Add some "significant" hits</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>de_results[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="st">"log2fc"</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>de_results[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="st">"pval"</span>] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">50</span>, <span class="dv">0</span>, <span class="fl">0.01</span>)</span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>de_results[<span class="dv">51</span><span class="sc">:</span><span class="dv">100</span>, <span class="st">"log2fc"</span>] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">50</span>, <span class="sc">-</span><span class="dv">3</span>, <span class="dv">1</span>)</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>de_results[<span class="dv">51</span><span class="sc">:</span><span class="dv">100</span>, <span class="st">"pval"</span>] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">50</span>, <span class="dv">0</span>, <span class="fl">0.01</span>)</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>de_results<span class="sc">$</span>neg_log10_pval <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fu">log10</span>(de_results<span class="sc">$</span>pval)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="co"># --- End of example data ---</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using ggplot2</span></span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> de_results, <span class="fu">aes</span>(<span class="at">x =</span> log2fc, <span class="at">y =</span> neg_log10_pval)) <span class="sc">+</span></span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add cutoff lines</span></span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="fl">1.5</span>, <span class="fl">1.5</span>), <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">col =</span> <span class="st">"gray"</span>, <span class="at">linetype =</span> <span class="st">'dashed'</span>) <span class="sc">+</span></span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log2 Fold Change"</span>, <span class="at">y =</span> <span class="st">"-Log10 P-value"</span>, </span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Basic ggplot2 Volcano Plot"</span>) <span class="sc">+</span></span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="method-2-publication-ready-using-enhancedvolcano" class="level4">
<h4 class="anchored" data-anchor-id="method-2-publication-ready-using-enhancedvolcano">Method 2 (Publication-Ready): Using <code>EnhancedVolcano</code></h4>
<p>While the <code>ggplot2</code> approach works, it becomes tedious to color the significant points and, most importantly, to label the top hits without the labels overlapping and becoming unreadable. The Bioconductor package <code>EnhancedVolcano</code> is a superior, ’omics-aware solution that automates all of this.[27] It produces publication-ready, intelligently-labeled volcano plots with minimal effort.[27, 66, 67, 68, 69]</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the package</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(EnhancedVolcano)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the 'de_results' data frame from the previous example</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Add gene labels</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(de_results) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">"Protein"</span>, <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(de_results))</span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the plot</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="fu">EnhancedVolcano</span>(</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>  de_results,</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">lab =</span> <span class="fu">rownames</span>(de_results),</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="st">'log2fc'</span>,</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="st">'pval'</span>, <span class="co"># Note: It takes p-value, not -log10(p-value)</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set the cutoff lines</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">pCutoff =</span> <span class="fl">0.05</span>,</span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">FCcutoff =</span> <span class="fl">1.5</span>,</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot aesthetics</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">title =</span> <span class="st">'EnhancedVolcano Plot'</span>,</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">pointSize =</span> <span class="fl">3.0</span>,</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">labSize =</span> <span class="fl">4.0</span>,</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Set custom colors</span></span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">'grey30'</span>, <span class="st">'royalblue'</span>, <span class="st">'forestgreen'</span>, <span class="st">'red2'</span>),</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">colAlpha =</span> <span class="fl">0.8</span>,</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Draw connector lines to labels</span></span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">drawConnectors =</span> <span class="cn">TRUE</span>,</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">widthConnectors =</span> <span class="fl">0.5</span>,</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove gridlines</span></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">gridlines.major =</span> <span class="cn">FALSE</span>,</span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">gridlines.minor =</span> <span class="cn">FALSE</span></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="interactive-visualization-and-workflow-case-studies" class="level2">
<h2 class="anchored" data-anchor-id="interactive-visualization-and-workflow-case-studies">Interactive Visualization and Workflow Case Studies</h2>
<p>This final section synthesizes all previous concepts into practical, end-to-end workflows. It also demonstrates how to add a layer of modern interactivity to these static plots, transforming them from publication figures into powerful data exploration tools.</p>
</section>
<section id="a.-adding-interactivity-with-plotly" class="level2">
<h2 class="anchored" data-anchor-id="a.-adding-interactivity-with-plotly">A. Adding Interactivity with <code>plotly</code></h2>
<p>Interactivity is not a separate plot type, but an enhancement that can be applied to <code>ggplot2</code> objects. The <code>plotly</code> package provides the <code>ggplotly()</code> function, which can instantly convert a static <code>ggplot2</code> object into a fully interactive web graphic with zoom, pan, and hover-tooltip capabilities.[38, 39, 40, 70, 71] This is invaluable for exploring complex plots like volcano plots (to hover over a point and see the protein name) or PCA plots (to hover and see the sample ID).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(plotly)</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Using the 'de_results' data from section IV.C</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Create a static ggplot2 volcano plot ---</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Add a 'label' column for the hover text</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>de_results<span class="sc">$</span>Protein <span class="ot">&lt;-</span> <span class="fu">rownames</span>(de_results)</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a 'color_group' column for styling</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>de_results<span class="sc">$</span>color_group <span class="ot">&lt;-</span> <span class="st">"Not Significant"</span></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>de_results<span class="sc">$</span>color_group[</span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  de_results<span class="sc">$</span>pval <span class="sc">&lt;</span> <span class="fl">0.05</span> <span class="sc">&amp;</span> <span class="fu">abs</span>(de_results<span class="sc">$</span>log2fc) <span class="sc">&gt;</span> <span class="fl">1.5</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>] <span class="ot">&lt;-</span> <span class="st">"Significant"</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> de_results, </span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Map the 'Protein' label to the 'text' aesthetic for plotly</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> log2fc, <span class="at">y =</span> neg_log10_pval, </span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">text =</span> <span class="fu">paste</span>(<span class="st">"Protein:"</span>, Protein), </span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> color_group)) <span class="sc">+</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Not Significant"</span> <span class="ot">=</span> <span class="st">"grey"</span>, </span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>                                <span class="st">"Significant"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"Log2 Fold Change"</span>, <span class="at">y =</span> <span class="st">"-Log10 P-value"</span>, </span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Volcano Plot (Ready for Interactivity)"</span>) <span class="sc">+</span></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 2. Make it interactive with one command! ---</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplotly</span>(p)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="case-study-1-end-to-end-expression-proteomics-workflow" class="level3">
<h3 class="anchored" data-anchor-id="case-study-1-end-to-end-expression-proteomics-workflow">Case Study 1: End-to-End Expression Proteomics Workflow</h3>
<p>This case study synthesizes the visualizations into a complete Bioconductor workflow for expression proteomics, following the logical steps of data import, QC, statistical analysis, and interpretation.[19, 72, 73, 74, 75, 76]</p>
<ol type="1">
<li><strong>Data Import:</strong> The workflow begins by importing a PSM-level or peptide-level text file (e.g., from Proteome Discoverer or MaxQuant). This data is loaded into a <code>QFeatures</code> object, which efficiently manages the multiple data levels (assays).[19, 75]</li>
<li><strong>Pre-processing and QC:</strong> This stage involves filtering (e.g., removing contaminants), data transformation (e.g., <span class="math inline">\(\log_{2}\)</span>), and normalization. At this stage, <strong>Spectrum Plots</strong> (from Section II.A) can be used to inspect the quality of individual, high-confidence PSMs before and after processing.</li>
<li><strong>Aggregation:</strong> The <code>QFeatures</code> object is used to aggregate the data from the PSM-level to the peptide-level, and subsequently from the peptide-level to the protein-level, resulting in a protein <span class="math inline">\(\times\)</span> sample quantitative matrix (a <code>SummarizedExperiment</code> object).</li>
<li><strong>Statistical Analysis:</strong> This protein-level matrix is fed into a statistical package like <code>limma</code> for differential expression analysis. The <code>limma</code> functions <code>lmFit</code> and <code>eBayes</code> are applied to generate a table of <span class="math inline">\(\log_{2}\)</span> fold changes, p-values, and adjusted p-values for every protein.[75, 76]</li>
<li><strong>Visualization (The Synthesis):</strong> This single output table from <code>limma</code> becomes the input for a suite of visualizations to interpret the results:
<ul>
<li><strong>PCA Plot (Section IV.A):</strong> The protein matrix is used with <code>ropls</code> to create a <strong>PCA plot</strong>. This is a crucial <em>statistical QC</em> step to verify that the samples cluster by their biological condition (e.g., control vs.&nbsp;treated).</li>
<li><strong>Volcano Plot (Section IV.C):</strong> The <code>limma</code> results table is fed directly into <code>EnhancedVolcano</code>. This is the primary <em>discovery plot</em> to identify <em>which</em> proteins are significantly up- or downregulated.</li>
<li><strong>Heatmap (Section IV.B):</strong> The list of significant proteins from the volcano plot is used to filter the protein matrix. This subsetted matrix is then given to <code>pheatmap</code> to create a <strong>heatmap</strong>. This plot shows the <em>pattern</em> of the significant proteins across all samples, confirming that they cluster correctly.</li>
</ul></li>
</ol>
</section>
</section>
<section id="c.-case-study-2-end-to-end-metabolomics-workflow" class="level2">
<h2 class="anchored" data-anchor-id="c.-case-study-2-end-to-end-metabolomics-workflow">C. Case Study 2: End-to-End Metabolomics Workflow</h2>
<p>This case study demonstrates the parallel workflow for untargeted metabolomics, which is highly <em>chromatogram-centric</em>.[21, 77] It follows the logic of platforms like <code>xcms</code> and <code>MetaboAnalystR</code>.[78, 79]</p>
<ol type="1">
<li><strong>Data Import:</strong> The workflow begins by loading all raw <code>mzML</code> (or similar) files using <code>xcms</code> into a modern <code>OnDiskMSnExp</code> or <code>MsExperiment</code> object.[22]</li>
<li><strong>Raw Data QC:</strong> Before any processing, <strong>TIC and BPC plots</strong> (Section II.B) are generated for <em>all</em> files using the <code>chromatogram()</code> function.[42] These plots are inspected immediately to identify any failed runs, injection errors, or severe retention time drift.</li>
<li><strong>Peak Detection and Alignment:</strong> The <code>xcms</code> workflow is applied to detect chromatographic peaks in each sample, correct for retention time drift, and align features across all samples. This process results in a quantitative feature matrix (metabolic features <span class="math inline">\(\times\)</span> samples).</li>
<li><strong>Statistical Analysis:</strong> This feature matrix is used for statistical analysis.
<ul>
<li><strong>PCA/PLS-DA Plot (Section IV.A):</strong> As with proteomics, the feature matrix is fed into <code>ropls</code> to generate a <strong>PCA plot</strong> for unsupervised analysis and, commonly in metabolomics, a <strong>PLS-DA plot</strong> (Partial Least Squares Discriminant Analysis) for supervised modeling.[78] This is the primary method for assessing group separation.</li>
</ul></li>
<li><strong>Visualization and Interpretation:</strong>
<ul>
<li><strong>Volcano Plot (Section IV.C):</strong> A statistical test (e.g., t-test) is run on the feature matrix to generate p-values and fold changes, which are then used to create a <strong>volcano plot</strong> (using <code>EnhancedVolcano</code>) to discover the most significant metabolic features.</li>
<li><strong>XIC Validation (Section II.B):</strong> This is a crucial feedback loop. The <span class="math inline">\(m/z\)</span> and retention time coordinates of the top significant features from the volcano plot are used to generate <strong>XIC plots</strong> from the <em>original raw data</em>.[80] This step is essential to visually validate that a “significant feature” is a high-quality, well-integrated chromatographic peak and not a noise-driven artifact.</li>
<li><strong>Identification and Pathway Analysis:</strong> The <span class="math inline">\(m/z\)</span> and MS/MS data (if available) for the validated significant features are used to identify metabolites. These identified metabolites are then used for <strong>Pathway Analysis</strong> [78], the metabolomics equivalent of GO enrichment, to discover which biological pathways are most impacted by the experimental condition.</li>
</ul></li>
</ol>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This report has detailed a comprehensive, end-to-end framework for the visualization of mass spectrometry data using R and the Bioconductor project. The analysis demonstrates that R, through the modern <code>RforMassSpectrometry</code> initiative and its core packages (<code>Spectra</code>, <code>Chromatograms</code>, <code>QFeatures</code>), provides a complete, scalable, interoperable, and reproducible ecosystem for handling complex ’omics data.</p>
<p>The key conclusion is that visualization is not an aesthetic final step, but rather an integral component of the analysis pipeline, applied at every stage.</p>
<ul>
<li><strong>At the QC Stage:</strong> Chromatograms (TIC, BPC) and sample-wise cluster plots (PCA, t-SNE) are used to assess data quality and experimental integrity.</li>
<li><strong>At the Validation Stage:</strong> Annotated MS/MS spectra, mirror plots, and extracted ion chromatograms (XICs) are used to visually confirm and validate specific identifications and quantitative features.</li>
<li><strong>At the Discovery Stage:</strong> Volcano plots and heatmaps are used to explore the entire dataset, discover differentially abundant features, and reveal large-scale biological patterns.</li>
</ul>
<p>The provided code examples and workflow case studies for both proteomics and metabolomics serve as a robust and adaptable foundation for researchers, enabling them to move from raw instrument files to publication-ready, interactive, and biologically insightful visualizations.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>