<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>9&nbsp; Metabolomics Data Analysis – R for Mass Spectrometry</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./09-proteomics-analysis.html" rel="next">
<link href="./07-statistical-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-723e720168d758bedb1389a9dbd7daff.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><style>html{ scroll-behavior: smooth; }</style>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script><script src="site_libs/quarto-diagram/mermaid-init.js"></script><link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08-metabolomics-analysis.html">Applications</a></li><li class="breadcrumb-item"><a href="./08-metabolomics-analysis.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R for Mass Spectrometry</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vanhungtran/RforMS" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Foundations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction - Principles of Mass Spectrometry and Strategies for Data Acquisition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-Introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Mass Spectrometry in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12-open-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Accessing Open MS Data with MsDataHub</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Core Techniques</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-r-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">R Fundamentals for Mass Spectrometry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-data-formats-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Mass Spectrometry Data Formats and Import</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-spectral-preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Spectral Data Preprocessing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-peak-detection-quantification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Peak Detection and Quantification</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Analysis &amp; Visualization</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-data-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data Visualization for Mass Spectrometry</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-statistical-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Statistical Analysis of MS Data</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Applications</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-metabolomics-analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-proteomics-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Proteomics Data Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-qfeatures-quantitative.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Quantitative Proteomics with QFeatures</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Advanced Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11-advanced-topics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Advanced Topics and Applications</span></span></a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Summary and Future Directions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="2"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#setting-up-metabolomics-environment" id="toc-setting-up-metabolomics-environment" class="nav-link active" data-scroll-target="#setting-up-metabolomics-environment"><span class="header-section-number">9.1</span> Setting Up Metabolomics Environment</a></li>
  <li>
<a href="#understanding-metabolomics-workflows" id="toc-understanding-metabolomics-workflows" class="nav-link" data-scroll-target="#understanding-metabolomics-workflows"><span class="header-section-number">9.2</span> Understanding Metabolomics Workflows</a>
  <ul class="collapse">
<li><a href="#lc-ms-metabolomics-pipeline" id="toc-lc-ms-metabolomics-pipeline" class="nav-link" data-scroll-target="#lc-ms-metabolomics-pipeline"><span class="header-section-number">9.2.1</span> LC-MS Metabolomics Pipeline</a></li>
  </ul>
</li>
  <li>
<a href="#xcms-based-peak-detection" id="toc-xcms-based-peak-detection" class="nav-link" data-scroll-target="#xcms-based-peak-detection"><span class="header-section-number">9.3</span> XCMS-Based Peak Detection</a>
  <ul class="collapse">
<li><a href="#loading-raw-data" id="toc-loading-raw-data" class="nav-link" data-scroll-target="#loading-raw-data"><span class="header-section-number">9.3.1</span> Loading Raw Data</a></li>
  <li><a href="#chromatographic-peak-detection" id="toc-chromatographic-peak-detection" class="nav-link" data-scroll-target="#chromatographic-peak-detection"><span class="header-section-number">9.3.2</span> Chromatographic Peak Detection</a></li>
  <li><a href="#simulated-xcms-workflow" id="toc-simulated-xcms-workflow" class="nav-link" data-scroll-target="#simulated-xcms-workflow"><span class="header-section-number">9.3.3</span> Simulated XCMS Workflow</a></li>
  <li><a href="#peak-quality-assessment" id="toc-peak-quality-assessment" class="nav-link" data-scroll-target="#peak-quality-assessment"><span class="header-section-number">9.3.4</span> Peak Quality Assessment</a></li>
  <li><a href="#peak-filtering" id="toc-peak-filtering" class="nav-link" data-scroll-target="#peak-filtering"><span class="header-section-number">9.3.5</span> Peak Filtering</a></li>
  </ul>
</li>
  <li>
<a href="#data-normalization-and-scaling" id="toc-data-normalization-and-scaling" class="nav-link" data-scroll-target="#data-normalization-and-scaling"><span class="header-section-number">9.4</span> Data Normalization and Scaling</a>
  <ul class="collapse">
<li><a href="#different-normalization-methods" id="toc-different-normalization-methods" class="nav-link" data-scroll-target="#different-normalization-methods"><span class="header-section-number">9.4.1</span> Different Normalization Methods</a></li>
  <li><a href="#data-scaling" id="toc-data-scaling" class="nav-link" data-scroll-target="#data-scaling"><span class="header-section-number">9.4.2</span> Data Scaling</a></li>
  </ul>
</li>
  <li>
<a href="#multivariate-analysis-for-metabolomics" id="toc-multivariate-analysis-for-metabolomics" class="nav-link" data-scroll-target="#multivariate-analysis-for-metabolomics"><span class="header-section-number">9.5</span> Multivariate Analysis for Metabolomics</a>
  <ul class="collapse">
<li><a href="#principal-component-analysis-pca" id="toc-principal-component-analysis-pca" class="nav-link" data-scroll-target="#principal-component-analysis-pca"><span class="header-section-number">9.5.1</span> Principal Component Analysis (PCA)</a></li>
  <li><a href="#partial-least-squares-discriminant-analysis-pls-da" id="toc-partial-least-squares-discriminant-analysis-pls-da" class="nav-link" data-scroll-target="#partial-least-squares-discriminant-analysis-pls-da"><span class="header-section-number">9.5.2</span> Partial Least Squares Discriminant Analysis (PLS-DA)</a></li>
  <li><a href="#variable-importance-analysis" id="toc-variable-importance-analysis" class="nav-link" data-scroll-target="#variable-importance-analysis"><span class="header-section-number">9.5.3</span> Variable Importance Analysis</a></li>
  </ul>
</li>
  <li>
<a href="#metabolite-identification" id="toc-metabolite-identification" class="nav-link" data-scroll-target="#metabolite-identification"><span class="header-section-number">9.6</span> Metabolite Identification</a>
  <ul class="collapse">
<li><a href="#accurate-mass-matching" id="toc-accurate-mass-matching" class="nav-link" data-scroll-target="#accurate-mass-matching"><span class="header-section-number">9.6.1</span> Accurate Mass Matching</a></li>
  <li><a href="#msms-spectrum-matching" id="toc-msms-spectrum-matching" class="nav-link" data-scroll-target="#msms-spectrum-matching"><span class="header-section-number">9.6.2</span> MS/MS Spectrum Matching</a></li>
  </ul>
</li>
  <li>
<a href="#pathway-analysis" id="toc-pathway-analysis" class="nav-link" data-scroll-target="#pathway-analysis"><span class="header-section-number">9.7</span> Pathway Analysis</a>
  <ul class="collapse">
<li><a href="#metabolite-set-enrichment" id="toc-metabolite-set-enrichment" class="nav-link" data-scroll-target="#metabolite-set-enrichment"><span class="header-section-number">9.7.1</span> Metabolite Set Enrichment</a></li>
  </ul>
</li>
  <li>
<a href="#quality-control-and-batch-correction" id="toc-quality-control-and-batch-correction" class="nav-link" data-scroll-target="#quality-control-and-batch-correction"><span class="header-section-number">9.8</span> Quality Control and Batch Correction</a>
  <ul class="collapse">
<li><a href="#qc-sample-analysis" id="toc-qc-sample-analysis" class="nav-link" data-scroll-target="#qc-sample-analysis"><span class="header-section-number">9.8.1</span> QC Sample Analysis</a></li>
  </ul>
</li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">9.9</span> Exercises</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9.10</span> Summary</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/vanhungtran/RforMS/edit/main/08-metabolomics-analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vanhungtran/RforMS/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./08-metabolomics-analysis.html">Applications</a></li><li class="breadcrumb-item"><a href="./08-metabolomics-analysis.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></a></li></ol></nav><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">
<span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span>
</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>Metabolomics involves the comprehensive analysis of small molecules (metabolites) in biological systems. This chapter covers LC-MS metabolomics data processing using the R for Mass Spectrometry ecosystem, with emphasis on the <code>xcms</code> package and <code>Spectra</code> integration.</p>
<section id="setting-up-metabolomics-environment" class="level2" data-number="9.1"><h2 data-number="9.1" class="anchored" data-anchor-id="setting-up-metabolomics-environment">
<span class="header-section-number">9.1</span> Setting Up Metabolomics Environment</h2>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load required packages (with conditional loading for Bioconductor packages)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"xcms"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sneumann/xcms">xcms</a></span><span class="op">)</span>              <span class="co"># LC-MS data processing</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Note: xcms package not installed. Install with: BiocManager::install('xcms')"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"Spectra"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra">Spectra</a></span><span class="op">)</span>           <span class="co"># Core MS data structures</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html">message</a></span><span class="op">(</span><span class="st">"Note: Spectra package not installed. Install with: BiocManager::install('Spectra')"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"MetaboCoreUtils"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MetaboCoreUtils">MetaboCoreUtils</a></span><span class="op">)</span>   <span class="co"># Metabolomics utilities</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"MsCoreUtils"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsCoreUtils">MsCoreUtils</a></span><span class="op">)</span>       <span class="co"># MS data utilities</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Standard CRAN packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>           <span class="co"># Visualization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>             <span class="co"># Data manipulation</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>             <span class="co"># Data tidying</span></span>
<span></span>
<span><span class="co"># Optional packages</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"pheatmap"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"patchwork"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"CAMERA"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://msbi.ipb-halle.de/msbi/CAMERA/">CAMERA</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"CompoundDb"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/CompoundDb">CompoundDb</a></span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"mixOmics"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mixOmics</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="understanding-metabolomics-workflows" class="level2" data-number="9.2"><h2 data-number="9.2" class="anchored" data-anchor-id="understanding-metabolomics-workflows">
<span class="header-section-number">9.2</span> Understanding Metabolomics Workflows</h2>
<section id="lc-ms-metabolomics-pipeline" class="level3" data-number="9.2.1"><h3 data-number="9.2.1" class="anchored" data-anchor-id="lc-ms-metabolomics-pipeline">
<span class="header-section-number">9.2.1</span> LC-MS Metabolomics Pipeline</h3>
<p>A typical untargeted metabolomics workflow consists of:</p>
<ol type="1">
<li>
<strong>Peak detection</strong>: Identifying features (m/z-RT pairs) across samples</li>
<li>
<strong>Alignment</strong>: Correcting RT variations between samples</li>
<li>
<strong>Correspondence</strong>: Matching features across samples</li>
<li>
<strong>Gap filling</strong>: Integrating missing peaks</li>
<li>
<strong>Annotation</strong>: Identifying metabolites</li>
<li>
<strong>Statistical analysis</strong>: Finding differential metabolites</li>
</ol>
<div class="cell" data-fig-width="10" data-fig-height="7" data-layout-align="default">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode default code-with-copy"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>flowchart TD</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    subgraph Input["Raw LC-MS Data"]</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>        A[Multiple mzML Files&lt;br/&gt;Control &amp; Treatment Samples]</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    subgraph XCMS["xcms Processing Pipeline"]</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        B[1. Read Data&lt;br/&gt;readMSData] --&gt; C[2. Peak Detection&lt;br/&gt;findChromPeaks&lt;br/&gt;CentWave Algorithm]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        C --&gt; D[3. RT Alignment&lt;br/&gt;adjustRtime&lt;br/&gt;obiwarp/peakGroups]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        D --&gt; E[4. Correspondence&lt;br/&gt;groupChromPeaks&lt;br/&gt;PeakDensity]</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        E --&gt; F[5. Gap Filling&lt;br/&gt;fillChromPeaks&lt;br/&gt;ChromPeakArea]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    subgraph Annotation["Feature Annotation"]</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        F --&gt; G[CAMERA&lt;br/&gt;Adducts &amp; Isotopes]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        G --&gt; H[CompoundDb&lt;br/&gt;Database Matching]</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        H --&gt; I[MetaboCoreUtils&lt;br/&gt;Mass Calculations]</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    subgraph Output["Feature Matrix"]</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        I --&gt; J[Features × Samples&lt;br/&gt;Intensity Matrix]</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    subgraph Stats["Statistical Analysis"]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        J --&gt; K[Quality Control&lt;br/&gt;CV, Missing Values]</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        K --&gt; L[Normalization&lt;br/&gt;TIC/IS/QC-based]</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        L --&gt; M[Multivariate&lt;br/&gt;PCA, PLS-DA]</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        M --&gt; N[Univariate&lt;br/&gt;t-test, ANOVA]</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        N --&gt; O[Pathway Analysis&lt;br/&gt;Enrichment]</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    A --&gt; B</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  style Input fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  style XCMS fill:#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  style Annotation fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  style Output fill:#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  style Stats fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<p></p><figure class="figure"></figure><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    subgraph Input["Raw LC-MS Data"]
        A[Multiple mzML Files&lt;br/&gt;Control &amp; Treatment Samples]
    end
    
    subgraph XCMS["xcms Processing Pipeline"]
        B[1. Read Data&lt;br/&gt;readMSData] --&gt; C[2. Peak Detection&lt;br/&gt;findChromPeaks&lt;br/&gt;CentWave Algorithm]
        C --&gt; D[3. RT Alignment&lt;br/&gt;adjustRtime&lt;br/&gt;obiwarp/peakGroups]
        D --&gt; E[4. Correspondence&lt;br/&gt;groupChromPeaks&lt;br/&gt;PeakDensity]
        E --&gt; F[5. Gap Filling&lt;br/&gt;fillChromPeaks&lt;br/&gt;ChromPeakArea]
    end
    
    subgraph Annotation["Feature Annotation"]
        F --&gt; G[CAMERA&lt;br/&gt;Adducts &amp; Isotopes]
        G --&gt; H[CompoundDb&lt;br/&gt;Database Matching]
        H --&gt; I[MetaboCoreUtils&lt;br/&gt;Mass Calculations]
    end
    
    subgraph Output["Feature Matrix"]
        I --&gt; J[Features × Samples&lt;br/&gt;Intensity Matrix]
    end
    
    subgraph Stats["Statistical Analysis"]
        J --&gt; K[Quality Control&lt;br/&gt;CV, Missing Values]
        K --&gt; L[Normalization&lt;br/&gt;TIC/IS/QC-based]
        L --&gt; M[Multivariate&lt;br/&gt;PCA, PLS-DA]
        M --&gt; N[Univariate&lt;br/&gt;t-test, ANOVA]
        N --&gt; O[Pathway Analysis&lt;br/&gt;Enrichment]
    end
    
    A --&gt; B
    
  style Input fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43
  style XCMS fill:#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43
  style Annotation fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43
  style Output fill:#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43
  style Stats fill:#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43
</pre>
</div>
<p></p>
</div>
</div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
XCMS Workflow Key Parameters
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>
<strong>CentWave</strong>: ppm tolerance (5-25), peakwidth (5-30 sec), snthresh (3-10)</li>
<li>
<strong>Alignment</strong>: bw (bandwidth 2-10), minfrac (0.5-0.9)</li>
<li>
<strong>Correspondence</strong>: bw (1-5), minfrac (0.3-0.7)</li>
<li>
<strong>Gap Filling</strong>: expandMz/Rt for integration windows</li>
</ul>
</div>
</div>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Display workflow overview</span></span>
<span><span class="va">workflow_steps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  Step <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">6</span>,</span>
<span>  Process <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Peak Detection"</span>, <span class="st">"Retention Time Correction"</span>, </span>
<span>              <span class="st">"Correspondence"</span>, <span class="st">"Gap Filling"</span>, </span>
<span>              <span class="st">"Annotation"</span>, <span class="st">"Statistical Analysis"</span><span class="op">)</span>,</span>
<span>  Package <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, </span>
<span>              <span class="st">"CAMERA/CompoundDb"</span>, <span class="st">"limma/mixOmics"</span><span class="op">)</span>,</span>
<span>  Output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Chromatographic peaks"</span>, <span class="st">"Aligned peaks"</span>,</span>
<span>             <span class="st">"Feature matrix"</span>, <span class="st">"Complete matrix"</span>,</span>
<span>             <span class="st">"Putative IDs"</span>, <span class="st">"Differential metabolites"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">workflow_steps</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  Step                   Process           Package                   Output
1    1            Peak Detection              xcms    Chromatographic peaks
2    2 Retention Time Correction              xcms            Aligned peaks
3    3            Correspondence              xcms           Feature matrix
4    4               Gap Filling              xcms          Complete matrix
5    5                Annotation CAMERA/CompoundDb             Putative IDs
6    6      Statistical Analysis    limma/mixOmics Differential metabolites</code></pre>
</div>
</div>
</section></section><section id="xcms-based-peak-detection" class="level2" data-number="9.3"><h2 data-number="9.3" class="anchored" data-anchor-id="xcms-based-peak-detection">
<span class="header-section-number">9.3</span> XCMS-Based Peak Detection</h2>
<section id="loading-raw-data" class="level3" data-number="9.3.1"><h3 data-number="9.3.1" class="anchored" data-anchor-id="loading-raw-data">
<span class="header-section-number">9.3.1</span> Loading Raw Data</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Example workflow with real LC-MS data</span></span>
<span><span class="co"># Load raw files (typically multiple mzML files)</span></span>
<span><span class="va">raw_files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sample1.mzML"</span>, <span class="st">"sample2.mzML"</span>, <span class="st">"sample3.mzML"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create phenotype data</span></span>
<span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  sample_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">raw_files</span><span class="op">)</span>,</span>
<span>  sample_group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Control"</span>, <span class="st">"Treatment"</span><span class="op">)</span>,</span>
<span>  sample_type <span class="op">=</span> <span class="st">"Sample"</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read data into an XCMSnExp object</span></span>
<span><span class="va">raw_data</span> <span class="op">&lt;-</span> <span class="fu">readMSData</span><span class="op">(</span></span>
<span>  files <span class="op">=</span> <span class="va">raw_files</span>,</span>
<span>  pdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/methods/new.html">new</a></span><span class="op">(</span><span class="st">"NAnnotatedDataFrame"</span>, <span class="va">pd</span><span class="op">)</span>,</span>
<span>  mode <span class="op">=</span> <span class="st">"onDisk"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display data summary</span></span>
<span><span class="va">raw_data</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="chromatographic-peak-detection" class="level3" data-number="9.3.2"><h3 data-number="9.3.2" class="anchored" data-anchor-id="chromatographic-peak-detection">
<span class="header-section-number">9.3.2</span> Chromatographic Peak Detection</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Define peak detection parameters (CentWave for high-resolution data)</span></span>
<span><span class="va">cwp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks-centWave.html">CentWaveParam</a></span><span class="op">(</span></span>
<span>  ppm <span class="op">=</span> <span class="fl">20</span>,                  <span class="co"># m/z tolerance in ppm</span></span>
<span>  peakwidth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span>,      <span class="co"># Expected peak width range (seconds)</span></span>
<span>  snthresh <span class="op">=</span> <span class="fl">10</span>,             <span class="co"># Signal-to-noise threshold</span></span>
<span>  prefilter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">5000</span><span class="op">)</span>,   <span class="co"># Prefilter: min peaks, min intensity</span></span>
<span>  mzCenterFun <span class="op">=</span> <span class="st">"wMean"</span>,     <span class="co"># Weighted mean for m/z</span></span>
<span>  integrate <span class="op">=</span> <span class="fl">1</span>,             <span class="co"># Integration method</span></span>
<span>  mzdiff <span class="op">=</span> <span class="fl">0.01</span>,            <span class="co"># Minimum m/z difference</span></span>
<span>  fitgauss <span class="op">=</span> <span class="cn">FALSE</span>,          <span class="co"># Gaussian peak fitting</span></span>
<span>  noise <span class="op">=</span> <span class="fl">1000</span>              <span class="co"># Noise threshold</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform peak detection</span></span>
<span><span class="va">data_peaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks.html">findChromPeaks</a></span><span class="op">(</span><span class="va">raw_data</span>, param <span class="op">=</span> <span class="va">cwp</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Summary of detected peaks</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Total chromatographic peaks:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html">chromPeaks</a></span><span class="op">(</span><span class="va">data_peaks</span><span class="op">)</span><span class="op">[</span>, <span class="st">"into"</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>, <span class="st">"\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="simulated-xcms-workflow" class="level3" data-number="9.3.3"><h3 data-number="9.3.3" class="anchored" data-anchor-id="simulated-xcms-workflow">
<span class="header-section-number">9.3.3</span> Simulated XCMS Workflow</h3>
<p>For demonstration, let’s create a simulated dataset:</p>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Create synthetic metabolomics data for demonstration</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate retention times and m/z values for metabolites</span></span>
<span><span class="va">n_metabolites</span> <span class="op">&lt;-</span> <span class="fl">50</span></span>
<span><span class="va">metabolite_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  metabolite_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Met_"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_metabolites</span><span class="op">)</span>,</span>
<span>  mz <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n_metabolites</span>, <span class="fl">100</span>, <span class="fl">800</span><span class="op">)</span>,</span>
<span>  rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="va">n_metabolites</span>, <span class="fl">60</span>, <span class="fl">1200</span><span class="op">)</span>,  <span class="co"># RT in seconds</span></span>
<span>  intensity_mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="va">n_metabolites</span>, meanlog <span class="op">=</span> <span class="fl">6</span>, sdlog <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create sample information</span></span>
<span><span class="va">sample_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  sample_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Sample_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>  group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Control"</span>, <span class="st">"Treatment"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, each <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  injection_order <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Simulate peak intensity matrix</span></span>
<span><span class="va">intensity_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sample_info</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">metabolite_data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sample_info</span><span class="op">$</span><span class="va">sample_name</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">metabolite_data</span><span class="op">$</span><span class="va">metabolite_id</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sample_info</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">metabolite_data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Add group effect for some metabolites</span></span>
<span>    <span class="va">group_effect</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">sample_info</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">==</span> <span class="st">"Treatment"</span> <span class="op">&amp;</span> <span class="va">j</span> <span class="op">&lt;=</span> <span class="fl">15</span>, <span class="fl">1.5</span>, <span class="fl">1.0</span><span class="op">)</span></span>
<span>    <span class="co"># Add some biological and technical variation</span></span>
<span>    <span class="va">intensity_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">metabolite_data</span><span class="op">$</span><span class="va">intensity_mean</span><span class="op">[</span><span class="va">j</span><span class="op">]</span> <span class="op">*</span> <span class="va">group_effect</span> <span class="op">*</span> </span>
<span>                              <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>  <span class="co"># 30% CV</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Created synthetic metabolomics dataset with"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">sample_info</span><span class="op">)</span>, <span class="st">"samples and"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">metabolite_data</span><span class="op">)</span>, <span class="st">"metabolites\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Created synthetic metabolomics dataset with 20 samples and 50 metabolites</code></pre>
</div>
</div>
</section><section id="peak-quality-assessment" class="level3" data-number="9.3.4"><h3 data-number="9.3.4" class="anchored" data-anchor-id="peak-quality-assessment">
<span class="header-section-number">9.3.4</span> Peak Quality Assessment</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function to assess peak quality</span></span>
<span><span class="va">assess_peak_quality</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="va">sample_info</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate QC metrics</span></span>
<span>  <span class="va">quality_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    metabolite_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span>,</span>
<span>    mean_intensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    median_intensity <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    cv_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    missing_percent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span>,</span>
<span>    detection_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">quality_metrics</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">peak_quality</span> <span class="op">&lt;-</span> <span class="fu">assess_peak_quality</span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="va">sample_info</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize peak quality metrics</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">peak_quality</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cv_percent</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">20</span>, fill <span class="op">=</span> <span class="st">"skyblue"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distribution of Coefficient of Variation"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Red line indicates 30% CV threshold"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"CV (%)"</span>, y <span class="op">=</span> <span class="st">"Count"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section><section id="peak-filtering" class="level3" data-number="9.3.5"><h3 data-number="9.3.5" class="anchored" data-anchor-id="peak-filtering">
<span class="header-section-number">9.3.5</span> Peak Filtering</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Apply quality filters</span></span>
<span><span class="va">filter_peaks</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="va">quality_metrics</span>, </span>
<span>                        <span class="va">cv_threshold</span> <span class="op">=</span> <span class="fl">30</span>, </span>
<span>                        <span class="va">detection_threshold</span> <span class="op">=</span> <span class="fl">80</span>,</span>
<span>                        <span class="va">min_intensity</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Define filters</span></span>
<span>  <span class="va">cv_filter</span> <span class="op">&lt;-</span> <span class="va">quality_metrics</span><span class="op">$</span><span class="va">cv_percent</span> <span class="op">&lt;</span> <span class="va">cv_threshold</span></span>
<span>  <span class="va">detection_filter</span> <span class="op">&lt;-</span> <span class="va">quality_metrics</span><span class="op">$</span><span class="va">detection_rate</span> <span class="op">&gt;=</span> <span class="va">detection_threshold</span></span>
<span>  <span class="va">intensity_filter</span> <span class="op">&lt;-</span> <span class="va">quality_metrics</span><span class="op">$</span><span class="va">mean_intensity</span> <span class="op">&gt;=</span> <span class="va">min_intensity</span></span>
<span>  </span>
<span>  <span class="co"># Combine filters</span></span>
<span>  <span class="va">pass_filter</span> <span class="op">&lt;-</span> <span class="va">cv_filter</span> <span class="op">&amp;</span> <span class="va">detection_filter</span> <span class="op">&amp;</span> <span class="va">intensity_filter</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Filtering results:\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"  CV filter:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">cv_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"passed\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"  Detection rate filter:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">detection_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"passed\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"  Intensity filter:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">intensity_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"passed\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"  Combined filter:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="st">"passed\n"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Apply filter</span></span>
<span>  <span class="va">filtered_matrix</span> <span class="op">&lt;-</span> <span class="va">intensity_matrix</span><span class="op">[</span>, <span class="va">pass_filter</span><span class="op">]</span></span>
<span>  <span class="va">filtered_metabolites</span> <span class="op">&lt;-</span> <span class="va">metabolite_data</span><span class="op">[</span><span class="va">pass_filter</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    intensity_matrix <span class="op">=</span> <span class="va">filtered_matrix</span>,</span>
<span>    metabolite_data <span class="op">=</span> <span class="va">filtered_metabolites</span>,</span>
<span>    filter_summary <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      total_features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span>,</span>
<span>      passed_filter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      filter_rate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pass_filter</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">filtered_data</span> <span class="op">&lt;-</span> <span class="fu">filter_peaks</span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="va">peak_quality</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Filtering results:
  CV filter: 21 passed
  Detection rate filter: 50 passed
  Intensity filter: 9 passed
  Combined filter: 4 passed</code></pre>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">filter_summary</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>  total_features passed_filter filter_rate
1             50             4           8</code></pre>
</div>
</div>
</section></section><section id="data-normalization-and-scaling" class="level2" data-number="9.4"><h2 data-number="9.4" class="anchored" data-anchor-id="data-normalization-and-scaling">
<span class="header-section-number">9.4</span> Data Normalization and Scaling</h2>
<section id="different-normalization-methods" class="level3" data-number="9.4.1"><h3 data-number="9.4.1" class="anchored" data-anchor-id="different-normalization-methods">
<span class="header-section-number">9.4.1</span> Different Normalization Methods</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Implement various normalization methods</span></span>
<span><span class="va">normalize_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="va">method</span> <span class="op">=</span> <span class="st">"median"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">normalized_matrix</span> <span class="op">&lt;-</span> <span class="va">intensity_matrix</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"median"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Median normalization</span></span>
<span>    <span class="va">sample_medians</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">1</span>, <span class="va">median</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">global_median</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">sample_medians</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">normalization_factors</span> <span class="op">&lt;-</span> <span class="va">global_median</span> <span class="op">/</span> <span class="va">sample_medians</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">normalized_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">intensity_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">*</span> <span class="va">normalization_factors</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"tic"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Total ion current normalization</span></span>
<span>    <span class="va">sample_sums</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">1</span>, <span class="va">sum</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">global_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">sample_sums</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">normalization_factors</span> <span class="op">&lt;-</span> <span class="va">global_sum</span> <span class="op">/</span> <span class="va">sample_sums</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">normalized_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="va">intensity_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span> <span class="op">*</span> <span class="va">normalization_factors</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"quantile"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Quantile normalization (simplified)</span></span>
<span>    <span class="va">ranked_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="va">rank</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, ties.method <span class="op">=</span> <span class="st">"average"</span><span class="op">)</span></span>
<span>    <span class="va">sorted_means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">intensity_matrix</span>, <span class="fl">2</span>, <span class="va">sort</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">intensity_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">normalized_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sorted_means</span><span class="op">[</span><span class="va">ranked_data</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply different normalization methods</span></span>
<span><span class="va">median_normalized</span> <span class="op">&lt;-</span> <span class="fu">normalize_data</span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span>, <span class="st">"median"</span><span class="op">)</span></span>
<span><span class="va">tic_normalized</span> <span class="op">&lt;-</span> <span class="fu">normalize_data</span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span>, <span class="st">"tic"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare normalization effects</span></span>
<span><span class="va">compare_normalization</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">original</span>, <span class="va">normalized</span>, <span class="va">method_name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">original_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">original</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">normalized_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">normalized</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">comparison_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    sample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">original</span><span class="op">)</span>,</span>
<span>    original_cv <span class="op">=</span> <span class="va">original_cv</span>,</span>
<span>    normalized_cv <span class="op">=</span> <span class="va">normalized_cv</span>,</span>
<span>    method <span class="op">=</span> <span class="va">method_name</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">comparison_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">normalization_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu">compare_normalization</span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span>, <span class="va">median_normalized</span>, <span class="st">"Median"</span><span class="op">)</span>,</span>
<span>  <span class="fu">compare_normalization</span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span>, <span class="va">tic_normalized</span>, <span class="st">"TIC"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize normalization effects</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">normalization_comparison</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">original_cv</span>, y <span class="op">=</span> <span class="va">normalized_cv</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_abline</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="fl">0</span>, slope <span class="op">=</span> <span class="fl">1</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Effect of Normalization on Sample CV"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Original CV (%)"</span>, y <span class="op">=</span> <span class="st">"Normalized CV (%)"</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section><section id="data-scaling" class="level3" data-number="9.4.2"><h3 data-number="9.4.2" class="anchored" data-anchor-id="data-scaling">
<span class="header-section-number">9.4.2</span> Data Scaling</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Different scaling methods</span></span>
<span><span class="va">scale_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">normalized_matrix</span>, <span class="va">method</span> <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">scaled_matrix</span> <span class="op">&lt;-</span> <span class="va">normalized_matrix</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"auto"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Auto-scaling (mean-centering + unit variance)</span></span>
<span>    <span class="va">scaled_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"pareto"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Pareto scaling (mean-centering + square root of standard deviation)</span></span>
<span>    <span class="va">means</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">normalized_matrix</span>, <span class="fl">2</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">sds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">normalized_matrix</span>, <span class="fl">2</span>, <span class="va">sd</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">scaled_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">normalized_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">means</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">sds</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">method</span> <span class="op">==</span> <span class="st">"range"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Range scaling (0-1 normalization)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">min_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">max_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">normalized_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>      <span class="va">scaled_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">normalized_matrix</span><span class="op">[</span>, <span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="va">min_val</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">max_val</span> <span class="op">-</span> <span class="va">min_val</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">scaled_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Apply different scaling methods</span></span>
<span><span class="va">auto_scaled</span> <span class="op">&lt;-</span> <span class="fu">scale_data</span><span class="op">(</span><span class="va">median_normalized</span>, <span class="st">"auto"</span><span class="op">)</span></span>
<span><span class="va">pareto_scaled</span> <span class="op">&lt;-</span> <span class="fu">scale_data</span><span class="op">(</span><span class="va">median_normalized</span>, <span class="st">"pareto"</span><span class="op">)</span></span>
<span><span class="va">range_scaled</span> <span class="op">&lt;-</span> <span class="fu">scale_data</span><span class="op">(</span><span class="va">median_normalized</span>, <span class="st">"range"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize scaling effects</span></span>
<span><span class="va">scaling_comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">median_normalized</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  variance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">auto_scaled</span>, <span class="fl">2</span>, <span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">pareto_scaled</span>, <span class="fl">2</span>, <span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">range_scaled</span>, <span class="fl">2</span>, <span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Auto"</span>, <span class="st">"Pareto"</span>, <span class="st">"Range"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">median_normalized</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">scaling_comparison</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">method</span>, y <span class="op">=</span> <span class="va">variance</span>, fill <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Variance Distribution by Scaling Method"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"Scaling Method"</span>, y <span class="op">=</span> <span class="st">"Variance (log10 scale)"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="multivariate-analysis-for-metabolomics" class="level2" data-number="9.5"><h2 data-number="9.5" class="anchored" data-anchor-id="multivariate-analysis-for-metabolomics">
<span class="header-section-number">9.5</span> Multivariate Analysis for Metabolomics</h2>
<section id="principal-component-analysis-pca" class="level3" data-number="9.5.1"><h3 data-number="9.5.1" class="anchored" data-anchor-id="principal-component-analysis-pca">
<span class="header-section-number">9.5.1</span> Principal Component Analysis (PCA)</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Perform PCA on scaled data</span></span>
<span><span class="va">perform_metabolomics_pca</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scaled_matrix</span>, <span class="va">sample_info</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Remove any NA values</span></span>
<span>  <span class="va">clean_matrix</span> <span class="op">&lt;-</span> <span class="va">scaled_matrix</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">scaled_matrix</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  </span>
<span>  <span class="co"># Perform PCA</span></span>
<span>  <span class="va">pca_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/prcomp.html">prcomp</a></span><span class="op">(</span><span class="va">clean_matrix</span>, center <span class="op">=</span> <span class="cn">FALSE</span>, scale. <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract scores</span></span>
<span>  <span class="va">pca_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pca_result</span><span class="op">$</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      sample_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">clean_matrix</span><span class="op">)</span>,</span>
<span>      group <span class="op">=</span> <span class="va">sample_info</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">clean_matrix</span><span class="op">)</span>, <span class="va">sample_info</span><span class="op">$</span><span class="va">sample_name</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      batch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">sample_info</span><span class="op">$</span><span class="va">batch</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">clean_matrix</span><span class="op">)</span>, <span class="va">sample_info</span><span class="op">$</span><span class="va">sample_name</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Calculate variance explained</span></span>
<span>  <span class="va">var_explained</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">pca_result</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">pca_result</span><span class="op">$</span><span class="va">sdev</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    pca_result <span class="op">=</span> <span class="va">pca_result</span>,</span>
<span>    scores <span class="op">=</span> <span class="va">pca_scores</span>,</span>
<span>    variance_explained <span class="op">=</span> <span class="va">var_explained</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pca_analysis</span> <span class="op">&lt;-</span> <span class="fu">perform_metabolomics_pca</span><span class="op">(</span><span class="va">auto_scaled</span>, <span class="va">sample_info</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># PCA scores plot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">pca_analysis</span><span class="op">$</span><span class="va">scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">PC1</span>, y <span class="op">=</span> <span class="va">PC2</span>, color <span class="op">=</span> <span class="va">group</span>, shape <span class="op">=</span> <span class="va">batch</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">group</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"PCA Scores Plot - Metabolomics Data"</span>,</span>
<span>       x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PC1 ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pca_analysis</span><span class="op">$</span><span class="va">variance_explained</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%)"</span><span class="op">)</span>,</span>
<span>       y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"PC2 ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pca_analysis</span><span class="op">$</span><span class="va">variance_explained</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%)"</span><span class="op">)</span>,</span>
<span>       color <span class="op">=</span> <span class="st">"Group"</span>, shape <span class="op">=</span> <span class="st">"Batch"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section><section id="partial-least-squares-discriminant-analysis-pls-da" class="level3" data-number="9.5.2"><h3 data-number="9.5.2" class="anchored" data-anchor-id="partial-least-squares-discriminant-analysis-pls-da">
<span class="header-section-number">9.5.2</span> Partial Least Squares Discriminant Analysis (PLS-DA)</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Perform PLS-DA using mixOmics (if available)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"mixOmics"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">perform_plsda</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">scaled_matrix</span>, <span class="va">groups</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Clean data</span></span>
<span>    <span class="va">clean_matrix</span> <span class="op">&lt;-</span> <span class="va">scaled_matrix</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">scaled_matrix</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">clean_groups</span> <span class="op">&lt;-</span> <span class="va">groups</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">scaled_matrix</span><span class="op">)</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Perform PLS-DA</span></span>
<span>    <span class="va">plsda_result</span> <span class="op">&lt;-</span> <span class="fu">mixOmics</span><span class="fu">::</span><span class="fu">plsda</span><span class="op">(</span><span class="va">clean_matrix</span>, <span class="va">clean_groups</span>, ncomp <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">plsda_result</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">plsda_analysis</span> <span class="op">&lt;-</span> <span class="fu">perform_plsda</span><span class="op">(</span><span class="va">auto_scaled</span>, <span class="va">sample_info</span><span class="op">$</span><span class="va">group</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Extract PLS-DA scores</span></span>
<span>  <span class="va">plsda_scores</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">plsda_analysis</span><span class="op">$</span><span class="va">variates</span><span class="op">$</span><span class="va">X</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>      sample_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">auto_scaled</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">auto_scaled</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      group <span class="op">=</span> <span class="va">sample_info</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span><span class="op">(</span><span class="va">auto_scaled</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># PLS-DA scores plot</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">plsda_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">comp1</span>, y <span class="op">=</span> <span class="va">comp2</span>, color <span class="op">=</span> <span class="va">group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/stat_ellipse.html">stat_ellipse</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"PLS-DA Scores Plot"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Component 1"</span>, y <span class="op">=</span> <span class="st">"Component 2"</span>,</span>
<span>         color <span class="op">=</span> <span class="st">"Group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Note: mixOmics package not available. Skipping PLS-DA analysis.\n"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Install with: BiocManager::install('mixOmics')\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Note: mixOmics package not available. Skipping PLS-DA analysis.
Install with: BiocManager::install('mixOmics')</code></pre>
</div>
</div>
</section><section id="variable-importance-analysis" class="level3" data-number="9.5.3"><h3 data-number="9.5.3" class="anchored" data-anchor-id="variable-importance-analysis">
<span class="header-section-number">9.5.3</span> Variable Importance Analysis</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Calculate VIP scores (if mixOmics is available and PLS-DA was run)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">"mixOmics"</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/exists.html">exists</a></span><span class="op">(</span><span class="st">"plsda_analysis"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">calculate_vip</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">plsda_result</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vip_scores</span> <span class="op">&lt;-</span> <span class="fu">mixOmics</span><span class="fu">::</span><span class="fu">vip</span><span class="op">(</span><span class="va">plsda_result</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">vip_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">vip_scores</span><span class="op">)</span>,</span>
<span>      vip_comp1 <span class="op">=</span> <span class="va">vip_scores</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>,</span>
<span>      vip_comp2 <span class="op">=</span> <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">vip_scores</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span> <span class="va">vip_scores</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span> <span class="kw">else</span> <span class="cn">NA</span></span>
<span>    <span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">vip_data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">vip_scores</span> <span class="op">&lt;-</span> <span class="fu">calculate_vip</span><span class="op">(</span><span class="va">plsda_analysis</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Plot VIP scores</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">vip_scores</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">feature</span>, <span class="va">vip_comp1</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">vip_comp1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, fill <span class="op">=</span> <span class="st">"steelblue"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">"red"</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Variable Importance in Projection (VIP) Scores"</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"Red line indicates VIP &gt; 1 threshold"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Features"</span>, y <span class="op">=</span> <span class="st">"VIP Score (Component 1)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Note: VIP scores require mixOmics package and successful PLS-DA analysis.\n"</span><span class="op">)</span></span>
<span>  <span class="co"># Create empty vip_scores object for downstream code</span></span>
<span>  <span class="va">vip_scores</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Note: VIP scores require mixOmics package and successful PLS-DA analysis.</code></pre>
</div>
</div>
</section></section><section id="metabolite-identification" class="level2" data-number="9.6"><h2 data-number="9.6" class="anchored" data-anchor-id="metabolite-identification">
<span class="header-section-number">9.6</span> Metabolite Identification</h2>
<section id="accurate-mass-matching" class="level3" data-number="9.6.1"><h3 data-number="9.6.1" class="anchored" data-anchor-id="accurate-mass-matching">
<span class="header-section-number">9.6.1</span> Accurate Mass Matching</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Function for accurate mass matching</span></span>
<span><span class="va">accurate_mass_search</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">query_mz</span>, <span class="va">mass_database</span>, <span class="va">tolerance_ppm</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Create a simple mass database (normally you'd use real databases)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/missing.html">missing</a></span><span class="op">(</span><span class="va">mass_database</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">mass_database</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      compound_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Glucose"</span>, <span class="st">"Fructose"</span>, <span class="st">"Sucrose"</span>, <span class="st">"Lactose"</span>, <span class="st">"Maltose"</span>,</span>
<span>                       <span class="st">"Alanine"</span>, <span class="st">"Glycine"</span>, <span class="st">"Serine"</span>, <span class="st">"Threonine"</span>, <span class="st">"Valine"</span><span class="op">)</span>,</span>
<span>      exact_mass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">180.0634</span>, <span class="fl">180.0634</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>,</span>
<span>                    <span class="fl">89.0477</span>, <span class="fl">75.0320</span>, <span class="fl">105.0426</span>, <span class="fl">119.0582</span>, <span class="fl">117.0790</span><span class="op">)</span>,</span>
<span>      formula <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"C6H12O6"</span>, <span class="st">"C6H12O6"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>,</span>
<span>                 <span class="st">"C3H7NO2"</span>, <span class="st">"C2H5NO2"</span>, <span class="st">"C3H7NO3"</span>, <span class="st">"C4H9NO3"</span>, <span class="st">"C5H11NO2"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">query_mz</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate mass differences</span></span>
<span>    <span class="va">mass_diff_ppm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">mass_database</span><span class="op">$</span><span class="va">exact_mass</span> <span class="op">-</span> <span class="va">query_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="va">query_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">*</span> <span class="fl">1e6</span></span>
<span>    </span>
<span>    <span class="co"># Find matches within tolerance</span></span>
<span>    <span class="va">match_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">mass_diff_ppm</span> <span class="op">&lt;=</span> <span class="va">tolerance_ppm</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">match_idx</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="va">match_idx</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">matches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">matches</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>          query_mz <span class="op">=</span> <span class="va">query_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>          matched_compound <span class="op">=</span> <span class="va">mass_database</span><span class="op">$</span><span class="va">compound_name</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>          exact_mass <span class="op">=</span> <span class="va">mass_database</span><span class="op">$</span><span class="va">exact_mass</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>          formula <span class="op">=</span> <span class="va">mass_database</span><span class="op">$</span><span class="va">formula</span><span class="op">[</span><span class="va">j</span><span class="op">]</span>,</span>
<span>          mass_error_ppm <span class="op">=</span> <span class="va">mass_diff_ppm</span><span class="op">[</span><span class="va">j</span><span class="op">]</span></span>
<span>        <span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">matches</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Perform mass matching for significant features</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">vip_scores</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">significant_features</span> <span class="op">&lt;-</span> <span class="va">vip_scores</span><span class="op">$</span><span class="va">feature</span><span class="op">[</span><span class="va">vip_scores</span><span class="op">$</span><span class="va">vip_comp1</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="co"># Use alternative method to identify significant features</span></span>
<span>  <span class="co"># Based on highest variance across samples</span></span>
<span>  <span class="va">feature_variance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">metabolite_data</span><span class="op">[</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">top_features_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">feature_variance</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">feature_variance</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="va">significant_features</span> <span class="op">&lt;-</span> <span class="va">filtered_data</span><span class="op">$</span><span class="va">metabolite_data</span><span class="op">$</span><span class="va">metabolite_id</span><span class="op">[</span><span class="va">top_features_idx</span><span class="op">]</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">significant_features</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Extract m/z values for significant features</span></span>
<span>  <span class="va">significant_mz</span> <span class="op">&lt;-</span> <span class="va">filtered_data</span><span class="op">$</span><span class="va">metabolite_data</span><span class="op">$</span><span class="va">mz</span><span class="op">[</span></span>
<span>    <span class="va">filtered_data</span><span class="op">$</span><span class="va">metabolite_data</span><span class="op">$</span><span class="va">metabolite_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">significant_features</span></span>
<span>  <span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">mass_matches</span> <span class="op">&lt;-</span> <span class="fu">accurate_mass_search</span><span class="op">(</span><span class="va">significant_mz</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mass_matches</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Potential metabolite identifications:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">mass_matches</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"No matches found in database\n"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>No matches found in database</code></pre>
</div>
</div>
</section><section id="msms-spectrum-matching" class="level3" data-number="9.6.2"><h3 data-number="9.6.2" class="anchored" data-anchor-id="msms-spectrum-matching">
<span class="header-section-number">9.6.2</span> MS/MS Spectrum Matching</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simulate MS/MS data for demonstration</span></span>
<span><span class="va">simulate_msms_spectrum</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">precursor_mz</span>, <span class="va">intensity</span> <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Generate realistic fragment ions</span></span>
<span>  <span class="va">n_fragments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">5</span><span class="op">:</span><span class="fl">15</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Common neutral losses for metabolites</span></span>
<span>  <span class="va">neutral_losses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">18.01</span>, <span class="fl">28.01</span>, <span class="fl">44.00</span>, <span class="fl">46.00</span>, <span class="fl">60.02</span>, <span class="fl">62.00</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">fragment_mz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_fragments</span><span class="op">)</span></span>
<span>  <span class="va">fragment_intensity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="va">n_fragments</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_fragments</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">neutral_losses</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Use neutral loss</span></span>
<span>      <span class="va">fragment_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">precursor_mz</span> <span class="op">-</span> <span class="va">neutral_losses</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="co"># Random fragment</span></span>
<span>      <span class="va">fragment_mz</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">50</span>, <span class="va">precursor_mz</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Random intensity</span></span>
<span>    <span class="va">fragment_intensity</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0.1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="va">intensity</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Sort by m/z</span></span>
<span>  <span class="va">order_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">fragment_mz</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    mz <span class="op">=</span> <span class="va">fragment_mz</span><span class="op">[</span><span class="va">order_idx</span><span class="op">]</span>,</span>
<span>    intensity <span class="op">=</span> <span class="va">fragment_intensity</span><span class="op">[</span><span class="va">order_idx</span><span class="op">]</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create example MS/MS spectra</span></span>
<span><span class="va">example_msms</span> <span class="op">&lt;-</span> <span class="fu">simulate_msms_spectrum</span><span class="op">(</span><span class="fl">180.0634</span><span class="op">)</span>  <span class="co"># Glucose-like spectrum</span></span>
<span></span>
<span><span class="co"># Plot MS/MS spectrum</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">example_msms</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">mz</span>, y <span class="op">=</span> <span class="va">intensity</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html">geom_segment</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>xend <span class="op">=</span> <span class="va">mz</span>, yend <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"red"</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Simulated MS/MS Spectrum"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"m/z"</span>, y <span class="op">=</span> <span class="st">"Relative Intensity"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
</div>
</section></section><section id="pathway-analysis" class="level2" data-number="9.7"><h2 data-number="9.7" class="anchored" data-anchor-id="pathway-analysis">
<span class="header-section-number">9.7</span> Pathway Analysis</h2>
<section id="metabolite-set-enrichment" class="level3" data-number="9.7.1"><h3 data-number="9.7.1" class="anchored" data-anchor-id="metabolite-set-enrichment">
<span class="header-section-number">9.7.1</span> Metabolite Set Enrichment</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simulate pathway database</span></span>
<span><span class="va">create_pathway_database</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pathways</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Glycolysis"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Met_1"</span>, <span class="st">"Met_3"</span>, <span class="st">"Met_5"</span>, <span class="st">"Met_7"</span>, <span class="st">"Met_9"</span><span class="op">)</span>,</span>
<span>    <span class="st">"TCA_Cycle"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Met_2"</span>, <span class="st">"Met_4"</span>, <span class="st">"Met_6"</span>, <span class="st">"Met_8"</span>, <span class="st">"Met_10"</span><span class="op">)</span>,</span>
<span>    <span class="st">"Amino_Acid_Metabolism"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Met_11"</span>, <span class="st">"Met_12"</span>, <span class="st">"Met_13"</span>, <span class="st">"Met_14"</span>, <span class="st">"Met_15"</span><span class="op">)</span>,</span>
<span>    <span class="st">"Lipid_Metabolism"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Met_16"</span>, <span class="st">"Met_17"</span>, <span class="st">"Met_18"</span>, <span class="st">"Met_19"</span>, <span class="st">"Met_20"</span><span class="op">)</span>,</span>
<span>    <span class="st">"Nucleotide_Metabolism"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Met_21"</span>, <span class="st">"Met_22"</span>, <span class="st">"Met_23"</span>, <span class="st">"Met_24"</span>, <span class="st">"Met_25"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pathways</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Perform pathway enrichment</span></span>
<span><span class="va">pathway_enrichment</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">significant_metabolites</span>, <span class="va">pathway_db</span>, <span class="va">total_metabolites</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">enrichment_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">pathway_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">pathway_db</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pathway_metabolites</span> <span class="op">&lt;-</span> <span class="va">pathway_db</span><span class="op">[[</span><span class="va">pathway_name</span><span class="op">]</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Calculate overlap</span></span>
<span>    <span class="va">overlap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">intersect</a></span><span class="op">(</span><span class="va">significant_metabolites</span>, <span class="va">pathway_metabolites</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Calculate contingency table values</span></span>
<span>    <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">overlap</span><span class="op">)</span>  <span class="co"># significant &amp; in pathway</span></span>
<span>    <span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">significant_metabolites</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">overlap</span><span class="op">)</span>  <span class="co"># significant &amp; not in pathway</span></span>
<span>    <span class="va">c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pathway_metabolites</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">overlap</span><span class="op">)</span>  <span class="co"># not significant &amp; in pathway</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">total_metabolites</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">significant_metabolites</span><span class="op">)</span> <span class="op">-</span> </span>
<span>         <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pathway_metabolites</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">overlap</span><span class="op">)</span>  <span class="co"># not significant &amp; not in pathway</span></span>
<span>    </span>
<span>    <span class="co"># Ensure all values are non-negative</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">d</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">d</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Skip this pathway if contingency table is invalid</span></span>
<span>      <span class="kw">next</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="co"># Fisher's exact test</span></span>
<span>    <span class="va">contingency_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span>, <span class="va">d</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">fisher_test</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html">tryCatch</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/fisher.test.html">fisher.test</a></span><span class="op">(</span><span class="va">contingency_table</span>, alternative <span class="op">=</span> <span class="st">"greater"</span><span class="op">)</span></span>
<span>    <span class="op">}</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>p.value <span class="op">=</span> <span class="fl">1</span>, estimate <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">enrichment_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">enrichment_results</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      pathway <span class="op">=</span> <span class="va">pathway_name</span>,</span>
<span>      overlap_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">overlap</span><span class="op">)</span>,</span>
<span>      pathway_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">pathway_metabolites</span><span class="op">)</span>,</span>
<span>      significant_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">significant_metabolites</span><span class="op">)</span>,</span>
<span>      p_value <span class="op">=</span> <span class="va">fisher_test</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>      odds_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">fisher_test</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="co"># Multiple testing correction</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">enrichment_results</span><span class="op">$</span><span class="va">p_adjusted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html">p.adjust</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">$</span><span class="va">p_value</span>, method <span class="op">=</span> <span class="st">"fdr"</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">$</span><span class="va">p_value</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>      pathway <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      overlap_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      pathway_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      significant_size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html">integer</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      p_value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      odds_ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>,</span>
<span>      p_adjusted <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">numeric</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Perform enrichment analysis</span></span>
<span><span class="va">pathway_db</span> <span class="op">&lt;-</span> <span class="fu">create_pathway_database</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">significant_metabolites</span> <span class="op">&lt;-</span> <span class="va">significant_features</span></span>
<span></span>
<span><span class="va">enrichment_results</span> <span class="op">&lt;-</span> <span class="fu">pathway_enrichment</span><span class="op">(</span></span>
<span>  <span class="va">significant_metabolites</span>, </span>
<span>  <span class="va">pathway_db</span>, </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">enrichment_results</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Visualize enrichment results</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">enrichment_results</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/reorder.factor.html">reorder</a></span><span class="op">(</span><span class="va">pathway</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">p_value</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                                y <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">p_value</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">"identity"</span>, fill <span class="op">=</span> <span class="st">"coral"</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fl">0.05</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_flip.html">coord_flip</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Pathway Enrichment Analysis"</span>,</span>
<span>         x <span class="op">=</span> <span class="st">"Pathway"</span>, y <span class="op">=</span> <span class="st">"-log10(P-value)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"No significant pathway enrichment found.\n"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>No significant pathway enrichment found.</code></pre>
</div>
</div>
</section></section><section id="quality-control-and-batch-correction" class="level2" data-number="9.8"><h2 data-number="9.8" class="anchored" data-anchor-id="quality-control-and-batch-correction">
<span class="header-section-number">9.8</span> Quality Control and Batch Correction</h2>
<section id="qc-sample-analysis" class="level3" data-number="9.8.1"><h3 data-number="9.8.1" class="anchored" data-anchor-id="qc-sample-analysis">
<span class="header-section-number">9.8.1</span> QC Sample Analysis</h3>
<div class="cell">
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Simulate QC samples</span></span>
<span><span class="va">simulate_qc_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">original_matrix</span>, <span class="va">n_qc</span> <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># QC samples are typically pooled samples with intermediate values</span></span>
<span>  <span class="va">qc_matrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="va">n_qc</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">original_matrix</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">qc_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"QC_"</span>, <span class="fl">1</span><span class="op">:</span><span class="va">n_qc</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">qc_matrix</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">original_matrix</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_qc</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">original_matrix</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># QC intensity as mean of original samples with some variation</span></span>
<span>      <span class="va">qc_matrix</span><span class="op">[</span><span class="va">i</span>, <span class="va">j</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">original_matrix</span><span class="op">[</span>, <span class="va">j</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/stats/Lognormal.html">rlnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span>  <span class="co"># 10% variation</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">qc_matrix</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">qc_matrix</span> <span class="op">&lt;-</span> <span class="fu">simulate_qc_samples</span><span class="op">(</span><span class="va">filtered_data</span><span class="op">$</span><span class="va">intensity_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate QC stability</span></span>
<span><span class="va">calculate_qc_stability</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">qc_matrix</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">qc_cv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">qc_matrix</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">stability_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">qc_cv</span><span class="op">)</span>,</span>
<span>    qc_cv <span class="op">=</span> <span class="va">qc_cv</span>,</span>
<span>    stable <span class="op">=</span> <span class="va">qc_cv</span> <span class="op">&lt;</span> <span class="fl">20</span>  <span class="co"># 20% CV threshold for stability</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">stability_summary</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">qc_stability</span> <span class="op">&lt;-</span> <span class="fu">calculate_qc_stability</span><span class="op">(</span><span class="va">qc_matrix</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Visualize QC stability</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">qc_stability</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">qc_cv</span>, fill <span class="op">=</span> <span class="va">stable</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">20</span>, alpha <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"green"</span>, <span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">20</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"QC Sample Stability Assessment"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"QC CV (%)"</span>, y <span class="op">=</span> <span class="st">"Count"</span>,</span>
<span>       fill <span class="op">=</span> <span class="st">"Stable (CV &lt; 20%)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<div>
<figure class="figure"><p><img src="08-metabolomics-analysis_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="2400"></p>
</figure>
</div>
</div>
<details open="" class="code-fold"><summary>Code</summary><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Percentage of stable features:"</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">qc_stability</span><span class="op">$</span><span class="va">stable</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">qc_stability</span><span class="op">)</span> <span class="op">*</span> <span class="fl">100</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"%\n"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>Percentage of stable features: 100 %</code></pre>
</div>
</div>
</section></section><section id="exercises" class="level2" data-number="9.9"><h2 data-number="9.9" class="anchored" data-anchor-id="exercises">
<span class="header-section-number">9.9</span> Exercises</h2>
<ol type="1">
<li>Process real metabolomics data using XCMS</li>
<li>Compare different normalization methods on your dataset</li>
<li>Implement a complete identification workflow using spectral databases</li>
<li>Perform time-course metabolomics analysis</li>
<li>Build a metabolomics data processing pipeline with quality control</li>
</ol></section><section id="summary" class="level2" data-number="9.10"><h2 data-number="9.10" class="anchored" data-anchor-id="summary">
<span class="header-section-number">9.10</span> Summary</h2>
<p>This chapter covered comprehensive metabolomics data analysis workflows, including peak detection, data normalization, multivariate analysis, metabolite identification, and pathway analysis. These methods form the foundation for extracting biological insights from metabolomics experiments.</p>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vanhungtran\.github\.io\/RforMS\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
            // default icon
            link.classList.add("external");
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./07-statistical-analysis.html" class="pagination-link" aria-label="Statistical Analysis of MS Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Statistical Analysis of MS Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./09-proteomics-analysis.html" class="pagination-link" aria-label="Proteomics Data Analysis">
        <span class="nav-page-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Proteomics Data Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb29" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metabolomics Data Analysis</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>Metabolomics involves the comprehensive analysis of small molecules (metabolites) in biological systems. This chapter covers LC-MS metabolomics data processing using the R for Mass Spectrometry ecosystem, with emphasis on the <span class="in">`xcms`</span> package and <span class="in">`Spectra`</span> integration.</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up Metabolomics Environment</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages (with conditional loading for Bioconductor packages)</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"xcms"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(xcms)              <span class="co"># LC-MS data processing</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: xcms package not installed. Install with: BiocManager::install('xcms')"</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"Spectra"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Spectra)           <span class="co"># Core MS data structures</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: Spectra package not installed. Install with: BiocManager::install('Spectra')"</span>)</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MetaboCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MetaboCoreUtils)   <span class="co"># Metabolomics utilities</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MsCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MsCoreUtils)       <span class="co"># MS data utilities</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard CRAN packages</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)           <span class="co"># Visualization</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)             <span class="co"># Data manipulation</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)             <span class="co"># Data tidying</span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional packages</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"pheatmap"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(pheatmap)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"patchwork"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(patchwork)</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CAMERA"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CAMERA)</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CompoundDb"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CompoundDb)</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(mixOmics)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding Metabolomics Workflows</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="fu">### LC-MS Metabolomics Pipeline</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>A typical untargeted metabolomics workflow consists of:</span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Peak detection**: Identifying features (m/z-RT pairs) across samples</span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Alignment**: Correcting RT variations between samples</span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Correspondence**: Matching features across samples</span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Gap filling**: Integrating missing peaks</span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Annotation**: Identifying metabolites</span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Statistical analysis**: Finding differential metabolites</span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>%%| fig-width: <span class="dv">10</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>%%| fig-height: <span class="dv">7</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>flowchart TD</span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>    subgraph Input[<span class="ot">"</span><span class="st">Raw LC-MS Data</span><span class="ot">"</span>]</span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>        A[Multiple mzML Files&lt;br/&gt;Control &amp; Treatment Samples]</span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    subgraph XCMS[<span class="ot">"</span><span class="st">xcms Processing Pipeline</span><span class="ot">"</span>]</span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>        B[<span class="dv">1</span>. Read Data&lt;br/&gt;readMSData] --&gt; C[<span class="dv">2</span>. Peak Detection&lt;br/&gt;findChromPeaks&lt;br/&gt;CentWave Algorithm]</span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>        C --&gt; D[<span class="dv">3</span>. RT Alignment&lt;br/&gt;adjustRtime&lt;br/&gt;obiwarp/peakGroups]</span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        D --&gt; E[<span class="dv">4</span>. Correspondence&lt;br/&gt;groupChromPeaks&lt;br/&gt;PeakDensity]</span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>        E --&gt; F[<span class="dv">5</span>. Gap Filling&lt;br/&gt;fillChromPeaks&lt;br/&gt;ChromPeakArea]</span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a>    subgraph Annotation[<span class="ot">"</span><span class="st">Feature Annotation</span><span class="ot">"</span>]</span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>        F --&gt; G[CAMERA&lt;br/&gt;Adducts &amp; Isotopes]</span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>        G --&gt; H[CompoundDb&lt;br/&gt;Database Matching]</span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>        H --&gt; I[MetaboCoreUtils&lt;br/&gt;Mass Calculations]</span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>    subgraph Output[<span class="ot">"</span><span class="st">Feature Matrix</span><span class="ot">"</span>]</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>        I --&gt; J[Features × Samples&lt;br/&gt;Intensity Matrix]</span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a>    subgraph Stats[<span class="ot">"</span><span class="st">Statistical Analysis</span><span class="ot">"</span>]</span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>        J --&gt; K[Quality Control&lt;br/&gt;CV, Missing Values]</span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>        K --&gt; L[Normalization&lt;br/&gt;TIC/IS/QC-based]</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>        L --&gt; M[Multivariate&lt;br/&gt;PCA, PLS-DA]</span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>        M --&gt; N[Univariate&lt;br/&gt;t-test, ANOVA]</span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>        N --&gt; O[Pathway Analysis&lt;br/&gt;Enrichment]</span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a>    end</span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>    A --&gt; B</span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>  style Input fill:<span class="co">#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>  style XCMS fill:<span class="co">#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43</span></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>  style Annotation fill:<span class="co">#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>  style Output fill:<span class="co">#FBE0FA,stroke:#B000B0,stroke-width:3px,color:#102A43</span></span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>  style Stats fill:<span class="co">#D7E6FB,stroke:#27408B,stroke-width:3px,color:#102A43</span></span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>::: {.callout-tip}</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a><span class="fu">## XCMS Workflow Key Parameters</span></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**CentWave**: ppm tolerance (5-25), peakwidth (5-30 sec), snthresh (3-10)</span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Alignment**: bw (bandwidth 2-10), minfrac (0.5-0.9)</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Correspondence**: bw (1-5), minfrac (0.3-0.7)</span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Gap Filling**: expandMz/Rt for integration windows</span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Display workflow overview</span></span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>workflow_steps <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">Step =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">Process =</span> <span class="fu">c</span>(<span class="st">"Peak Detection"</span>, <span class="st">"Retention Time Correction"</span>, </span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Correspondence"</span>, <span class="st">"Gap Filling"</span>, </span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Annotation"</span>, <span class="st">"Statistical Analysis"</span>),</span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">Package =</span> <span class="fu">c</span>(<span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, </span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>              <span class="st">"CAMERA/CompoundDb"</span>, <span class="st">"limma/mixOmics"</span>),</span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">Output =</span> <span class="fu">c</span>(<span class="st">"Chromatographic peaks"</span>, <span class="st">"Aligned peaks"</span>,</span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Feature matrix"</span>, <span class="st">"Complete matrix"</span>,</span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Putative IDs"</span>, <span class="st">"Differential metabolites"</span>)</span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_steps)</span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-131"><a href="#cb29-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-132"><a href="#cb29-132" aria-hidden="true" tabindex="-1"></a><span class="fu">## XCMS-Based Peak Detection</span></span>
<span id="cb29-133"><a href="#cb29-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-134"><a href="#cb29-134" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Raw Data</span></span>
<span id="cb29-135"><a href="#cb29-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-138"><a href="#cb29-138" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-139"><a href="#cb29-139" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb29-140"><a href="#cb29-140" aria-hidden="true" tabindex="-1"></a><span class="co"># Example workflow with real LC-MS data</span></span>
<span id="cb29-141"><a href="#cb29-141" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raw files (typically multiple mzML files)</span></span>
<span id="cb29-142"><a href="#cb29-142" aria-hidden="true" tabindex="-1"></a>raw_files <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sample1.mzML"</span>, <span class="st">"sample2.mzML"</span>, <span class="st">"sample3.mzML"</span>)</span>
<span id="cb29-143"><a href="#cb29-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-144"><a href="#cb29-144" aria-hidden="true" tabindex="-1"></a><span class="co"># Create phenotype data</span></span>
<span id="cb29-145"><a href="#cb29-145" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-146"><a href="#cb29-146" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">basename</span>(raw_files),</span>
<span id="cb29-147"><a href="#cb29-147" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_group =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Control"</span>, <span class="st">"Treatment"</span>),</span>
<span id="cb29-148"><a href="#cb29-148" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_type =</span> <span class="st">"Sample"</span>,</span>
<span id="cb29-149"><a href="#cb29-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb29-150"><a href="#cb29-150" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-151"><a href="#cb29-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-152"><a href="#cb29-152" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data into an XCMSnExp object</span></span>
<span id="cb29-153"><a href="#cb29-153" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">readMSData</span>(</span>
<span id="cb29-154"><a href="#cb29-154" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> raw_files,</span>
<span id="cb29-155"><a href="#cb29-155" aria-hidden="true" tabindex="-1"></a>  <span class="at">pdata =</span> <span class="fu">new</span>(<span class="st">"NAnnotatedDataFrame"</span>, pd),</span>
<span id="cb29-156"><a href="#cb29-156" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"onDisk"</span></span>
<span id="cb29-157"><a href="#cb29-157" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-158"><a href="#cb29-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-159"><a href="#cb29-159" aria-hidden="true" tabindex="-1"></a><span class="co"># Display data summary</span></span>
<span id="cb29-160"><a href="#cb29-160" aria-hidden="true" tabindex="-1"></a>raw_data</span>
<span id="cb29-161"><a href="#cb29-161" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-162"><a href="#cb29-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-163"><a href="#cb29-163" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chromatographic Peak Detection</span></span>
<span id="cb29-164"><a href="#cb29-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-167"><a href="#cb29-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-168"><a href="#cb29-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb29-169"><a href="#cb29-169" aria-hidden="true" tabindex="-1"></a><span class="co"># Define peak detection parameters (CentWave for high-resolution data)</span></span>
<span id="cb29-170"><a href="#cb29-170" aria-hidden="true" tabindex="-1"></a>cwp <span class="ot">&lt;-</span> <span class="fu">CentWaveParam</span>(</span>
<span id="cb29-171"><a href="#cb29-171" aria-hidden="true" tabindex="-1"></a>  <span class="at">ppm =</span> <span class="dv">20</span>,                  <span class="co"># m/z tolerance in ppm</span></span>
<span id="cb29-172"><a href="#cb29-172" aria-hidden="true" tabindex="-1"></a>  <span class="at">peakwidth =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">20</span>),      <span class="co"># Expected peak width range (seconds)</span></span>
<span id="cb29-173"><a href="#cb29-173" aria-hidden="true" tabindex="-1"></a>  <span class="at">snthresh =</span> <span class="dv">10</span>,             <span class="co"># Signal-to-noise threshold</span></span>
<span id="cb29-174"><a href="#cb29-174" aria-hidden="true" tabindex="-1"></a>  <span class="at">prefilter =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5000</span>),   <span class="co"># Prefilter: min peaks, min intensity</span></span>
<span id="cb29-175"><a href="#cb29-175" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzCenterFun =</span> <span class="st">"wMean"</span>,     <span class="co"># Weighted mean for m/z</span></span>
<span id="cb29-176"><a href="#cb29-176" aria-hidden="true" tabindex="-1"></a>  <span class="at">integrate =</span> <span class="dv">1</span>,             <span class="co"># Integration method</span></span>
<span id="cb29-177"><a href="#cb29-177" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzdiff =</span> <span class="fl">0.01</span>,            <span class="co"># Minimum m/z difference</span></span>
<span id="cb29-178"><a href="#cb29-178" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitgauss =</span> <span class="cn">FALSE</span>,          <span class="co"># Gaussian peak fitting</span></span>
<span id="cb29-179"><a href="#cb29-179" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="dv">1000</span>              <span class="co"># Noise threshold</span></span>
<span id="cb29-180"><a href="#cb29-180" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-181"><a href="#cb29-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-182"><a href="#cb29-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform peak detection</span></span>
<span id="cb29-183"><a href="#cb29-183" aria-hidden="true" tabindex="-1"></a>data_peaks <span class="ot">&lt;-</span> <span class="fu">findChromPeaks</span>(raw_data, <span class="at">param =</span> cwp)</span>
<span id="cb29-184"><a href="#cb29-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-185"><a href="#cb29-185" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of detected peaks</span></span>
<span id="cb29-186"><a href="#cb29-186" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total chromatographic peaks:"</span>, <span class="fu">sum</span>(<span class="fu">chromPeaks</span>(data_peaks)[, <span class="st">"into"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-187"><a href="#cb29-187" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-188"><a href="#cb29-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-189"><a href="#cb29-189" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulated XCMS Workflow</span></span>
<span id="cb29-190"><a href="#cb29-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-191"><a href="#cb29-191" aria-hidden="true" tabindex="-1"></a>For demonstration, let's create a simulated dataset:</span>
<span id="cb29-192"><a href="#cb29-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-195"><a href="#cb29-195" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-196"><a href="#cb29-196" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic metabolomics data for demonstration</span></span>
<span id="cb29-197"><a href="#cb29-197" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb29-198"><a href="#cb29-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-199"><a href="#cb29-199" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate retention times and m/z values for metabolites</span></span>
<span id="cb29-200"><a href="#cb29-200" aria-hidden="true" tabindex="-1"></a>n_metabolites <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb29-201"><a href="#cb29-201" aria-hidden="true" tabindex="-1"></a>metabolite_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-202"><a href="#cb29-202" aria-hidden="true" tabindex="-1"></a>  <span class="at">metabolite_id =</span> <span class="fu">paste0</span>(<span class="st">"Met_"</span>, <span class="dv">1</span><span class="sc">:</span>n_metabolites),</span>
<span id="cb29-203"><a href="#cb29-203" aria-hidden="true" tabindex="-1"></a>  <span class="at">mz =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">100</span>, <span class="dv">800</span>),</span>
<span id="cb29-204"><a href="#cb29-204" aria-hidden="true" tabindex="-1"></a>  <span class="at">rt =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">60</span>, <span class="dv">1200</span>),  <span class="co"># RT in seconds</span></span>
<span id="cb29-205"><a href="#cb29-205" aria-hidden="true" tabindex="-1"></a>  <span class="at">intensity_mean =</span> <span class="fu">rlnorm</span>(n_metabolites, <span class="at">meanlog =</span> <span class="dv">6</span>, <span class="at">sdlog =</span> <span class="dv">1</span>)</span>
<span id="cb29-206"><a href="#cb29-206" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-207"><a href="#cb29-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-208"><a href="#cb29-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample information</span></span>
<span id="cb29-209"><a href="#cb29-209" aria-hidden="true" tabindex="-1"></a>sample_info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-210"><a href="#cb29-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">paste0</span>(<span class="st">"Sample_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb29-211"><a href="#cb29-211" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treatment"</span>), <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb29-212"><a href="#cb29-212" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb29-213"><a href="#cb29-213" aria-hidden="true" tabindex="-1"></a>  <span class="at">injection_order =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb29-214"><a href="#cb29-214" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-215"><a href="#cb29-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-216"><a href="#cb29-216" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate peak intensity matrix</span></span>
<span id="cb29-217"><a href="#cb29-217" aria-hidden="true" tabindex="-1"></a>intensity_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(sample_info), <span class="at">ncol =</span> <span class="fu">nrow</span>(metabolite_data))</span>
<span id="cb29-218"><a href="#cb29-218" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(intensity_matrix) <span class="ot">&lt;-</span> sample_info<span class="sc">$</span>sample_name</span>
<span id="cb29-219"><a href="#cb29-219" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(intensity_matrix) <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>metabolite_id</span>
<span id="cb29-220"><a href="#cb29-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-221"><a href="#cb29-221" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sample_info)) {</span>
<span id="cb29-222"><a href="#cb29-222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(metabolite_data)) {</span>
<span id="cb29-223"><a href="#cb29-223" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add group effect for some metabolites</span></span>
<span id="cb29-224"><a href="#cb29-224" aria-hidden="true" tabindex="-1"></a>    group_effect <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sample_info<span class="sc">$</span>group[i] <span class="sc">==</span> <span class="st">"Treatment"</span> <span class="sc">&amp;</span> j <span class="sc">&lt;=</span> <span class="dv">15</span>, <span class="fl">1.5</span>, <span class="fl">1.0</span>)</span>
<span id="cb29-225"><a href="#cb29-225" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some biological and technical variation</span></span>
<span id="cb29-226"><a href="#cb29-226" aria-hidden="true" tabindex="-1"></a>    intensity_matrix[i, j] <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>intensity_mean[j] <span class="sc">*</span> group_effect <span class="sc">*</span> </span>
<span id="cb29-227"><a href="#cb29-227" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)  <span class="co"># 30% CV</span></span>
<span id="cb29-228"><a href="#cb29-228" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-229"><a href="#cb29-229" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-230"><a href="#cb29-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-231"><a href="#cb29-231" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Created synthetic metabolomics dataset with"</span>, <span class="fu">nrow</span>(sample_info), <span class="st">"samples and"</span>, </span>
<span id="cb29-232"><a href="#cb29-232" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(metabolite_data), <span class="st">"metabolites</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-233"><a href="#cb29-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-234"><a href="#cb29-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-235"><a href="#cb29-235" aria-hidden="true" tabindex="-1"></a><span class="fu">### Peak Quality Assessment</span></span>
<span id="cb29-236"><a href="#cb29-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-239"><a href="#cb29-239" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-240"><a href="#cb29-240" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to assess peak quality</span></span>
<span id="cb29-241"><a href="#cb29-241" aria-hidden="true" tabindex="-1"></a>assess_peak_quality <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, sample_info) {</span>
<span id="cb29-242"><a href="#cb29-242" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate QC metrics</span></span>
<span id="cb29-243"><a href="#cb29-243" aria-hidden="true" tabindex="-1"></a>  quality_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-244"><a href="#cb29-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_id =</span> <span class="fu">colnames</span>(intensity_matrix),</span>
<span id="cb29-245"><a href="#cb29-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-246"><a href="#cb29-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-247"><a href="#cb29-247" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb29-248"><a href="#cb29-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb29-249"><a href="#cb29-249" aria-hidden="true" tabindex="-1"></a>    <span class="at">detection_rate =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb29-250"><a href="#cb29-250" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-251"><a href="#cb29-251" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-252"><a href="#cb29-252" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(quality_metrics)</span>
<span id="cb29-253"><a href="#cb29-253" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-254"><a href="#cb29-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-255"><a href="#cb29-255" aria-hidden="true" tabindex="-1"></a>peak_quality <span class="ot">&lt;-</span> <span class="fu">assess_peak_quality</span>(intensity_matrix, sample_info)</span>
<span id="cb29-256"><a href="#cb29-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-257"><a href="#cb29-257" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize peak quality metrics</span></span>
<span id="cb29-258"><a href="#cb29-258" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(peak_quality, <span class="fu">aes</span>(<span class="at">x =</span> cv_percent)) <span class="sc">+</span></span>
<span id="cb29-259"><a href="#cb29-259" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-260"><a href="#cb29-260" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">30</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb29-261"><a href="#cb29-261" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Coefficient of Variation"</span>,</span>
<span id="cb29-262"><a href="#cb29-262" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red line indicates 30% CV threshold"</span>,</span>
<span id="cb29-263"><a href="#cb29-263" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb29-264"><a href="#cb29-264" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-265"><a href="#cb29-265" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-266"><a href="#cb29-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-267"><a href="#cb29-267" aria-hidden="true" tabindex="-1"></a><span class="fu">### Peak Filtering</span></span>
<span id="cb29-268"><a href="#cb29-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-271"><a href="#cb29-271" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-272"><a href="#cb29-272" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply quality filters</span></span>
<span id="cb29-273"><a href="#cb29-273" aria-hidden="true" tabindex="-1"></a>filter_peaks <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, quality_metrics, </span>
<span id="cb29-274"><a href="#cb29-274" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cv_threshold =</span> <span class="dv">30</span>, </span>
<span id="cb29-275"><a href="#cb29-275" aria-hidden="true" tabindex="-1"></a>                        <span class="at">detection_threshold =</span> <span class="dv">80</span>,</span>
<span id="cb29-276"><a href="#cb29-276" aria-hidden="true" tabindex="-1"></a>                        <span class="at">min_intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb29-277"><a href="#cb29-277" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-278"><a href="#cb29-278" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define filters</span></span>
<span id="cb29-279"><a href="#cb29-279" aria-hidden="true" tabindex="-1"></a>  cv_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>cv_percent <span class="sc">&lt;</span> cv_threshold</span>
<span id="cb29-280"><a href="#cb29-280" aria-hidden="true" tabindex="-1"></a>  detection_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>detection_rate <span class="sc">&gt;=</span> detection_threshold</span>
<span id="cb29-281"><a href="#cb29-281" aria-hidden="true" tabindex="-1"></a>  intensity_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>mean_intensity <span class="sc">&gt;=</span> min_intensity</span>
<span id="cb29-282"><a href="#cb29-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-283"><a href="#cb29-283" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine filters</span></span>
<span id="cb29-284"><a href="#cb29-284" aria-hidden="true" tabindex="-1"></a>  pass_filter <span class="ot">&lt;-</span> cv_filter <span class="sc">&amp;</span> detection_filter <span class="sc">&amp;</span> intensity_filter</span>
<span id="cb29-285"><a href="#cb29-285" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-286"><a href="#cb29-286" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Filtering results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-287"><a href="#cb29-287" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  CV filter:"</span>, <span class="fu">sum</span>(cv_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-288"><a href="#cb29-288" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Detection rate filter:"</span>, <span class="fu">sum</span>(detection_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-289"><a href="#cb29-289" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Intensity filter:"</span>, <span class="fu">sum</span>(intensity_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-290"><a href="#cb29-290" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Combined filter:"</span>, <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-291"><a href="#cb29-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-292"><a href="#cb29-292" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply filter</span></span>
<span id="cb29-293"><a href="#cb29-293" aria-hidden="true" tabindex="-1"></a>  filtered_matrix <span class="ot">&lt;-</span> intensity_matrix[, pass_filter]</span>
<span id="cb29-294"><a href="#cb29-294" aria-hidden="true" tabindex="-1"></a>  filtered_metabolites <span class="ot">&lt;-</span> metabolite_data[pass_filter, ]</span>
<span id="cb29-295"><a href="#cb29-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-296"><a href="#cb29-296" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb29-297"><a href="#cb29-297" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity_matrix =</span> filtered_matrix,</span>
<span id="cb29-298"><a href="#cb29-298" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_data =</span> filtered_metabolites,</span>
<span id="cb29-299"><a href="#cb29-299" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter_summary =</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-300"><a href="#cb29-300" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_features =</span> <span class="fu">ncol</span>(intensity_matrix),</span>
<span id="cb29-301"><a href="#cb29-301" aria-hidden="true" tabindex="-1"></a>      <span class="at">passed_filter =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-302"><a href="#cb29-302" aria-hidden="true" tabindex="-1"></a>      <span class="at">filter_rate =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">ncol</span>(intensity_matrix) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb29-303"><a href="#cb29-303" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-304"><a href="#cb29-304" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-305"><a href="#cb29-305" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-306"><a href="#cb29-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-307"><a href="#cb29-307" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_peaks</span>(intensity_matrix, peak_quality)</span>
<span id="cb29-308"><a href="#cb29-308" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_data<span class="sc">$</span>filter_summary)</span>
<span id="cb29-309"><a href="#cb29-309" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-310"><a href="#cb29-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-311"><a href="#cb29-311" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Normalization and Scaling</span></span>
<span id="cb29-312"><a href="#cb29-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-313"><a href="#cb29-313" aria-hidden="true" tabindex="-1"></a><span class="fu">### Different Normalization Methods</span></span>
<span id="cb29-314"><a href="#cb29-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-317"><a href="#cb29-317" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-318"><a href="#cb29-318" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement various normalization methods</span></span>
<span id="cb29-319"><a href="#cb29-319" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, <span class="at">method =</span> <span class="st">"median"</span>) {</span>
<span id="cb29-320"><a href="#cb29-320" aria-hidden="true" tabindex="-1"></a>  normalized_matrix <span class="ot">&lt;-</span> intensity_matrix</span>
<span id="cb29-321"><a href="#cb29-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-322"><a href="#cb29-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"median"</span>) {</span>
<span id="cb29-323"><a href="#cb29-323" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Median normalization</span></span>
<span id="cb29-324"><a href="#cb29-324" aria-hidden="true" tabindex="-1"></a>    sample_medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-325"><a href="#cb29-325" aria-hidden="true" tabindex="-1"></a>    global_median <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_medians, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-326"><a href="#cb29-326" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_median <span class="sc">/</span> sample_medians</span>
<span id="cb29-327"><a href="#cb29-327" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-328"><a href="#cb29-328" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb29-329"><a href="#cb29-329" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb29-330"><a href="#cb29-330" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-331"><a href="#cb29-331" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-332"><a href="#cb29-332" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"tic"</span>) {</span>
<span id="cb29-333"><a href="#cb29-333" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total ion current normalization</span></span>
<span id="cb29-334"><a href="#cb29-334" aria-hidden="true" tabindex="-1"></a>    sample_sums <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-335"><a href="#cb29-335" aria-hidden="true" tabindex="-1"></a>    global_sum <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_sums, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-336"><a href="#cb29-336" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_sum <span class="sc">/</span> sample_sums</span>
<span id="cb29-337"><a href="#cb29-337" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-338"><a href="#cb29-338" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb29-339"><a href="#cb29-339" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb29-340"><a href="#cb29-340" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-341"><a href="#cb29-341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-342"><a href="#cb29-342" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"quantile"</span>) {</span>
<span id="cb29-343"><a href="#cb29-343" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile normalization (simplified)</span></span>
<span id="cb29-344"><a href="#cb29-344" aria-hidden="true" tabindex="-1"></a>    ranked_data <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, rank, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ties.method =</span> <span class="st">"average"</span>)</span>
<span id="cb29-345"><a href="#cb29-345" aria-hidden="true" tabindex="-1"></a>    sorted_means <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, sort, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-346"><a href="#cb29-346" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-347"><a href="#cb29-347" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(intensity_matrix)) {</span>
<span id="cb29-348"><a href="#cb29-348" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[, i] <span class="ot">&lt;-</span> sorted_means[ranked_data[, i]]</span>
<span id="cb29-349"><a href="#cb29-349" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-350"><a href="#cb29-350" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-351"><a href="#cb29-351" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-352"><a href="#cb29-352" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(normalized_matrix)</span>
<span id="cb29-353"><a href="#cb29-353" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-354"><a href="#cb29-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-355"><a href="#cb29-355" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different normalization methods</span></span>
<span id="cb29-356"><a href="#cb29-356" aria-hidden="true" tabindex="-1"></a>median_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"median"</span>)</span>
<span id="cb29-357"><a href="#cb29-357" aria-hidden="true" tabindex="-1"></a>tic_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"tic"</span>)</span>
<span id="cb29-358"><a href="#cb29-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-359"><a href="#cb29-359" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare normalization effects</span></span>
<span id="cb29-360"><a href="#cb29-360" aria-hidden="true" tabindex="-1"></a>compare_normalization <span class="ot">&lt;-</span> <span class="cf">function</span>(original, normalized, method_name) {</span>
<span id="cb29-361"><a href="#cb29-361" aria-hidden="true" tabindex="-1"></a>  original_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(original, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb29-362"><a href="#cb29-362" aria-hidden="true" tabindex="-1"></a>  normalized_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb29-363"><a href="#cb29-363" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-364"><a href="#cb29-364" aria-hidden="true" tabindex="-1"></a>  comparison_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-365"><a href="#cb29-365" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">rownames</span>(original),</span>
<span id="cb29-366"><a href="#cb29-366" aria-hidden="true" tabindex="-1"></a>    <span class="at">original_cv =</span> original_cv,</span>
<span id="cb29-367"><a href="#cb29-367" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized_cv =</span> normalized_cv,</span>
<span id="cb29-368"><a href="#cb29-368" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> method_name</span>
<span id="cb29-369"><a href="#cb29-369" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-370"><a href="#cb29-370" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-371"><a href="#cb29-371" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(comparison_df)</span>
<span id="cb29-372"><a href="#cb29-372" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-373"><a href="#cb29-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-374"><a href="#cb29-374" aria-hidden="true" tabindex="-1"></a>normalization_comparison <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb29-375"><a href="#cb29-375" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, median_normalized, <span class="st">"Median"</span>),</span>
<span id="cb29-376"><a href="#cb29-376" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, tic_normalized, <span class="st">"TIC"</span>)</span>
<span id="cb29-377"><a href="#cb29-377" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-378"><a href="#cb29-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-379"><a href="#cb29-379" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize normalization effects</span></span>
<span id="cb29-380"><a href="#cb29-380" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(normalization_comparison, <span class="fu">aes</span>(<span class="at">x =</span> original_cv, <span class="at">y =</span> normalized_cv, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb29-381"><a href="#cb29-381" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb29-382"><a href="#cb29-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb29-383"><a href="#cb29-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>method) <span class="sc">+</span></span>
<span id="cb29-384"><a href="#cb29-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Effect of Normalization on Sample CV"</span>,</span>
<span id="cb29-385"><a href="#cb29-385" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Original CV (%)"</span>, <span class="at">y =</span> <span class="st">"Normalized CV (%)"</span>,</span>
<span id="cb29-386"><a href="#cb29-386" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb29-387"><a href="#cb29-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-388"><a href="#cb29-388" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-389"><a href="#cb29-389" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-390"><a href="#cb29-390" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Scaling</span></span>
<span id="cb29-391"><a href="#cb29-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-394"><a href="#cb29-394" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-395"><a href="#cb29-395" aria-hidden="true" tabindex="-1"></a><span class="co"># Different scaling methods</span></span>
<span id="cb29-396"><a href="#cb29-396" aria-hidden="true" tabindex="-1"></a>scale_data <span class="ot">&lt;-</span> <span class="cf">function</span>(normalized_matrix, <span class="at">method =</span> <span class="st">"auto"</span>) {</span>
<span id="cb29-397"><a href="#cb29-397" aria-hidden="true" tabindex="-1"></a>  scaled_matrix <span class="ot">&lt;-</span> normalized_matrix</span>
<span id="cb29-398"><a href="#cb29-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-399"><a href="#cb29-399" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"auto"</span>) {</span>
<span id="cb29-400"><a href="#cb29-400" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Auto-scaling (mean-centering + unit variance)</span></span>
<span id="cb29-401"><a href="#cb29-401" aria-hidden="true" tabindex="-1"></a>    scaled_matrix <span class="ot">&lt;-</span> <span class="fu">scale</span>(normalized_matrix)</span>
<span id="cb29-402"><a href="#cb29-402" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-403"><a href="#cb29-403" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"pareto"</span>) {</span>
<span id="cb29-404"><a href="#cb29-404" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pareto scaling (mean-centering + square root of standard deviation)</span></span>
<span id="cb29-405"><a href="#cb29-405" aria-hidden="true" tabindex="-1"></a>    means <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-406"><a href="#cb29-406" aria-hidden="true" tabindex="-1"></a>    sds <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-407"><a href="#cb29-407" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-408"><a href="#cb29-408" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb29-409"><a href="#cb29-409" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> means[i]) <span class="sc">/</span> <span class="fu">sqrt</span>(sds[i])</span>
<span id="cb29-410"><a href="#cb29-410" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-411"><a href="#cb29-411" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-412"><a href="#cb29-412" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"range"</span>) {</span>
<span id="cb29-413"><a href="#cb29-413" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Range scaling (0-1 normalization)</span></span>
<span id="cb29-414"><a href="#cb29-414" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb29-415"><a href="#cb29-415" aria-hidden="true" tabindex="-1"></a>      min_val <span class="ot">&lt;-</span> <span class="fu">min</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-416"><a href="#cb29-416" aria-hidden="true" tabindex="-1"></a>      max_val <span class="ot">&lt;-</span> <span class="fu">max</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-417"><a href="#cb29-417" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> min_val) <span class="sc">/</span> (max_val <span class="sc">-</span> min_val)</span>
<span id="cb29-418"><a href="#cb29-418" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-419"><a href="#cb29-419" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-420"><a href="#cb29-420" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-421"><a href="#cb29-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scaled_matrix)</span>
<span id="cb29-422"><a href="#cb29-422" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-423"><a href="#cb29-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-424"><a href="#cb29-424" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different scaling methods</span></span>
<span id="cb29-425"><a href="#cb29-425" aria-hidden="true" tabindex="-1"></a>auto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"auto"</span>)</span>
<span id="cb29-426"><a href="#cb29-426" aria-hidden="true" tabindex="-1"></a>pareto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"pareto"</span>)</span>
<span id="cb29-427"><a href="#cb29-427" aria-hidden="true" tabindex="-1"></a>range_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"range"</span>)</span>
<span id="cb29-428"><a href="#cb29-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-429"><a href="#cb29-429" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize scaling effects</span></span>
<span id="cb29-430"><a href="#cb29-430" aria-hidden="true" tabindex="-1"></a>scaling_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-431"><a href="#cb29-431" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature =</span> <span class="fu">rep</span>(<span class="fu">colnames</span>(median_normalized), <span class="dv">3</span>),</span>
<span id="cb29-432"><a href="#cb29-432" aria-hidden="true" tabindex="-1"></a>  <span class="at">variance =</span> <span class="fu">c</span>(</span>
<span id="cb29-433"><a href="#cb29-433" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(auto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-434"><a href="#cb29-434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(pareto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb29-435"><a href="#cb29-435" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(range_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-436"><a href="#cb29-436" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb29-437"><a href="#cb29-437" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Auto"</span>, <span class="st">"Pareto"</span>, <span class="st">"Range"</span>), <span class="at">each =</span> <span class="fu">ncol</span>(median_normalized))</span>
<span id="cb29-438"><a href="#cb29-438" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-439"><a href="#cb29-439" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-440"><a href="#cb29-440" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scaling_comparison, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> variance, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb29-441"><a href="#cb29-441" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-442"><a href="#cb29-442" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb29-443"><a href="#cb29-443" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variance Distribution by Scaling Method"</span>,</span>
<span id="cb29-444"><a href="#cb29-444" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Scaling Method"</span>, <span class="at">y =</span> <span class="st">"Variance (log10 scale)"</span>,</span>
<span id="cb29-445"><a href="#cb29-445" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb29-446"><a href="#cb29-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-447"><a href="#cb29-447" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-448"><a href="#cb29-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-449"><a href="#cb29-449" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multivariate Analysis for Metabolomics</span></span>
<span id="cb29-450"><a href="#cb29-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-451"><a href="#cb29-451" aria-hidden="true" tabindex="-1"></a><span class="fu">### Principal Component Analysis (PCA)</span></span>
<span id="cb29-452"><a href="#cb29-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-455"><a href="#cb29-455" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-456"><a href="#cb29-456" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA on scaled data</span></span>
<span id="cb29-457"><a href="#cb29-457" aria-hidden="true" tabindex="-1"></a>perform_metabolomics_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, sample_info) {</span>
<span id="cb29-458"><a href="#cb29-458" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any NA values</span></span>
<span id="cb29-459"><a href="#cb29-459" aria-hidden="true" tabindex="-1"></a>  clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb29-460"><a href="#cb29-460" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-461"><a href="#cb29-461" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform PCA</span></span>
<span id="cb29-462"><a href="#cb29-462" aria-hidden="true" tabindex="-1"></a>  pca_result <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(clean_matrix, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">scale. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb29-463"><a href="#cb29-463" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-464"><a href="#cb29-464" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract scores</span></span>
<span id="cb29-465"><a href="#cb29-465" aria-hidden="true" tabindex="-1"></a>  pca_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pca_result<span class="sc">$</span>x) <span class="sc">%&gt;%</span></span>
<span id="cb29-466"><a href="#cb29-466" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-467"><a href="#cb29-467" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(clean_matrix),</span>
<span id="cb29-468"><a href="#cb29-468" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)],</span>
<span id="cb29-469"><a href="#cb29-469" aria-hidden="true" tabindex="-1"></a>      <span class="at">batch =</span> <span class="fu">factor</span>(sample_info<span class="sc">$</span>batch[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)])</span>
<span id="cb29-470"><a href="#cb29-470" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-471"><a href="#cb29-471" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-472"><a href="#cb29-472" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate variance explained</span></span>
<span id="cb29-473"><a href="#cb29-473" aria-hidden="true" tabindex="-1"></a>  var_explained <span class="ot">&lt;-</span> (pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb29-474"><a href="#cb29-474" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-475"><a href="#cb29-475" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb29-476"><a href="#cb29-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_result =</span> pca_result,</span>
<span id="cb29-477"><a href="#cb29-477" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> pca_scores,</span>
<span id="cb29-478"><a href="#cb29-478" aria-hidden="true" tabindex="-1"></a>    <span class="at">variance_explained =</span> var_explained</span>
<span id="cb29-479"><a href="#cb29-479" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-480"><a href="#cb29-480" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-481"><a href="#cb29-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-482"><a href="#cb29-482" aria-hidden="true" tabindex="-1"></a>pca_analysis <span class="ot">&lt;-</span> <span class="fu">perform_metabolomics_pca</span>(auto_scaled, sample_info)</span>
<span id="cb29-483"><a href="#cb29-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-484"><a href="#cb29-484" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA scores plot</span></span>
<span id="cb29-485"><a href="#cb29-485" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pca_analysis<span class="sc">$</span>scores, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> group, <span class="at">shape =</span> batch)) <span class="sc">+</span></span>
<span id="cb29-486"><a href="#cb29-486" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb29-487"><a href="#cb29-487" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="fu">aes</span>(<span class="at">group =</span> group), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-488"><a href="#cb29-488" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PCA Scores Plot - Metabolomics Data"</span>,</span>
<span id="cb29-489"><a href="#cb29-489" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"PC1 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">1</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb29-490"><a href="#cb29-490" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"PC2 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">2</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb29-491"><a href="#cb29-491" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Group"</span>, <span class="at">shape =</span> <span class="st">"Batch"</span>) <span class="sc">+</span></span>
<span id="cb29-492"><a href="#cb29-492" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-493"><a href="#cb29-493" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-494"><a href="#cb29-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-495"><a href="#cb29-495" aria-hidden="true" tabindex="-1"></a><span class="fu">### Partial Least Squares Discriminant Analysis (PLS-DA)</span></span>
<span id="cb29-496"><a href="#cb29-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-499"><a href="#cb29-499" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-500"><a href="#cb29-500" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PLS-DA using mixOmics (if available)</span></span>
<span id="cb29-501"><a href="#cb29-501" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb29-502"><a href="#cb29-502" aria-hidden="true" tabindex="-1"></a>  perform_plsda <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, groups) {</span>
<span id="cb29-503"><a href="#cb29-503" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean data</span></span>
<span id="cb29-504"><a href="#cb29-504" aria-hidden="true" tabindex="-1"></a>    clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb29-505"><a href="#cb29-505" aria-hidden="true" tabindex="-1"></a>    clean_groups <span class="ot">&lt;-</span> groups[<span class="fu">complete.cases</span>(scaled_matrix)]</span>
<span id="cb29-506"><a href="#cb29-506" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-507"><a href="#cb29-507" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform PLS-DA</span></span>
<span id="cb29-508"><a href="#cb29-508" aria-hidden="true" tabindex="-1"></a>    plsda_result <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">plsda</span>(clean_matrix, clean_groups, <span class="at">ncomp =</span> <span class="dv">3</span>)</span>
<span id="cb29-509"><a href="#cb29-509" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-510"><a href="#cb29-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(plsda_result)</span>
<span id="cb29-511"><a href="#cb29-511" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-512"><a href="#cb29-512" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-513"><a href="#cb29-513" aria-hidden="true" tabindex="-1"></a>  plsda_analysis <span class="ot">&lt;-</span> <span class="fu">perform_plsda</span>(auto_scaled, sample_info<span class="sc">$</span>group)</span>
<span id="cb29-514"><a href="#cb29-514" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-515"><a href="#cb29-515" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract PLS-DA scores</span></span>
<span id="cb29-516"><a href="#cb29-516" aria-hidden="true" tabindex="-1"></a>  plsda_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(plsda_analysis<span class="sc">$</span>variates<span class="sc">$</span>X) <span class="sc">%&gt;%</span></span>
<span id="cb29-517"><a href="#cb29-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-518"><a href="#cb29-518" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(auto_scaled)[<span class="fu">complete.cases</span>(auto_scaled)],</span>
<span id="cb29-519"><a href="#cb29-519" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">complete.cases</span>(auto_scaled)]</span>
<span id="cb29-520"><a href="#cb29-520" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-521"><a href="#cb29-521" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-522"><a href="#cb29-522" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PLS-DA scores plot</span></span>
<span id="cb29-523"><a href="#cb29-523" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plsda_scores, <span class="fu">aes</span>(<span class="at">x =</span> comp1, <span class="at">y =</span> comp2, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb29-524"><a href="#cb29-524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb29-525"><a href="#cb29-525" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_ellipse</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb29-526"><a href="#cb29-526" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PLS-DA Scores Plot"</span>,</span>
<span id="cb29-527"><a href="#cb29-527" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Component 1"</span>, <span class="at">y =</span> <span class="st">"Component 2"</span>,</span>
<span id="cb29-528"><a href="#cb29-528" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb29-529"><a href="#cb29-529" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb29-530"><a href="#cb29-530" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb29-531"><a href="#cb29-531" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-532"><a href="#cb29-532" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: mixOmics package not available. Skipping PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-533"><a href="#cb29-533" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Install with: BiocManager::install('mixOmics')</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-534"><a href="#cb29-534" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-535"><a href="#cb29-535" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-536"><a href="#cb29-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-537"><a href="#cb29-537" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variable Importance Analysis</span></span>
<span id="cb29-538"><a href="#cb29-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-541"><a href="#cb29-541" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-542"><a href="#cb29-542" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VIP scores (if mixOmics is available and PLS-DA was run)</span></span>
<span id="cb29-543"><a href="#cb29-543" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"plsda_analysis"</span>)) {</span>
<span id="cb29-544"><a href="#cb29-544" aria-hidden="true" tabindex="-1"></a>  calculate_vip <span class="ot">&lt;-</span> <span class="cf">function</span>(plsda_result) {</span>
<span id="cb29-545"><a href="#cb29-545" aria-hidden="true" tabindex="-1"></a>    vip_scores <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">vip</span>(plsda_result)</span>
<span id="cb29-546"><a href="#cb29-546" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-547"><a href="#cb29-547" aria-hidden="true" tabindex="-1"></a>    vip_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-548"><a href="#cb29-548" aria-hidden="true" tabindex="-1"></a>      <span class="at">feature =</span> <span class="fu">rownames</span>(vip_scores),</span>
<span id="cb29-549"><a href="#cb29-549" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp1 =</span> vip_scores[, <span class="dv">1</span>],</span>
<span id="cb29-550"><a href="#cb29-550" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp2 =</span> <span class="cf">if</span>(<span class="fu">ncol</span>(vip_scores) <span class="sc">&gt;</span> <span class="dv">1</span>) vip_scores[, <span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb29-551"><a href="#cb29-551" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-552"><a href="#cb29-552" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-553"><a href="#cb29-553" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vip_data)</span>
<span id="cb29-554"><a href="#cb29-554" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-555"><a href="#cb29-555" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-556"><a href="#cb29-556" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="fu">calculate_vip</span>(plsda_analysis)</span>
<span id="cb29-557"><a href="#cb29-557" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-558"><a href="#cb29-558" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot VIP scores</span></span>
<span id="cb29-559"><a href="#cb29-559" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(vip_scores, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, vip_comp1), <span class="at">y =</span> vip_comp1)) <span class="sc">+</span></span>
<span id="cb29-560"><a href="#cb29-560" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-561"><a href="#cb29-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb29-562"><a href="#cb29-562" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb29-563"><a href="#cb29-563" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variable Importance in Projection (VIP) Scores"</span>,</span>
<span id="cb29-564"><a href="#cb29-564" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Red line indicates VIP &gt; 1 threshold"</span>,</span>
<span id="cb29-565"><a href="#cb29-565" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Features"</span>, <span class="at">y =</span> <span class="st">"VIP Score (Component 1)"</span>) <span class="sc">+</span></span>
<span id="cb29-566"><a href="#cb29-566" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb29-567"><a href="#cb29-567" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb29-568"><a href="#cb29-568" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb29-569"><a href="#cb29-569" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-570"><a href="#cb29-570" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: VIP scores require mixOmics package and successful PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-571"><a href="#cb29-571" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create empty vip_scores object for downstream code</span></span>
<span id="cb29-572"><a href="#cb29-572" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb29-573"><a href="#cb29-573" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-574"><a href="#cb29-574" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-575"><a href="#cb29-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-576"><a href="#cb29-576" aria-hidden="true" tabindex="-1"></a><span class="fu">## Metabolite Identification</span></span>
<span id="cb29-577"><a href="#cb29-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-578"><a href="#cb29-578" aria-hidden="true" tabindex="-1"></a><span class="fu">### Accurate Mass Matching</span></span>
<span id="cb29-579"><a href="#cb29-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-582"><a href="#cb29-582" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-583"><a href="#cb29-583" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for accurate mass matching</span></span>
<span id="cb29-584"><a href="#cb29-584" aria-hidden="true" tabindex="-1"></a>accurate_mass_search <span class="ot">&lt;-</span> <span class="cf">function</span>(query_mz, mass_database, <span class="at">tolerance_ppm =</span> <span class="dv">5</span>) {</span>
<span id="cb29-585"><a href="#cb29-585" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a simple mass database (normally you'd use real databases)</span></span>
<span id="cb29-586"><a href="#cb29-586" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">missing</span>(mass_database)) {</span>
<span id="cb29-587"><a href="#cb29-587" aria-hidden="true" tabindex="-1"></a>    mass_database <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-588"><a href="#cb29-588" aria-hidden="true" tabindex="-1"></a>      <span class="at">compound_name =</span> <span class="fu">c</span>(<span class="st">"Glucose"</span>, <span class="st">"Fructose"</span>, <span class="st">"Sucrose"</span>, <span class="st">"Lactose"</span>, <span class="st">"Maltose"</span>,</span>
<span id="cb29-589"><a href="#cb29-589" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Alanine"</span>, <span class="st">"Glycine"</span>, <span class="st">"Serine"</span>, <span class="st">"Threonine"</span>, <span class="st">"Valine"</span>),</span>
<span id="cb29-590"><a href="#cb29-590" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact_mass =</span> <span class="fu">c</span>(<span class="fl">180.0634</span>, <span class="fl">180.0634</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>,</span>
<span id="cb29-591"><a href="#cb29-591" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">89.0477</span>, <span class="fl">75.0320</span>, <span class="fl">105.0426</span>, <span class="fl">119.0582</span>, <span class="fl">117.0790</span>),</span>
<span id="cb29-592"><a href="#cb29-592" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> <span class="fu">c</span>(<span class="st">"C6H12O6"</span>, <span class="st">"C6H12O6"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>,</span>
<span id="cb29-593"><a href="#cb29-593" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"C3H7NO2"</span>, <span class="st">"C2H5NO2"</span>, <span class="st">"C3H7NO3"</span>, <span class="st">"C4H9NO3"</span>, <span class="st">"C5H11NO2"</span>)</span>
<span id="cb29-594"><a href="#cb29-594" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-595"><a href="#cb29-595" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-596"><a href="#cb29-596" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-597"><a href="#cb29-597" aria-hidden="true" tabindex="-1"></a>  matches <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb29-598"><a href="#cb29-598" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-599"><a href="#cb29-599" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(query_mz)) {</span>
<span id="cb29-600"><a href="#cb29-600" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mass differences</span></span>
<span id="cb29-601"><a href="#cb29-601" aria-hidden="true" tabindex="-1"></a>    mass_diff_ppm <span class="ot">&lt;-</span> <span class="fu">abs</span>(mass_database<span class="sc">$</span>exact_mass <span class="sc">-</span> query_mz[i]) <span class="sc">/</span> query_mz[i] <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb29-602"><a href="#cb29-602" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-603"><a href="#cb29-603" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find matches within tolerance</span></span>
<span id="cb29-604"><a href="#cb29-604" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(mass_diff_ppm <span class="sc">&lt;=</span> tolerance_ppm)</span>
<span id="cb29-605"><a href="#cb29-605" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-606"><a href="#cb29-606" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(match_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-607"><a href="#cb29-607" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> match_idx) {</span>
<span id="cb29-608"><a href="#cb29-608" aria-hidden="true" tabindex="-1"></a>        matches <span class="ot">&lt;-</span> <span class="fu">rbind</span>(matches, <span class="fu">data.frame</span>(</span>
<span id="cb29-609"><a href="#cb29-609" aria-hidden="true" tabindex="-1"></a>          <span class="at">query_mz =</span> query_mz[i],</span>
<span id="cb29-610"><a href="#cb29-610" aria-hidden="true" tabindex="-1"></a>          <span class="at">matched_compound =</span> mass_database<span class="sc">$</span>compound_name[j],</span>
<span id="cb29-611"><a href="#cb29-611" aria-hidden="true" tabindex="-1"></a>          <span class="at">exact_mass =</span> mass_database<span class="sc">$</span>exact_mass[j],</span>
<span id="cb29-612"><a href="#cb29-612" aria-hidden="true" tabindex="-1"></a>          <span class="at">formula =</span> mass_database<span class="sc">$</span>formula[j],</span>
<span id="cb29-613"><a href="#cb29-613" aria-hidden="true" tabindex="-1"></a>          <span class="at">mass_error_ppm =</span> mass_diff_ppm[j]</span>
<span id="cb29-614"><a href="#cb29-614" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb29-615"><a href="#cb29-615" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb29-616"><a href="#cb29-616" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-617"><a href="#cb29-617" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-618"><a href="#cb29-618" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-619"><a href="#cb29-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(matches)</span>
<span id="cb29-620"><a href="#cb29-620" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-621"><a href="#cb29-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-622"><a href="#cb29-622" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform mass matching for significant features</span></span>
<span id="cb29-623"><a href="#cb29-623" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(vip_scores)) {</span>
<span id="cb29-624"><a href="#cb29-624" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> vip_scores<span class="sc">$</span>feature[vip_scores<span class="sc">$</span>vip_comp1 <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb29-625"><a href="#cb29-625" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-626"><a href="#cb29-626" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use alternative method to identify significant features</span></span>
<span id="cb29-627"><a href="#cb29-627" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Based on highest variance across samples</span></span>
<span id="cb29-628"><a href="#cb29-628" aria-hidden="true" tabindex="-1"></a>  feature_variance <span class="ot">&lt;-</span> <span class="fu">apply</span>(filtered_data<span class="sc">$</span>metabolite_data[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">1</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-629"><a href="#cb29-629" aria-hidden="true" tabindex="-1"></a>  top_features_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(feature_variance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">10</span>, <span class="fu">length</span>(feature_variance))]</span>
<span id="cb29-630"><a href="#cb29-630" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id[top_features_idx]</span>
<span id="cb29-631"><a href="#cb29-631" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-632"><a href="#cb29-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-633"><a href="#cb29-633" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(significant_features) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-634"><a href="#cb29-634" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract m/z values for significant features</span></span>
<span id="cb29-635"><a href="#cb29-635" aria-hidden="true" tabindex="-1"></a>  significant_mz <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>mz[</span>
<span id="cb29-636"><a href="#cb29-636" aria-hidden="true" tabindex="-1"></a>    filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id <span class="sc">%in%</span> significant_features</span>
<span id="cb29-637"><a href="#cb29-637" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb29-638"><a href="#cb29-638" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-639"><a href="#cb29-639" aria-hidden="true" tabindex="-1"></a>  mass_matches <span class="ot">&lt;-</span> <span class="fu">accurate_mass_search</span>(significant_mz)</span>
<span id="cb29-640"><a href="#cb29-640" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-641"><a href="#cb29-641" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(mass_matches) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-642"><a href="#cb29-642" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Potential metabolite identifications:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-643"><a href="#cb29-643" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(mass_matches)</span>
<span id="cb29-644"><a href="#cb29-644" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb29-645"><a href="#cb29-645" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No matches found in database</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-646"><a href="#cb29-646" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-647"><a href="#cb29-647" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-648"><a href="#cb29-648" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-649"><a href="#cb29-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-650"><a href="#cb29-650" aria-hidden="true" tabindex="-1"></a><span class="fu">### MS/MS Spectrum Matching</span></span>
<span id="cb29-651"><a href="#cb29-651" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-654"><a href="#cb29-654" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-655"><a href="#cb29-655" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate MS/MS data for demonstration</span></span>
<span id="cb29-656"><a href="#cb29-656" aria-hidden="true" tabindex="-1"></a>simulate_msms_spectrum <span class="ot">&lt;-</span> <span class="cf">function</span>(precursor_mz, <span class="at">intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb29-657"><a href="#cb29-657" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate realistic fragment ions</span></span>
<span id="cb29-658"><a href="#cb29-658" aria-hidden="true" tabindex="-1"></a>  n_fragments <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">1</span>)</span>
<span id="cb29-659"><a href="#cb29-659" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-660"><a href="#cb29-660" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common neutral losses for metabolites</span></span>
<span id="cb29-661"><a href="#cb29-661" aria-hidden="true" tabindex="-1"></a>  neutral_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">18.01</span>, <span class="fl">28.01</span>, <span class="fl">44.00</span>, <span class="fl">46.00</span>, <span class="fl">60.02</span>, <span class="fl">62.00</span>)</span>
<span id="cb29-662"><a href="#cb29-662" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-663"><a href="#cb29-663" aria-hidden="true" tabindex="-1"></a>  fragment_mz <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb29-664"><a href="#cb29-664" aria-hidden="true" tabindex="-1"></a>  fragment_intensity <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb29-665"><a href="#cb29-665" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-666"><a href="#cb29-666" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_fragments) {</span>
<span id="cb29-667"><a href="#cb29-667" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="fu">length</span>(neutral_losses) <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.3</span>) {</span>
<span id="cb29-668"><a href="#cb29-668" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use neutral loss</span></span>
<span id="cb29-669"><a href="#cb29-669" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> precursor_mz <span class="sc">-</span> neutral_losses[i]</span>
<span id="cb29-670"><a href="#cb29-670" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb29-671"><a href="#cb29-671" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Random fragment</span></span>
<span id="cb29-672"><a href="#cb29-672" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">50</span>, precursor_mz <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb29-673"><a href="#cb29-673" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-674"><a href="#cb29-674" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-675"><a href="#cb29-675" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random intensity</span></span>
<span id="cb29-676"><a href="#cb29-676" aria-hidden="true" tabindex="-1"></a>    fragment_intensity[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>) <span class="sc">*</span> intensity</span>
<span id="cb29-677"><a href="#cb29-677" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-678"><a href="#cb29-678" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-679"><a href="#cb29-679" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by m/z</span></span>
<span id="cb29-680"><a href="#cb29-680" aria-hidden="true" tabindex="-1"></a>  order_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(fragment_mz)</span>
<span id="cb29-681"><a href="#cb29-681" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-682"><a href="#cb29-682" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb29-683"><a href="#cb29-683" aria-hidden="true" tabindex="-1"></a>    <span class="at">mz =</span> fragment_mz[order_idx],</span>
<span id="cb29-684"><a href="#cb29-684" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity =</span> fragment_intensity[order_idx]</span>
<span id="cb29-685"><a href="#cb29-685" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb29-686"><a href="#cb29-686" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-687"><a href="#cb29-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-688"><a href="#cb29-688" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example MS/MS spectra</span></span>
<span id="cb29-689"><a href="#cb29-689" aria-hidden="true" tabindex="-1"></a>example_msms <span class="ot">&lt;-</span> <span class="fu">simulate_msms_spectrum</span>(<span class="fl">180.0634</span>)  <span class="co"># Glucose-like spectrum</span></span>
<span id="cb29-690"><a href="#cb29-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-691"><a href="#cb29-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot MS/MS spectrum</span></span>
<span id="cb29-692"><a href="#cb29-692" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_msms, <span class="fu">aes</span>(<span class="at">x =</span> mz, <span class="at">y =</span> intensity)) <span class="sc">+</span></span>
<span id="cb29-693"><a href="#cb29-693" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> mz, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb29-694"><a href="#cb29-694" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb29-695"><a href="#cb29-695" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Simulated MS/MS Spectrum"</span>,</span>
<span id="cb29-696"><a href="#cb29-696" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"m/z"</span>, <span class="at">y =</span> <span class="st">"Relative Intensity"</span>) <span class="sc">+</span></span>
<span id="cb29-697"><a href="#cb29-697" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-698"><a href="#cb29-698" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-699"><a href="#cb29-699" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-700"><a href="#cb29-700" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pathway Analysis</span></span>
<span id="cb29-701"><a href="#cb29-701" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-702"><a href="#cb29-702" aria-hidden="true" tabindex="-1"></a><span class="fu">### Metabolite Set Enrichment</span></span>
<span id="cb29-703"><a href="#cb29-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-706"><a href="#cb29-706" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-707"><a href="#cb29-707" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate pathway database</span></span>
<span id="cb29-708"><a href="#cb29-708" aria-hidden="true" tabindex="-1"></a>create_pathway_database <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb29-709"><a href="#cb29-709" aria-hidden="true" tabindex="-1"></a>  pathways <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb29-710"><a href="#cb29-710" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Glycolysis"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_1"</span>, <span class="st">"Met_3"</span>, <span class="st">"Met_5"</span>, <span class="st">"Met_7"</span>, <span class="st">"Met_9"</span>),</span>
<span id="cb29-711"><a href="#cb29-711" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TCA_Cycle"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_2"</span>, <span class="st">"Met_4"</span>, <span class="st">"Met_6"</span>, <span class="st">"Met_8"</span>, <span class="st">"Met_10"</span>),</span>
<span id="cb29-712"><a href="#cb29-712" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amino_Acid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_11"</span>, <span class="st">"Met_12"</span>, <span class="st">"Met_13"</span>, <span class="st">"Met_14"</span>, <span class="st">"Met_15"</span>),</span>
<span id="cb29-713"><a href="#cb29-713" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lipid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_16"</span>, <span class="st">"Met_17"</span>, <span class="st">"Met_18"</span>, <span class="st">"Met_19"</span>, <span class="st">"Met_20"</span>),</span>
<span id="cb29-714"><a href="#cb29-714" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nucleotide_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_21"</span>, <span class="st">"Met_22"</span>, <span class="st">"Met_23"</span>, <span class="st">"Met_24"</span>, <span class="st">"Met_25"</span>)</span>
<span id="cb29-715"><a href="#cb29-715" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-716"><a href="#cb29-716" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-717"><a href="#cb29-717" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pathways)</span>
<span id="cb29-718"><a href="#cb29-718" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-719"><a href="#cb29-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-720"><a href="#cb29-720" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pathway enrichment</span></span>
<span id="cb29-721"><a href="#cb29-721" aria-hidden="true" tabindex="-1"></a>pathway_enrichment <span class="ot">&lt;-</span> <span class="cf">function</span>(significant_metabolites, pathway_db, total_metabolites) {</span>
<span id="cb29-722"><a href="#cb29-722" aria-hidden="true" tabindex="-1"></a>  enrichment_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb29-723"><a href="#cb29-723" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-724"><a href="#cb29-724" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pathway_name <span class="cf">in</span> <span class="fu">names</span>(pathway_db)) {</span>
<span id="cb29-725"><a href="#cb29-725" aria-hidden="true" tabindex="-1"></a>    pathway_metabolites <span class="ot">&lt;-</span> pathway_db[[pathway_name]]</span>
<span id="cb29-726"><a href="#cb29-726" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-727"><a href="#cb29-727" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overlap</span></span>
<span id="cb29-728"><a href="#cb29-728" aria-hidden="true" tabindex="-1"></a>    overlap <span class="ot">&lt;-</span> <span class="fu">intersect</span>(significant_metabolites, pathway_metabolites)</span>
<span id="cb29-729"><a href="#cb29-729" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-730"><a href="#cb29-730" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate contingency table values</span></span>
<span id="cb29-731"><a href="#cb29-731" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; in pathway</span></span>
<span id="cb29-732"><a href="#cb29-732" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; not in pathway</span></span>
<span id="cb29-733"><a href="#cb29-733" aria-hidden="true" tabindex="-1"></a>    c <span class="ot">&lt;-</span> <span class="fu">length</span>(pathway_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; in pathway</span></span>
<span id="cb29-734"><a href="#cb29-734" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> total_metabolites <span class="sc">-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> </span>
<span id="cb29-735"><a href="#cb29-735" aria-hidden="true" tabindex="-1"></a>         <span class="fu">length</span>(pathway_metabolites) <span class="sc">+</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; not in pathway</span></span>
<span id="cb29-736"><a href="#cb29-736" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-737"><a href="#cb29-737" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure all values are non-negative</span></span>
<span id="cb29-738"><a href="#cb29-738" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">c</span>(a, b, c, d) <span class="sc">&lt;</span> <span class="dv">0</span>)) {</span>
<span id="cb29-739"><a href="#cb29-739" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Skip this pathway if contingency table is invalid</span></span>
<span id="cb29-740"><a href="#cb29-740" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb29-741"><a href="#cb29-741" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-742"><a href="#cb29-742" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-743"><a href="#cb29-743" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fisher's exact test</span></span>
<span id="cb29-744"><a href="#cb29-744" aria-hidden="true" tabindex="-1"></a>    contingency_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(a, b, c, d), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb29-745"><a href="#cb29-745" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-746"><a href="#cb29-746" aria-hidden="true" tabindex="-1"></a>    fisher_test <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb29-747"><a href="#cb29-747" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fisher.test</span>(contingency_table, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb29-748"><a href="#cb29-748" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb29-749"><a href="#cb29-749" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">p.value =</span> <span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">1</span>)</span>
<span id="cb29-750"><a href="#cb29-750" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb29-751"><a href="#cb29-751" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-752"><a href="#cb29-752" aria-hidden="true" tabindex="-1"></a>    enrichment_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(enrichment_results, <span class="fu">data.frame</span>(</span>
<span id="cb29-753"><a href="#cb29-753" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> pathway_name,</span>
<span id="cb29-754"><a href="#cb29-754" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">length</span>(overlap),</span>
<span id="cb29-755"><a href="#cb29-755" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">length</span>(pathway_metabolites),</span>
<span id="cb29-756"><a href="#cb29-756" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">length</span>(significant_metabolites),</span>
<span id="cb29-757"><a href="#cb29-757" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> fisher_test<span class="sc">$</span>p.value,</span>
<span id="cb29-758"><a href="#cb29-758" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">as.numeric</span>(fisher_test<span class="sc">$</span>estimate)</span>
<span id="cb29-759"><a href="#cb29-759" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb29-760"><a href="#cb29-760" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-761"><a href="#cb29-761" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-762"><a href="#cb29-762" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiple testing correction</span></span>
<span id="cb29-763"><a href="#cb29-763" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-764"><a href="#cb29-764" aria-hidden="true" tabindex="-1"></a>    enrichment_results<span class="sc">$</span>p_adjusted <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(enrichment_results<span class="sc">$</span>p_value, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb29-765"><a href="#cb29-765" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(enrichment_results[<span class="fu">order</span>(enrichment_results<span class="sc">$</span>p_value), ])</span>
<span id="cb29-766"><a href="#cb29-766" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb29-767"><a href="#cb29-767" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb29-768"><a href="#cb29-768" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb29-769"><a href="#cb29-769" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb29-770"><a href="#cb29-770" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb29-771"><a href="#cb29-771" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb29-772"><a href="#cb29-772" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb29-773"><a href="#cb29-773" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb29-774"><a href="#cb29-774" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_adjusted =</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb29-775"><a href="#cb29-775" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb29-776"><a href="#cb29-776" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-777"><a href="#cb29-777" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-778"><a href="#cb29-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-779"><a href="#cb29-779" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform enrichment analysis</span></span>
<span id="cb29-780"><a href="#cb29-780" aria-hidden="true" tabindex="-1"></a>pathway_db <span class="ot">&lt;-</span> <span class="fu">create_pathway_database</span>()</span>
<span id="cb29-781"><a href="#cb29-781" aria-hidden="true" tabindex="-1"></a>significant_metabolites <span class="ot">&lt;-</span> significant_features</span>
<span id="cb29-782"><a href="#cb29-782" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-783"><a href="#cb29-783" aria-hidden="true" tabindex="-1"></a>enrichment_results <span class="ot">&lt;-</span> <span class="fu">pathway_enrichment</span>(</span>
<span id="cb29-784"><a href="#cb29-784" aria-hidden="true" tabindex="-1"></a>  significant_metabolites, </span>
<span id="cb29-785"><a href="#cb29-785" aria-hidden="true" tabindex="-1"></a>  pathway_db, </span>
<span id="cb29-786"><a href="#cb29-786" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ncol</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb29-787"><a href="#cb29-787" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-788"><a href="#cb29-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-789"><a href="#cb29-789" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb29-790"><a href="#cb29-790" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(enrichment_results)</span>
<span id="cb29-791"><a href="#cb29-791" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-792"><a href="#cb29-792" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualize enrichment results</span></span>
<span id="cb29-793"><a href="#cb29-793" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(enrichment_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pathway, <span class="sc">-</span><span class="fu">log10</span>(p_value)), </span>
<span id="cb29-794"><a href="#cb29-794" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(p_value))) <span class="sc">+</span></span>
<span id="cb29-795"><a href="#cb29-795" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"coral"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-796"><a href="#cb29-796" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb29-797"><a href="#cb29-797" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb29-798"><a href="#cb29-798" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Pathway Enrichment Analysis"</span>,</span>
<span id="cb29-799"><a href="#cb29-799" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Pathway"</span>, <span class="at">y =</span> <span class="st">"-log10(P-value)"</span>) <span class="sc">+</span></span>
<span id="cb29-800"><a href="#cb29-800" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb29-801"><a href="#cb29-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb29-802"><a href="#cb29-802" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb29-803"><a href="#cb29-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No significant pathway enrichment found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-804"><a href="#cb29-804" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-805"><a href="#cb29-805" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-806"><a href="#cb29-806" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-807"><a href="#cb29-807" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quality Control and Batch Correction</span></span>
<span id="cb29-808"><a href="#cb29-808" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-809"><a href="#cb29-809" aria-hidden="true" tabindex="-1"></a><span class="fu">### QC Sample Analysis</span></span>
<span id="cb29-810"><a href="#cb29-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-813"><a href="#cb29-813" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb29-814"><a href="#cb29-814" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate QC samples</span></span>
<span id="cb29-815"><a href="#cb29-815" aria-hidden="true" tabindex="-1"></a>simulate_qc_samples <span class="ot">&lt;-</span> <span class="cf">function</span>(original_matrix, <span class="at">n_qc =</span> <span class="dv">5</span>) {</span>
<span id="cb29-816"><a href="#cb29-816" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QC samples are typically pooled samples with intermediate values</span></span>
<span id="cb29-817"><a href="#cb29-817" aria-hidden="true" tabindex="-1"></a>  qc_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n_qc, <span class="at">ncol =</span> <span class="fu">ncol</span>(original_matrix))</span>
<span id="cb29-818"><a href="#cb29-818" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"QC_"</span>, <span class="dv">1</span><span class="sc">:</span>n_qc)</span>
<span id="cb29-819"><a href="#cb29-819" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(original_matrix)</span>
<span id="cb29-820"><a href="#cb29-820" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-821"><a href="#cb29-821" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_qc) {</span>
<span id="cb29-822"><a href="#cb29-822" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(original_matrix)) {</span>
<span id="cb29-823"><a href="#cb29-823" aria-hidden="true" tabindex="-1"></a>      <span class="co"># QC intensity as mean of original samples with some variation</span></span>
<span id="cb29-824"><a href="#cb29-824" aria-hidden="true" tabindex="-1"></a>      qc_matrix[i, j] <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_matrix[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> </span>
<span id="cb29-825"><a href="#cb29-825" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)  <span class="co"># 10% variation</span></span>
<span id="cb29-826"><a href="#cb29-826" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb29-827"><a href="#cb29-827" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb29-828"><a href="#cb29-828" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-829"><a href="#cb29-829" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(qc_matrix)</span>
<span id="cb29-830"><a href="#cb29-830" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-831"><a href="#cb29-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-832"><a href="#cb29-832" aria-hidden="true" tabindex="-1"></a>qc_matrix <span class="ot">&lt;-</span> <span class="fu">simulate_qc_samples</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb29-833"><a href="#cb29-833" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-834"><a href="#cb29-834" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate QC stability</span></span>
<span id="cb29-835"><a href="#cb29-835" aria-hidden="true" tabindex="-1"></a>calculate_qc_stability <span class="ot">&lt;-</span> <span class="cf">function</span>(qc_matrix) {</span>
<span id="cb29-836"><a href="#cb29-836" aria-hidden="true" tabindex="-1"></a>  qc_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(qc_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb29-837"><a href="#cb29-837" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-838"><a href="#cb29-838" aria-hidden="true" tabindex="-1"></a>  stability_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-839"><a href="#cb29-839" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature =</span> <span class="fu">names</span>(qc_cv),</span>
<span id="cb29-840"><a href="#cb29-840" aria-hidden="true" tabindex="-1"></a>    <span class="at">qc_cv =</span> qc_cv,</span>
<span id="cb29-841"><a href="#cb29-841" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable =</span> qc_cv <span class="sc">&lt;</span> <span class="dv">20</span>  <span class="co"># 20% CV threshold for stability</span></span>
<span id="cb29-842"><a href="#cb29-842" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-843"><a href="#cb29-843" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-844"><a href="#cb29-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stability_summary)</span>
<span id="cb29-845"><a href="#cb29-845" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-846"><a href="#cb29-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-847"><a href="#cb29-847" aria-hidden="true" tabindex="-1"></a>qc_stability <span class="ot">&lt;-</span> <span class="fu">calculate_qc_stability</span>(qc_matrix)</span>
<span id="cb29-848"><a href="#cb29-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-849"><a href="#cb29-849" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize QC stability</span></span>
<span id="cb29-850"><a href="#cb29-850" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(qc_stability, <span class="fu">aes</span>(<span class="at">x =</span> qc_cv, <span class="at">fill =</span> stable)) <span class="sc">+</span></span>
<span id="cb29-851"><a href="#cb29-851" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb29-852"><a href="#cb29-852" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb29-853"><a href="#cb29-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">20</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb29-854"><a href="#cb29-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QC Sample Stability Assessment"</span>,</span>
<span id="cb29-855"><a href="#cb29-855" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"QC CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb29-856"><a href="#cb29-856" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Stable (CV &lt; 20%)"</span>) <span class="sc">+</span></span>
<span id="cb29-857"><a href="#cb29-857" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb29-858"><a href="#cb29-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-859"><a href="#cb29-859" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percentage of stable features:"</span>, </span>
<span id="cb29-860"><a href="#cb29-860" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">sum</span>(qc_stability<span class="sc">$</span>stable) <span class="sc">/</span> <span class="fu">nrow</span>(qc_stability) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb29-861"><a href="#cb29-861" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb29-862"><a href="#cb29-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-863"><a href="#cb29-863" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb29-864"><a href="#cb29-864" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-865"><a href="#cb29-865" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Process real metabolomics data using XCMS</span>
<span id="cb29-866"><a href="#cb29-866" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Compare different normalization methods on your dataset</span>
<span id="cb29-867"><a href="#cb29-867" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Implement a complete identification workflow using spectral databases</span>
<span id="cb29-868"><a href="#cb29-868" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Perform time-course metabolomics analysis</span>
<span id="cb29-869"><a href="#cb29-869" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Build a metabolomics data processing pipeline with quality control</span>
<span id="cb29-870"><a href="#cb29-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-871"><a href="#cb29-871" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb29-872"><a href="#cb29-872" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-873"><a href="#cb29-873" aria-hidden="true" tabindex="-1"></a>This chapter covered comprehensive metabolomics data analysis workflows, including peak detection, data normalization, multivariate analysis, metabolite identification, and pathway analysis. These methods form the foundation for extracting biological insights from metabolomics experiments.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/vanhungtran/RforMS/edit/main/08-metabolomics-analysis.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vanhungtran/RforMS/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>