<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>7&nbsp; Metabolomics Data Analysis – R for Mass Spectrometry</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./08-proteomics-analysis.html" rel="next">
<link href="./06-statistical-analysis.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e7f797462891c8ff6ba508bfbef652ea.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07-metabolomics-analysis.html"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">R for Mass Spectrometry</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vanhungtran/RforMS" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction to Mass Spectrometry in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-r-fundamentals.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">R Fundamentals for Mass Spectrometry</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-data-formats-import.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Mass Spectrometry Data Formats and Import</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-spectral-preprocessing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Spectral Data Preprocessing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-peak-detection-quantification.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Peak Detection and Quantification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-data-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Data Visualization for Mass Spectrometry</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-statistical-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Statistical Analysis of MS Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-metabolomics-analysis.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08-proteomics-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Proteomics Data Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10-qfeatures-quantitative.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Quantitative Proteomics with QFeatures</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09-advanced-topics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Advanced Topics and Applications</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./summary.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Summary and Future Directions</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setting-up-metabolomics-environment" id="toc-setting-up-metabolomics-environment" class="nav-link active" data-scroll-target="#setting-up-metabolomics-environment"><span class="header-section-number">7.1</span> Setting Up Metabolomics Environment</a></li>
  <li><a href="#understanding-metabolomics-workflows" id="toc-understanding-metabolomics-workflows" class="nav-link" data-scroll-target="#understanding-metabolomics-workflows"><span class="header-section-number">7.2</span> Understanding Metabolomics Workflows</a>
  <ul class="collapse">
  <li><a href="#lc-ms-metabolomics-pipeline" id="toc-lc-ms-metabolomics-pipeline" class="nav-link" data-scroll-target="#lc-ms-metabolomics-pipeline"><span class="header-section-number">7.2.1</span> LC-MS Metabolomics Pipeline</a></li>
  </ul></li>
  <li><a href="#xcms-based-peak-detection" id="toc-xcms-based-peak-detection" class="nav-link" data-scroll-target="#xcms-based-peak-detection"><span class="header-section-number">7.3</span> XCMS-Based Peak Detection</a>
  <ul class="collapse">
  <li><a href="#loading-raw-data" id="toc-loading-raw-data" class="nav-link" data-scroll-target="#loading-raw-data"><span class="header-section-number">7.3.1</span> Loading Raw Data</a></li>
  <li><a href="#chromatographic-peak-detection" id="toc-chromatographic-peak-detection" class="nav-link" data-scroll-target="#chromatographic-peak-detection"><span class="header-section-number">7.3.2</span> Chromatographic Peak Detection</a></li>
  <li><a href="#simulated-xcms-workflow" id="toc-simulated-xcms-workflow" class="nav-link" data-scroll-target="#simulated-xcms-workflow"><span class="header-section-number">7.3.3</span> Simulated XCMS Workflow</a></li>
  <li><a href="#peak-quality-assessment" id="toc-peak-quality-assessment" class="nav-link" data-scroll-target="#peak-quality-assessment"><span class="header-section-number">7.3.4</span> Peak Quality Assessment</a></li>
  <li><a href="#peak-filtering" id="toc-peak-filtering" class="nav-link" data-scroll-target="#peak-filtering"><span class="header-section-number">7.3.5</span> Peak Filtering</a></li>
  </ul></li>
  <li><a href="#data-normalization-and-scaling" id="toc-data-normalization-and-scaling" class="nav-link" data-scroll-target="#data-normalization-and-scaling"><span class="header-section-number">7.4</span> Data Normalization and Scaling</a>
  <ul class="collapse">
  <li><a href="#different-normalization-methods" id="toc-different-normalization-methods" class="nav-link" data-scroll-target="#different-normalization-methods"><span class="header-section-number">7.4.1</span> Different Normalization Methods</a></li>
  <li><a href="#data-scaling" id="toc-data-scaling" class="nav-link" data-scroll-target="#data-scaling"><span class="header-section-number">7.4.2</span> Data Scaling</a></li>
  </ul></li>
  <li><a href="#multivariate-analysis-for-metabolomics" id="toc-multivariate-analysis-for-metabolomics" class="nav-link" data-scroll-target="#multivariate-analysis-for-metabolomics"><span class="header-section-number">7.5</span> Multivariate Analysis for Metabolomics</a>
  <ul class="collapse">
  <li><a href="#principal-component-analysis-pca" id="toc-principal-component-analysis-pca" class="nav-link" data-scroll-target="#principal-component-analysis-pca"><span class="header-section-number">7.5.1</span> Principal Component Analysis (PCA)</a></li>
  <li><a href="#partial-least-squares-discriminant-analysis-pls-da" id="toc-partial-least-squares-discriminant-analysis-pls-da" class="nav-link" data-scroll-target="#partial-least-squares-discriminant-analysis-pls-da"><span class="header-section-number">7.5.2</span> Partial Least Squares Discriminant Analysis (PLS-DA)</a></li>
  <li><a href="#variable-importance-analysis" id="toc-variable-importance-analysis" class="nav-link" data-scroll-target="#variable-importance-analysis"><span class="header-section-number">7.5.3</span> Variable Importance Analysis</a></li>
  </ul></li>
  <li><a href="#metabolite-identification" id="toc-metabolite-identification" class="nav-link" data-scroll-target="#metabolite-identification"><span class="header-section-number">7.6</span> Metabolite Identification</a>
  <ul class="collapse">
  <li><a href="#accurate-mass-matching" id="toc-accurate-mass-matching" class="nav-link" data-scroll-target="#accurate-mass-matching"><span class="header-section-number">7.6.1</span> Accurate Mass Matching</a></li>
  <li><a href="#msms-spectrum-matching" id="toc-msms-spectrum-matching" class="nav-link" data-scroll-target="#msms-spectrum-matching"><span class="header-section-number">7.6.2</span> MS/MS Spectrum Matching</a></li>
  </ul></li>
  <li><a href="#pathway-analysis" id="toc-pathway-analysis" class="nav-link" data-scroll-target="#pathway-analysis"><span class="header-section-number">7.7</span> Pathway Analysis</a>
  <ul class="collapse">
  <li><a href="#metabolite-set-enrichment" id="toc-metabolite-set-enrichment" class="nav-link" data-scroll-target="#metabolite-set-enrichment"><span class="header-section-number">7.7.1</span> Metabolite Set Enrichment</a></li>
  </ul></li>
  <li><a href="#quality-control-and-batch-correction" id="toc-quality-control-and-batch-correction" class="nav-link" data-scroll-target="#quality-control-and-batch-correction"><span class="header-section-number">7.8</span> Quality Control and Batch Correction</a>
  <ul class="collapse">
  <li><a href="#qc-sample-analysis" id="toc-qc-sample-analysis" class="nav-link" data-scroll-target="#qc-sample-analysis"><span class="header-section-number">7.8.1</span> QC Sample Analysis</a></li>
  </ul></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">7.9</span> Exercises</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">7.10</span> Summary</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Metabolomics Data Analysis</span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Metabolomics involves the comprehensive analysis of small molecules (metabolites) in biological systems. This chapter covers LC-MS metabolomics data processing using the R for Mass Spectrometry ecosystem, with emphasis on the <code>xcms</code> package and <code>Spectra</code> integration.</p>
<section id="setting-up-metabolomics-environment" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="setting-up-metabolomics-environment"><span class="header-section-number">7.1</span> Setting Up Metabolomics Environment</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages (with conditional loading for Bioconductor packages)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"xcms"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(xcms)              <span class="co"># LC-MS data processing</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: xcms package not installed. Install with: BiocManager::install('xcms')"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"Spectra"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Spectra)           <span class="co"># Core MS data structures</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: Spectra package not installed. Install with: BiocManager::install('Spectra')"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MetaboCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MetaboCoreUtils)   <span class="co"># Metabolomics utilities</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MsCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MsCoreUtils)       <span class="co"># MS data utilities</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard CRAN packages</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)           <span class="co"># Visualization</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)             <span class="co"># Data manipulation</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)             <span class="co"># Data tidying</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional packages</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"pheatmap"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(pheatmap)</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"patchwork"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(patchwork)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CAMERA"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CAMERA)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CompoundDb"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CompoundDb)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(mixOmics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="understanding-metabolomics-workflows" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="understanding-metabolomics-workflows"><span class="header-section-number">7.2</span> Understanding Metabolomics Workflows</h2>
<section id="lc-ms-metabolomics-pipeline" class="level3" data-number="7.2.1">
<h3 data-number="7.2.1" class="anchored" data-anchor-id="lc-ms-metabolomics-pipeline"><span class="header-section-number">7.2.1</span> LC-MS Metabolomics Pipeline</h3>
<p>A typical untargeted metabolomics workflow consists of:</p>
<ol type="1">
<li><strong>Peak detection</strong>: Identifying features (m/z-RT pairs) across samples</li>
<li><strong>Alignment</strong>: Correcting RT variations between samples</li>
<li><strong>Correspondence</strong>: Matching features across samples</li>
<li><strong>Gap filling</strong>: Integrating missing peaks</li>
<li><strong>Annotation</strong>: Identifying metabolites</li>
<li><strong>Statistical analysis</strong>: Finding differential metabolites</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display workflow overview</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>workflow_steps <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Step =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Process =</span> <span class="fu">c</span>(<span class="st">"Peak Detection"</span>, <span class="st">"Retention Time Correction"</span>, </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Correspondence"</span>, <span class="st">"Gap Filling"</span>, </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Annotation"</span>, <span class="st">"Statistical Analysis"</span>),</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Package =</span> <span class="fu">c</span>(<span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"CAMERA/CompoundDb"</span>, <span class="st">"limma/mixOmics"</span>),</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Output =</span> <span class="fu">c</span>(<span class="st">"Chromatographic peaks"</span>, <span class="st">"Aligned peaks"</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Feature matrix"</span>, <span class="st">"Complete matrix"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Putative IDs"</span>, <span class="st">"Differential metabolites"</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_steps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Step                   Process           Package                   Output
1    1            Peak Detection              xcms    Chromatographic peaks
2    2 Retention Time Correction              xcms            Aligned peaks
3    3            Correspondence              xcms           Feature matrix
4    4               Gap Filling              xcms          Complete matrix
5    5                Annotation CAMERA/CompoundDb             Putative IDs
6    6      Statistical Analysis    limma/mixOmics Differential metabolites</code></pre>
</div>
</div>
</section>
</section>
<section id="xcms-based-peak-detection" class="level2" data-number="7.3">
<h2 data-number="7.3" class="anchored" data-anchor-id="xcms-based-peak-detection"><span class="header-section-number">7.3</span> XCMS-Based Peak Detection</h2>
<section id="loading-raw-data" class="level3" data-number="7.3.1">
<h3 data-number="7.3.1" class="anchored" data-anchor-id="loading-raw-data"><span class="header-section-number">7.3.1</span> Loading Raw Data</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example workflow with real LC-MS data</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raw files (typically multiple mzML files)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>raw_files <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sample1.mzML"</span>, <span class="st">"sample2.mzML"</span>, <span class="st">"sample3.mzML"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create phenotype data</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">basename</span>(raw_files),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_group =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Control"</span>, <span class="st">"Treatment"</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_type =</span> <span class="st">"Sample"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data into an XCMSnExp object</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">readMSData</span>(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> raw_files,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">pdata =</span> <span class="fu">new</span>(<span class="st">"NAnnotatedDataFrame"</span>, pd),</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"onDisk"</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Display data summary</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>raw_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="chromatographic-peak-detection" class="level3" data-number="7.3.2">
<h3 data-number="7.3.2" class="anchored" data-anchor-id="chromatographic-peak-detection"><span class="header-section-number">7.3.2</span> Chromatographic Peak Detection</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define peak detection parameters (CentWave for high-resolution data)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>cwp <span class="ot">&lt;-</span> <span class="fu">CentWaveParam</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">ppm =</span> <span class="dv">20</span>,                  <span class="co"># m/z tolerance in ppm</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">peakwidth =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">20</span>),      <span class="co"># Expected peak width range (seconds)</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">snthresh =</span> <span class="dv">10</span>,             <span class="co"># Signal-to-noise threshold</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">prefilter =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5000</span>),   <span class="co"># Prefilter: min peaks, min intensity</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzCenterFun =</span> <span class="st">"wMean"</span>,     <span class="co"># Weighted mean for m/z</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">integrate =</span> <span class="dv">1</span>,             <span class="co"># Integration method</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzdiff =</span> <span class="fl">0.01</span>,            <span class="co"># Minimum m/z difference</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitgauss =</span> <span class="cn">FALSE</span>,          <span class="co"># Gaussian peak fitting</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="dv">1000</span>              <span class="co"># Noise threshold</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform peak detection</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>data_peaks <span class="ot">&lt;-</span> <span class="fu">findChromPeaks</span>(raw_data, <span class="at">param =</span> cwp)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of detected peaks</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total chromatographic peaks:"</span>, <span class="fu">sum</span>(<span class="fu">chromPeaks</span>(data_peaks)[, <span class="st">"into"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="simulated-xcms-workflow" class="level3" data-number="7.3.3">
<h3 data-number="7.3.3" class="anchored" data-anchor-id="simulated-xcms-workflow"><span class="header-section-number">7.3.3</span> Simulated XCMS Workflow</h3>
<p>For demonstration, let’s create a simulated dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic metabolomics data for demonstration</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate retention times and m/z values for metabolites</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>n_metabolites <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>metabolite_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">metabolite_id =</span> <span class="fu">paste0</span>(<span class="st">"Met_"</span>, <span class="dv">1</span><span class="sc">:</span>n_metabolites),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">mz =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">100</span>, <span class="dv">800</span>),</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">rt =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">60</span>, <span class="dv">1200</span>),  <span class="co"># RT in seconds</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">intensity_mean =</span> <span class="fu">rlnorm</span>(n_metabolites, <span class="at">meanlog =</span> <span class="dv">6</span>, <span class="at">sdlog =</span> <span class="dv">1</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample information</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>sample_info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">paste0</span>(<span class="st">"Sample_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treatment"</span>), <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">injection_order =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate peak intensity matrix</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>intensity_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(sample_info), <span class="at">ncol =</span> <span class="fu">nrow</span>(metabolite_data))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(intensity_matrix) <span class="ot">&lt;-</span> sample_info<span class="sc">$</span>sample_name</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(intensity_matrix) <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>metabolite_id</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sample_info)) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(metabolite_data)) {</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add group effect for some metabolites</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    group_effect <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sample_info<span class="sc">$</span>group[i] <span class="sc">==</span> <span class="st">"Treatment"</span> <span class="sc">&amp;</span> j <span class="sc">&lt;=</span> <span class="dv">15</span>, <span class="fl">1.5</span>, <span class="fl">1.0</span>)</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some biological and technical variation</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    intensity_matrix[i, j] <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>intensity_mean[j] <span class="sc">*</span> group_effect <span class="sc">*</span> </span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)  <span class="co"># 30% CV</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Created synthetic metabolomics dataset with"</span>, <span class="fu">nrow</span>(sample_info), <span class="st">"samples and"</span>, </span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(metabolite_data), <span class="st">"metabolites</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Created synthetic metabolomics dataset with 20 samples and 50 metabolites</code></pre>
</div>
</div>
</section>
<section id="peak-quality-assessment" class="level3" data-number="7.3.4">
<h3 data-number="7.3.4" class="anchored" data-anchor-id="peak-quality-assessment"><span class="header-section-number">7.3.4</span> Peak Quality Assessment</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to assess peak quality</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>assess_peak_quality <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, sample_info) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate QC metrics</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  quality_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_id =</span> <span class="fu">colnames</span>(intensity_matrix),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">detection_rate =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(quality_metrics)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>peak_quality <span class="ot">&lt;-</span> <span class="fu">assess_peak_quality</span>(intensity_matrix, sample_info)</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize peak quality metrics</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(peak_quality, <span class="fu">aes</span>(<span class="at">x =</span> cv_percent)) <span class="sc">+</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">30</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Coefficient of Variation"</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red line indicates 30% CV threshold"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="peak-filtering" class="level3" data-number="7.3.5">
<h3 data-number="7.3.5" class="anchored" data-anchor-id="peak-filtering"><span class="header-section-number">7.3.5</span> Peak Filtering</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply quality filters</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>filter_peaks <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, quality_metrics, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cv_threshold =</span> <span class="dv">30</span>, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">detection_threshold =</span> <span class="dv">80</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">min_intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define filters</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  cv_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>cv_percent <span class="sc">&lt;</span> cv_threshold</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  detection_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>detection_rate <span class="sc">&gt;=</span> detection_threshold</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  intensity_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>mean_intensity <span class="sc">&gt;=</span> min_intensity</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine filters</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  pass_filter <span class="ot">&lt;-</span> cv_filter <span class="sc">&amp;</span> detection_filter <span class="sc">&amp;</span> intensity_filter</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Filtering results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  CV filter:"</span>, <span class="fu">sum</span>(cv_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Detection rate filter:"</span>, <span class="fu">sum</span>(detection_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Intensity filter:"</span>, <span class="fu">sum</span>(intensity_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Combined filter:"</span>, <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply filter</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>  filtered_matrix <span class="ot">&lt;-</span> intensity_matrix[, pass_filter]</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  filtered_metabolites <span class="ot">&lt;-</span> metabolite_data[pass_filter, ]</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity_matrix =</span> filtered_matrix,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_data =</span> filtered_metabolites,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter_summary =</span> <span class="fu">data.frame</span>(</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_features =</span> <span class="fu">ncol</span>(intensity_matrix),</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">passed_filter =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">filter_rate =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">ncol</span>(intensity_matrix) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_peaks</span>(intensity_matrix, peak_quality)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Filtering results:
  CV filter: 21 passed
  Detection rate filter: 50 passed
  Intensity filter: 9 passed
  Combined filter: 4 passed</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_data<span class="sc">$</span>filter_summary)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  total_features passed_filter filter_rate
1             50             4           8</code></pre>
</div>
</div>
</section>
</section>
<section id="data-normalization-and-scaling" class="level2" data-number="7.4">
<h2 data-number="7.4" class="anchored" data-anchor-id="data-normalization-and-scaling"><span class="header-section-number">7.4</span> Data Normalization and Scaling</h2>
<section id="different-normalization-methods" class="level3" data-number="7.4.1">
<h3 data-number="7.4.1" class="anchored" data-anchor-id="different-normalization-methods"><span class="header-section-number">7.4.1</span> Different Normalization Methods</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement various normalization methods</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, <span class="at">method =</span> <span class="st">"median"</span>) {</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  normalized_matrix <span class="ot">&lt;-</span> intensity_matrix</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"median"</span>) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Median normalization</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    sample_medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    global_median <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_medians, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_median <span class="sc">/</span> sample_medians</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"tic"</span>) {</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total ion current normalization</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    sample_sums <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    global_sum <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_sums, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_sum <span class="sc">/</span> sample_sums</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"quantile"</span>) {</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile normalization (simplified)</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    ranked_data <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, rank, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ties.method =</span> <span class="st">"average"</span>)</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    sorted_means <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, sort, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(intensity_matrix)) {</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[, i] <span class="ot">&lt;-</span> sorted_means[ranked_data[, i]]</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(normalized_matrix)</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different normalization methods</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>median_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"median"</span>)</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>tic_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"tic"</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare normalization effects</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>compare_normalization <span class="ot">&lt;-</span> <span class="cf">function</span>(original, normalized, method_name) {</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  original_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(original, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  normalized_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>  comparison_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">rownames</span>(original),</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">original_cv =</span> original_cv,</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized_cv =</span> normalized_cv,</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> method_name</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(comparison_df)</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>normalization_comparison <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, median_normalized, <span class="st">"Median"</span>),</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, tic_normalized, <span class="st">"TIC"</span>)</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize normalization effects</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(normalization_comparison, <span class="fu">aes</span>(<span class="at">x =</span> original_cv, <span class="at">y =</span> normalized_cv, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>method) <span class="sc">+</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Effect of Normalization on Sample CV"</span>,</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Original CV (%)"</span>, <span class="at">y =</span> <span class="st">"Normalized CV (%)"</span>,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="data-scaling" class="level3" data-number="7.4.2">
<h3 data-number="7.4.2" class="anchored" data-anchor-id="data-scaling"><span class="header-section-number">7.4.2</span> Data Scaling</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Different scaling methods</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>scale_data <span class="ot">&lt;-</span> <span class="cf">function</span>(normalized_matrix, <span class="at">method =</span> <span class="st">"auto"</span>) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  scaled_matrix <span class="ot">&lt;-</span> normalized_matrix</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"auto"</span>) {</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Auto-scaling (mean-centering + unit variance)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    scaled_matrix <span class="ot">&lt;-</span> <span class="fu">scale</span>(normalized_matrix)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"pareto"</span>) {</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pareto scaling (mean-centering + square root of standard deviation)</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    means <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    sds <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> means[i]) <span class="sc">/</span> <span class="fu">sqrt</span>(sds[i])</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"range"</span>) {</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Range scaling (0-1 normalization)</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>      min_val <span class="ot">&lt;-</span> <span class="fu">min</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>      max_val <span class="ot">&lt;-</span> <span class="fu">max</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> min_val) <span class="sc">/</span> (max_val <span class="sc">-</span> min_val)</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scaled_matrix)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different scaling methods</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>auto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"auto"</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>pareto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"pareto"</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>range_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"range"</span>)</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize scaling effects</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>scaling_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature =</span> <span class="fu">rep</span>(<span class="fu">colnames</span>(median_normalized), <span class="dv">3</span>),</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">variance =</span> <span class="fu">c</span>(</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(auto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(pareto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(range_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Auto"</span>, <span class="st">"Pareto"</span>, <span class="st">"Range"</span>), <span class="at">each =</span> <span class="fu">ncol</span>(median_normalized))</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scaling_comparison, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> variance, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variance Distribution by Scaling Method"</span>,</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Scaling Method"</span>, <span class="at">y =</span> <span class="st">"Variance (log10 scale)"</span>,</span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="multivariate-analysis-for-metabolomics" class="level2" data-number="7.5">
<h2 data-number="7.5" class="anchored" data-anchor-id="multivariate-analysis-for-metabolomics"><span class="header-section-number">7.5</span> Multivariate Analysis for Metabolomics</h2>
<section id="principal-component-analysis-pca" class="level3" data-number="7.5.1">
<h3 data-number="7.5.1" class="anchored" data-anchor-id="principal-component-analysis-pca"><span class="header-section-number">7.5.1</span> Principal Component Analysis (PCA)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA on scaled data</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>perform_metabolomics_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, sample_info) {</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any NA values</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform PCA</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  pca_result <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(clean_matrix, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">scale. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract scores</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  pca_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pca_result<span class="sc">$</span>x) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(clean_matrix),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)],</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">batch =</span> <span class="fu">factor</span>(sample_info<span class="sc">$</span>batch[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)])</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate variance explained</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>  var_explained <span class="ot">&lt;-</span> (pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_result =</span> pca_result,</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> pca_scores,</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">variance_explained =</span> var_explained</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>pca_analysis <span class="ot">&lt;-</span> <span class="fu">perform_metabolomics_pca</span>(auto_scaled, sample_info)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA scores plot</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pca_analysis<span class="sc">$</span>scores, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> group, <span class="at">shape =</span> batch)) <span class="sc">+</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="fu">aes</span>(<span class="at">group =</span> group), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PCA Scores Plot - Metabolomics Data"</span>,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"PC1 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">1</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"PC2 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">2</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Group"</span>, <span class="at">shape =</span> <span class="st">"Batch"</span>) <span class="sc">+</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="partial-least-squares-discriminant-analysis-pls-da" class="level3" data-number="7.5.2">
<h3 data-number="7.5.2" class="anchored" data-anchor-id="partial-least-squares-discriminant-analysis-pls-da"><span class="header-section-number">7.5.2</span> Partial Least Squares Discriminant Analysis (PLS-DA)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PLS-DA using mixOmics (if available)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  perform_plsda <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, groups) {</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean data</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    clean_groups <span class="ot">&lt;-</span> groups[<span class="fu">complete.cases</span>(scaled_matrix)]</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform PLS-DA</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    plsda_result <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">plsda</span>(clean_matrix, clean_groups, <span class="at">ncomp =</span> <span class="dv">3</span>)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(plsda_result)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  plsda_analysis <span class="ot">&lt;-</span> <span class="fu">perform_plsda</span>(auto_scaled, sample_info<span class="sc">$</span>group)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract PLS-DA scores</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  plsda_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(plsda_analysis<span class="sc">$</span>variates<span class="sc">$</span>X) <span class="sc">%&gt;%</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(auto_scaled)[<span class="fu">complete.cases</span>(auto_scaled)],</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">complete.cases</span>(auto_scaled)]</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PLS-DA scores plot</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plsda_scores, <span class="fu">aes</span>(<span class="at">x =</span> comp1, <span class="at">y =</span> comp2, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_ellipse</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PLS-DA Scores Plot"</span>,</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Component 1"</span>, <span class="at">y =</span> <span class="st">"Component 2"</span>,</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: mixOmics package not available. Skipping PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Install with: BiocManager::install('mixOmics')</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Note: mixOmics package not available. Skipping PLS-DA analysis.
Install with: BiocManager::install('mixOmics')</code></pre>
</div>
</div>
</section>
<section id="variable-importance-analysis" class="level3" data-number="7.5.3">
<h3 data-number="7.5.3" class="anchored" data-anchor-id="variable-importance-analysis"><span class="header-section-number">7.5.3</span> Variable Importance Analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VIP scores (if mixOmics is available and PLS-DA was run)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"plsda_analysis"</span>)) {</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  calculate_vip <span class="ot">&lt;-</span> <span class="cf">function</span>(plsda_result) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    vip_scores <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">vip</span>(plsda_result)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    vip_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">feature =</span> <span class="fu">rownames</span>(vip_scores),</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp1 =</span> vip_scores[, <span class="dv">1</span>],</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp2 =</span> <span class="cf">if</span>(<span class="fu">ncol</span>(vip_scores) <span class="sc">&gt;</span> <span class="dv">1</span>) vip_scores[, <span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vip_data)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="fu">calculate_vip</span>(plsda_analysis)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot VIP scores</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(vip_scores, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, vip_comp1), <span class="at">y =</span> vip_comp1)) <span class="sc">+</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variable Importance in Projection (VIP) Scores"</span>,</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Red line indicates VIP &gt; 1 threshold"</span>,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Features"</span>, <span class="at">y =</span> <span class="st">"VIP Score (Component 1)"</span>) <span class="sc">+</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: VIP scores require mixOmics package and successful PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create empty vip_scores object for downstream code</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Note: VIP scores require mixOmics package and successful PLS-DA analysis.</code></pre>
</div>
</div>
</section>
</section>
<section id="metabolite-identification" class="level2" data-number="7.6">
<h2 data-number="7.6" class="anchored" data-anchor-id="metabolite-identification"><span class="header-section-number">7.6</span> Metabolite Identification</h2>
<section id="accurate-mass-matching" class="level3" data-number="7.6.1">
<h3 data-number="7.6.1" class="anchored" data-anchor-id="accurate-mass-matching"><span class="header-section-number">7.6.1</span> Accurate Mass Matching</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for accurate mass matching</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>accurate_mass_search <span class="ot">&lt;-</span> <span class="cf">function</span>(query_mz, mass_database, <span class="at">tolerance_ppm =</span> <span class="dv">5</span>) {</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a simple mass database (normally you'd use real databases)</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">missing</span>(mass_database)) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    mass_database <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">compound_name =</span> <span class="fu">c</span>(<span class="st">"Glucose"</span>, <span class="st">"Fructose"</span>, <span class="st">"Sucrose"</span>, <span class="st">"Lactose"</span>, <span class="st">"Maltose"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Alanine"</span>, <span class="st">"Glycine"</span>, <span class="st">"Serine"</span>, <span class="st">"Threonine"</span>, <span class="st">"Valine"</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact_mass =</span> <span class="fu">c</span>(<span class="fl">180.0634</span>, <span class="fl">180.0634</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">89.0477</span>, <span class="fl">75.0320</span>, <span class="fl">105.0426</span>, <span class="fl">119.0582</span>, <span class="fl">117.0790</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> <span class="fu">c</span>(<span class="st">"C6H12O6"</span>, <span class="st">"C6H12O6"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"C3H7NO2"</span>, <span class="st">"C2H5NO2"</span>, <span class="st">"C3H7NO3"</span>, <span class="st">"C4H9NO3"</span>, <span class="st">"C5H11NO2"</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  matches <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(query_mz)) {</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mass differences</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    mass_diff_ppm <span class="ot">&lt;-</span> <span class="fu">abs</span>(mass_database<span class="sc">$</span>exact_mass <span class="sc">-</span> query_mz[i]) <span class="sc">/</span> query_mz[i] <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find matches within tolerance</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(mass_diff_ppm <span class="sc">&lt;=</span> tolerance_ppm)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(match_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> match_idx) {</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        matches <span class="ot">&lt;-</span> <span class="fu">rbind</span>(matches, <span class="fu">data.frame</span>(</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>          <span class="at">query_mz =</span> query_mz[i],</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>          <span class="at">matched_compound =</span> mass_database<span class="sc">$</span>compound_name[j],</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>          <span class="at">exact_mass =</span> mass_database<span class="sc">$</span>exact_mass[j],</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>          <span class="at">formula =</span> mass_database<span class="sc">$</span>formula[j],</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>          <span class="at">mass_error_ppm =</span> mass_diff_ppm[j]</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(matches)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform mass matching for significant features</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(vip_scores)) {</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> vip_scores<span class="sc">$</span>feature[vip_scores<span class="sc">$</span>vip_comp1 <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use alternative method to identify significant features</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Based on highest variance across samples</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  feature_variance <span class="ot">&lt;-</span> <span class="fu">apply</span>(filtered_data<span class="sc">$</span>metabolite_data[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">1</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  top_features_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(feature_variance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">10</span>, <span class="fu">length</span>(feature_variance))]</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id[top_features_idx]</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(significant_features) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract m/z values for significant features</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  significant_mz <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>mz[</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id <span class="sc">%in%</span> significant_features</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>  mass_matches <span class="ot">&lt;-</span> <span class="fu">accurate_mass_search</span>(significant_mz)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(mass_matches) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Potential metabolite identifications:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(mass_matches)</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No matches found in database</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>No matches found in database</code></pre>
</div>
</div>
</section>
<section id="msms-spectrum-matching" class="level3" data-number="7.6.2">
<h3 data-number="7.6.2" class="anchored" data-anchor-id="msms-spectrum-matching"><span class="header-section-number">7.6.2</span> MS/MS Spectrum Matching</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate MS/MS data for demonstration</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>simulate_msms_spectrum <span class="ot">&lt;-</span> <span class="cf">function</span>(precursor_mz, <span class="at">intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate realistic fragment ions</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  n_fragments <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">1</span>)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common neutral losses for metabolites</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  neutral_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">18.01</span>, <span class="fl">28.01</span>, <span class="fl">44.00</span>, <span class="fl">46.00</span>, <span class="fl">60.02</span>, <span class="fl">62.00</span>)</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  fragment_mz <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  fragment_intensity <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_fragments) {</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="fu">length</span>(neutral_losses) <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.3</span>) {</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use neutral loss</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> precursor_mz <span class="sc">-</span> neutral_losses[i]</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Random fragment</span></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">50</span>, precursor_mz <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random intensity</span></span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    fragment_intensity[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>) <span class="sc">*</span> intensity</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by m/z</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>  order_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(fragment_mz)</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">mz =</span> fragment_mz[order_idx],</span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity =</span> fragment_intensity[order_idx]</span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example MS/MS spectra</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a>example_msms <span class="ot">&lt;-</span> <span class="fu">simulate_msms_spectrum</span>(<span class="fl">180.0634</span>)  <span class="co"># Glucose-like spectrum</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot MS/MS spectrum</span></span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_msms, <span class="fu">aes</span>(<span class="at">x =</span> mz, <span class="at">y =</span> intensity)) <span class="sc">+</span></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> mz, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Simulated MS/MS Spectrum"</span>,</span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"m/z"</span>, <span class="at">y =</span> <span class="st">"Relative Intensity"</span>) <span class="sc">+</span></span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="pathway-analysis" class="level2" data-number="7.7">
<h2 data-number="7.7" class="anchored" data-anchor-id="pathway-analysis"><span class="header-section-number">7.7</span> Pathway Analysis</h2>
<section id="metabolite-set-enrichment" class="level3" data-number="7.7.1">
<h3 data-number="7.7.1" class="anchored" data-anchor-id="metabolite-set-enrichment"><span class="header-section-number">7.7.1</span> Metabolite Set Enrichment</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate pathway database</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>create_pathway_database <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  pathways <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Glycolysis"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_1"</span>, <span class="st">"Met_3"</span>, <span class="st">"Met_5"</span>, <span class="st">"Met_7"</span>, <span class="st">"Met_9"</span>),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TCA_Cycle"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_2"</span>, <span class="st">"Met_4"</span>, <span class="st">"Met_6"</span>, <span class="st">"Met_8"</span>, <span class="st">"Met_10"</span>),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amino_Acid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_11"</span>, <span class="st">"Met_12"</span>, <span class="st">"Met_13"</span>, <span class="st">"Met_14"</span>, <span class="st">"Met_15"</span>),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lipid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_16"</span>, <span class="st">"Met_17"</span>, <span class="st">"Met_18"</span>, <span class="st">"Met_19"</span>, <span class="st">"Met_20"</span>),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nucleotide_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_21"</span>, <span class="st">"Met_22"</span>, <span class="st">"Met_23"</span>, <span class="st">"Met_24"</span>, <span class="st">"Met_25"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pathways)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pathway enrichment</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>pathway_enrichment <span class="ot">&lt;-</span> <span class="cf">function</span>(significant_metabolites, pathway_db, total_metabolites) {</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  enrichment_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pathway_name <span class="cf">in</span> <span class="fu">names</span>(pathway_db)) {</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    pathway_metabolites <span class="ot">&lt;-</span> pathway_db[[pathway_name]]</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overlap</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    overlap <span class="ot">&lt;-</span> <span class="fu">intersect</span>(significant_metabolites, pathway_metabolites)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate contingency table values</span></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; in pathway</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; not in pathway</span></span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    c <span class="ot">&lt;-</span> <span class="fu">length</span>(pathway_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; in pathway</span></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> total_metabolites <span class="sc">-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> </span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>         <span class="fu">length</span>(pathway_metabolites) <span class="sc">+</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; not in pathway</span></span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure all values are non-negative</span></span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">c</span>(a, b, c, d) <span class="sc">&lt;</span> <span class="dv">0</span>)) {</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Skip this pathway if contingency table is invalid</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fisher's exact test</span></span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a>    contingency_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(a, b, c, d), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>    fisher_test <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fisher.test</span>(contingency_table, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">p.value =</span> <span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">1</span>)</span>
<span id="cb23-44"><a href="#cb23-44" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb23-45"><a href="#cb23-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-46"><a href="#cb23-46" aria-hidden="true" tabindex="-1"></a>    enrichment_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(enrichment_results, <span class="fu">data.frame</span>(</span>
<span id="cb23-47"><a href="#cb23-47" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> pathway_name,</span>
<span id="cb23-48"><a href="#cb23-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">length</span>(overlap),</span>
<span id="cb23-49"><a href="#cb23-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">length</span>(pathway_metabolites),</span>
<span id="cb23-50"><a href="#cb23-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">length</span>(significant_metabolites),</span>
<span id="cb23-51"><a href="#cb23-51" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> fisher_test<span class="sc">$</span>p.value,</span>
<span id="cb23-52"><a href="#cb23-52" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">as.numeric</span>(fisher_test<span class="sc">$</span>estimate)</span>
<span id="cb23-53"><a href="#cb23-53" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb23-54"><a href="#cb23-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-55"><a href="#cb23-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-56"><a href="#cb23-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiple testing correction</span></span>
<span id="cb23-57"><a href="#cb23-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb23-58"><a href="#cb23-58" aria-hidden="true" tabindex="-1"></a>    enrichment_results<span class="sc">$</span>p_adjusted <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(enrichment_results<span class="sc">$</span>p_value, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb23-59"><a href="#cb23-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(enrichment_results[<span class="fu">order</span>(enrichment_results<span class="sc">$</span>p_value), ])</span>
<span id="cb23-60"><a href="#cb23-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb23-61"><a href="#cb23-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb23-62"><a href="#cb23-62" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb23-63"><a href="#cb23-63" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb23-64"><a href="#cb23-64" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb23-65"><a href="#cb23-65" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb23-66"><a href="#cb23-66" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb23-67"><a href="#cb23-67" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb23-68"><a href="#cb23-68" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_adjusted =</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb23-69"><a href="#cb23-69" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb23-70"><a href="#cb23-70" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb23-71"><a href="#cb23-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-72"><a href="#cb23-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-73"><a href="#cb23-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform enrichment analysis</span></span>
<span id="cb23-74"><a href="#cb23-74" aria-hidden="true" tabindex="-1"></a>pathway_db <span class="ot">&lt;-</span> <span class="fu">create_pathway_database</span>()</span>
<span id="cb23-75"><a href="#cb23-75" aria-hidden="true" tabindex="-1"></a>significant_metabolites <span class="ot">&lt;-</span> significant_features</span>
<span id="cb23-76"><a href="#cb23-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-77"><a href="#cb23-77" aria-hidden="true" tabindex="-1"></a>enrichment_results <span class="ot">&lt;-</span> <span class="fu">pathway_enrichment</span>(</span>
<span id="cb23-78"><a href="#cb23-78" aria-hidden="true" tabindex="-1"></a>  significant_metabolites, </span>
<span id="cb23-79"><a href="#cb23-79" aria-hidden="true" tabindex="-1"></a>  pathway_db, </span>
<span id="cb23-80"><a href="#cb23-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ncol</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb23-81"><a href="#cb23-81" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-82"><a href="#cb23-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-83"><a href="#cb23-83" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb23-84"><a href="#cb23-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(enrichment_results)</span>
<span id="cb23-85"><a href="#cb23-85" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-86"><a href="#cb23-86" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualize enrichment results</span></span>
<span id="cb23-87"><a href="#cb23-87" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(enrichment_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pathway, <span class="sc">-</span><span class="fu">log10</span>(p_value)), </span>
<span id="cb23-88"><a href="#cb23-88" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(p_value))) <span class="sc">+</span></span>
<span id="cb23-89"><a href="#cb23-89" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"coral"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb23-90"><a href="#cb23-90" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb23-91"><a href="#cb23-91" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb23-92"><a href="#cb23-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Pathway Enrichment Analysis"</span>,</span>
<span id="cb23-93"><a href="#cb23-93" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Pathway"</span>, <span class="at">y =</span> <span class="st">"-log10(P-value)"</span>) <span class="sc">+</span></span>
<span id="cb23-94"><a href="#cb23-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb23-95"><a href="#cb23-95" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb23-96"><a href="#cb23-96" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb23-97"><a href="#cb23-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No significant pathway enrichment found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb23-98"><a href="#cb23-98" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>No significant pathway enrichment found.</code></pre>
</div>
</div>
</section>
</section>
<section id="quality-control-and-batch-correction" class="level2" data-number="7.8">
<h2 data-number="7.8" class="anchored" data-anchor-id="quality-control-and-batch-correction"><span class="header-section-number">7.8</span> Quality Control and Batch Correction</h2>
<section id="qc-sample-analysis" class="level3" data-number="7.8.1">
<h3 data-number="7.8.1" class="anchored" data-anchor-id="qc-sample-analysis"><span class="header-section-number">7.8.1</span> QC Sample Analysis</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate QC samples</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>simulate_qc_samples <span class="ot">&lt;-</span> <span class="cf">function</span>(original_matrix, <span class="at">n_qc =</span> <span class="dv">5</span>) {</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QC samples are typically pooled samples with intermediate values</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  qc_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n_qc, <span class="at">ncol =</span> <span class="fu">ncol</span>(original_matrix))</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"QC_"</span>, <span class="dv">1</span><span class="sc">:</span>n_qc)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(original_matrix)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_qc) {</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(original_matrix)) {</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>      <span class="co"># QC intensity as mean of original samples with some variation</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>      qc_matrix[i, j] <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_matrix[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> </span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)  <span class="co"># 10% variation</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(qc_matrix)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>qc_matrix <span class="ot">&lt;-</span> <span class="fu">simulate_qc_samples</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate QC stability</span></span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>calculate_qc_stability <span class="ot">&lt;-</span> <span class="cf">function</span>(qc_matrix) {</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>  qc_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(qc_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>  stability_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature =</span> <span class="fu">names</span>(qc_cv),</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">qc_cv =</span> qc_cv,</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable =</span> qc_cv <span class="sc">&lt;</span> <span class="dv">20</span>  <span class="co"># 20% CV threshold for stability</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stability_summary)</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>qc_stability <span class="ot">&lt;-</span> <span class="fu">calculate_qc_stability</span>(qc_matrix)</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize QC stability</span></span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(qc_stability, <span class="fu">aes</span>(<span class="at">x =</span> qc_cv, <span class="at">fill =</span> stable)) <span class="sc">+</span></span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">20</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QC Sample Stability Assessment"</span>,</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"QC CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Stable (CV &lt; 20%)"</span>) <span class="sc">+</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="07-metabolomics-analysis_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percentage of stable features:"</span>, </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">sum</span>(qc_stability<span class="sc">$</span>stable) <span class="sc">/</span> <span class="fu">nrow</span>(qc_stability) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Percentage of stable features: 100 %</code></pre>
</div>
</div>
</section>
</section>
<section id="exercises" class="level2" data-number="7.9">
<h2 data-number="7.9" class="anchored" data-anchor-id="exercises"><span class="header-section-number">7.9</span> Exercises</h2>
<ol type="1">
<li>Process real metabolomics data using XCMS</li>
<li>Compare different normalization methods on your dataset</li>
<li>Implement a complete identification workflow using spectral databases</li>
<li>Perform time-course metabolomics analysis</li>
<li>Build a metabolomics data processing pipeline with quality control</li>
</ol>
</section>
<section id="summary" class="level2" data-number="7.10">
<h2 data-number="7.10" class="anchored" data-anchor-id="summary"><span class="header-section-number">7.10</span> Summary</h2>
<p>This chapter covered comprehensive metabolomics data analysis workflows, including peak detection, data normalization, multivariate analysis, metabolite identification, and pathway analysis. These methods form the foundation for extracting biological insights from metabolomics experiments.</p>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/vanhungtran\.github\.io\/RforMS\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
            // target, if specified
            link.setAttribute("target", "_blank");
            if (link.getAttribute("rel") === null) {
              link.setAttribute("rel", "noopener");
            }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./06-statistical-analysis.html" class="pagination-link" aria-label="Statistical Analysis of MS Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Statistical Analysis of MS Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./08-proteomics-analysis.html" class="pagination-link" aria-label="Proteomics Data Analysis">
        <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Proteomics Data Analysis</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb28" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu"># Metabolomics Data Analysis</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>Metabolomics involves the comprehensive analysis of small molecules (metabolites) in biological systems. This chapter covers LC-MS metabolomics data processing using the R for Mass Spectrometry ecosystem, with emphasis on the <span class="in">`xcms`</span> package and <span class="in">`Spectra`</span> integration.</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="fu">## Setting Up Metabolomics Environment</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="co">#| warning: false</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load required packages (with conditional loading for Bioconductor packages)</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"xcms"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(xcms)              <span class="co"># LC-MS data processing</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: xcms package not installed. Install with: BiocManager::install('xcms')"</span>)</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"Spectra"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(Spectra)           <span class="co"># Core MS data structures</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Note: Spectra package not installed. Install with: BiocManager::install('Spectra')"</span>)</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MetaboCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MetaboCoreUtils)   <span class="co"># Metabolomics utilities</span></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"MsCoreUtils"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(MsCoreUtils)       <span class="co"># MS data utilities</span></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard CRAN packages</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)           <span class="co"># Visualization</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)             <span class="co"># Data manipulation</span></span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)             <span class="co"># Data tidying</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional packages</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"pheatmap"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(pheatmap)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"patchwork"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(patchwork)</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CAMERA"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CAMERA)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"CompoundDb"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(CompoundDb)</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) <span class="fu">library</span>(mixOmics)</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a><span class="fu">## Understanding Metabolomics Workflows</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a><span class="fu">### LC-MS Metabolomics Pipeline</span></span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>A typical untargeted metabolomics workflow consists of:</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Peak detection**: Identifying features (m/z-RT pairs) across samples</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Alignment**: Correcting RT variations between samples</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Correspondence**: Matching features across samples</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Gap filling**: Integrating missing peaks</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Annotation**: Identifying metabolites</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Statistical analysis**: Finding differential metabolites</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Display workflow overview</span></span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>workflow_steps <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">Step =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>,</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">Process =</span> <span class="fu">c</span>(<span class="st">"Peak Detection"</span>, <span class="st">"Retention Time Correction"</span>, </span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Correspondence"</span>, <span class="st">"Gap Filling"</span>, </span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Annotation"</span>, <span class="st">"Statistical Analysis"</span>),</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">Package =</span> <span class="fu">c</span>(<span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, <span class="st">"xcms"</span>, </span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>              <span class="st">"CAMERA/CompoundDb"</span>, <span class="st">"limma/mixOmics"</span>),</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>  <span class="at">Output =</span> <span class="fu">c</span>(<span class="st">"Chromatographic peaks"</span>, <span class="st">"Aligned peaks"</span>,</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Feature matrix"</span>, <span class="st">"Complete matrix"</span>,</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>             <span class="st">"Putative IDs"</span>, <span class="st">"Differential metabolites"</span>)</span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(workflow_steps)</span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a><span class="fu">## XCMS-Based Peak Detection</span></span>
<span id="cb28-80"><a href="#cb28-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-81"><a href="#cb28-81" aria-hidden="true" tabindex="-1"></a><span class="fu">### Loading Raw Data</span></span>
<span id="cb28-82"><a href="#cb28-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-86"><a href="#cb28-86" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-87"><a href="#cb28-87" aria-hidden="true" tabindex="-1"></a><span class="co"># Example workflow with real LC-MS data</span></span>
<span id="cb28-88"><a href="#cb28-88" aria-hidden="true" tabindex="-1"></a><span class="co"># Load raw files (typically multiple mzML files)</span></span>
<span id="cb28-89"><a href="#cb28-89" aria-hidden="true" tabindex="-1"></a>raw_files <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"sample1.mzML"</span>, <span class="st">"sample2.mzML"</span>, <span class="st">"sample3.mzML"</span>)</span>
<span id="cb28-90"><a href="#cb28-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-91"><a href="#cb28-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Create phenotype data</span></span>
<span id="cb28-92"><a href="#cb28-92" aria-hidden="true" tabindex="-1"></a>pd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-93"><a href="#cb28-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">basename</span>(raw_files),</span>
<span id="cb28-94"><a href="#cb28-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_group =</span> <span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Control"</span>, <span class="st">"Treatment"</span>),</span>
<span id="cb28-95"><a href="#cb28-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_type =</span> <span class="st">"Sample"</span>,</span>
<span id="cb28-96"><a href="#cb28-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb28-97"><a href="#cb28-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-98"><a href="#cb28-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-99"><a href="#cb28-99" aria-hidden="true" tabindex="-1"></a><span class="co"># Read data into an XCMSnExp object</span></span>
<span id="cb28-100"><a href="#cb28-100" aria-hidden="true" tabindex="-1"></a>raw_data <span class="ot">&lt;-</span> <span class="fu">readMSData</span>(</span>
<span id="cb28-101"><a href="#cb28-101" aria-hidden="true" tabindex="-1"></a>  <span class="at">files =</span> raw_files,</span>
<span id="cb28-102"><a href="#cb28-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">pdata =</span> <span class="fu">new</span>(<span class="st">"NAnnotatedDataFrame"</span>, pd),</span>
<span id="cb28-103"><a href="#cb28-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">mode =</span> <span class="st">"onDisk"</span></span>
<span id="cb28-104"><a href="#cb28-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-105"><a href="#cb28-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-106"><a href="#cb28-106" aria-hidden="true" tabindex="-1"></a><span class="co"># Display data summary</span></span>
<span id="cb28-107"><a href="#cb28-107" aria-hidden="true" tabindex="-1"></a>raw_data</span>
<span id="cb28-108"><a href="#cb28-108" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-109"><a href="#cb28-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-110"><a href="#cb28-110" aria-hidden="true" tabindex="-1"></a><span class="fu">### Chromatographic Peak Detection</span></span>
<span id="cb28-111"><a href="#cb28-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-114"><a href="#cb28-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-115"><a href="#cb28-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb28-116"><a href="#cb28-116" aria-hidden="true" tabindex="-1"></a><span class="co"># Define peak detection parameters (CentWave for high-resolution data)</span></span>
<span id="cb28-117"><a href="#cb28-117" aria-hidden="true" tabindex="-1"></a>cwp <span class="ot">&lt;-</span> <span class="fu">CentWaveParam</span>(</span>
<span id="cb28-118"><a href="#cb28-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">ppm =</span> <span class="dv">20</span>,                  <span class="co"># m/z tolerance in ppm</span></span>
<span id="cb28-119"><a href="#cb28-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">peakwidth =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">20</span>),      <span class="co"># Expected peak width range (seconds)</span></span>
<span id="cb28-120"><a href="#cb28-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">snthresh =</span> <span class="dv">10</span>,             <span class="co"># Signal-to-noise threshold</span></span>
<span id="cb28-121"><a href="#cb28-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">prefilter =</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5000</span>),   <span class="co"># Prefilter: min peaks, min intensity</span></span>
<span id="cb28-122"><a href="#cb28-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzCenterFun =</span> <span class="st">"wMean"</span>,     <span class="co"># Weighted mean for m/z</span></span>
<span id="cb28-123"><a href="#cb28-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">integrate =</span> <span class="dv">1</span>,             <span class="co"># Integration method</span></span>
<span id="cb28-124"><a href="#cb28-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">mzdiff =</span> <span class="fl">0.01</span>,            <span class="co"># Minimum m/z difference</span></span>
<span id="cb28-125"><a href="#cb28-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">fitgauss =</span> <span class="cn">FALSE</span>,          <span class="co"># Gaussian peak fitting</span></span>
<span id="cb28-126"><a href="#cb28-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">noise =</span> <span class="dv">1000</span>              <span class="co"># Noise threshold</span></span>
<span id="cb28-127"><a href="#cb28-127" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-128"><a href="#cb28-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-129"><a href="#cb28-129" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform peak detection</span></span>
<span id="cb28-130"><a href="#cb28-130" aria-hidden="true" tabindex="-1"></a>data_peaks <span class="ot">&lt;-</span> <span class="fu">findChromPeaks</span>(raw_data, <span class="at">param =</span> cwp)</span>
<span id="cb28-131"><a href="#cb28-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-132"><a href="#cb28-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary of detected peaks</span></span>
<span id="cb28-133"><a href="#cb28-133" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Total chromatographic peaks:"</span>, <span class="fu">sum</span>(<span class="fu">chromPeaks</span>(data_peaks)[, <span class="st">"into"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-134"><a href="#cb28-134" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-135"><a href="#cb28-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-136"><a href="#cb28-136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulated XCMS Workflow</span></span>
<span id="cb28-137"><a href="#cb28-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-138"><a href="#cb28-138" aria-hidden="true" tabindex="-1"></a>For demonstration, let's create a simulated dataset:</span>
<span id="cb28-139"><a href="#cb28-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-142"><a href="#cb28-142" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-143"><a href="#cb28-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Create synthetic metabolomics data for demonstration</span></span>
<span id="cb28-144"><a href="#cb28-144" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb28-145"><a href="#cb28-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-146"><a href="#cb28-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate retention times and m/z values for metabolites</span></span>
<span id="cb28-147"><a href="#cb28-147" aria-hidden="true" tabindex="-1"></a>n_metabolites <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb28-148"><a href="#cb28-148" aria-hidden="true" tabindex="-1"></a>metabolite_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-149"><a href="#cb28-149" aria-hidden="true" tabindex="-1"></a>  <span class="at">metabolite_id =</span> <span class="fu">paste0</span>(<span class="st">"Met_"</span>, <span class="dv">1</span><span class="sc">:</span>n_metabolites),</span>
<span id="cb28-150"><a href="#cb28-150" aria-hidden="true" tabindex="-1"></a>  <span class="at">mz =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">100</span>, <span class="dv">800</span>),</span>
<span id="cb28-151"><a href="#cb28-151" aria-hidden="true" tabindex="-1"></a>  <span class="at">rt =</span> <span class="fu">runif</span>(n_metabolites, <span class="dv">60</span>, <span class="dv">1200</span>),  <span class="co"># RT in seconds</span></span>
<span id="cb28-152"><a href="#cb28-152" aria-hidden="true" tabindex="-1"></a>  <span class="at">intensity_mean =</span> <span class="fu">rlnorm</span>(n_metabolites, <span class="at">meanlog =</span> <span class="dv">6</span>, <span class="at">sdlog =</span> <span class="dv">1</span>)</span>
<span id="cb28-153"><a href="#cb28-153" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-154"><a href="#cb28-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-155"><a href="#cb28-155" aria-hidden="true" tabindex="-1"></a><span class="co"># Create sample information</span></span>
<span id="cb28-156"><a href="#cb28-156" aria-hidden="true" tabindex="-1"></a>sample_info <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-157"><a href="#cb28-157" aria-hidden="true" tabindex="-1"></a>  <span class="at">sample_name =</span> <span class="fu">paste0</span>(<span class="st">"Sample_"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb28-158"><a href="#cb28-158" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Control"</span>, <span class="st">"Treatment"</span>), <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb28-159"><a href="#cb28-159" aria-hidden="true" tabindex="-1"></a>  <span class="at">batch =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, <span class="at">each =</span> <span class="dv">10</span>),</span>
<span id="cb28-160"><a href="#cb28-160" aria-hidden="true" tabindex="-1"></a>  <span class="at">injection_order =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span></span>
<span id="cb28-161"><a href="#cb28-161" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-162"><a href="#cb28-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-163"><a href="#cb28-163" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate peak intensity matrix</span></span>
<span id="cb28-164"><a href="#cb28-164" aria-hidden="true" tabindex="-1"></a>intensity_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> <span class="fu">nrow</span>(sample_info), <span class="at">ncol =</span> <span class="fu">nrow</span>(metabolite_data))</span>
<span id="cb28-165"><a href="#cb28-165" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(intensity_matrix) <span class="ot">&lt;-</span> sample_info<span class="sc">$</span>sample_name</span>
<span id="cb28-166"><a href="#cb28-166" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(intensity_matrix) <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>metabolite_id</span>
<span id="cb28-167"><a href="#cb28-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-168"><a href="#cb28-168" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(sample_info)) {</span>
<span id="cb28-169"><a href="#cb28-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(metabolite_data)) {</span>
<span id="cb28-170"><a href="#cb28-170" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add group effect for some metabolites</span></span>
<span id="cb28-171"><a href="#cb28-171" aria-hidden="true" tabindex="-1"></a>    group_effect <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(sample_info<span class="sc">$</span>group[i] <span class="sc">==</span> <span class="st">"Treatment"</span> <span class="sc">&amp;</span> j <span class="sc">&lt;=</span> <span class="dv">15</span>, <span class="fl">1.5</span>, <span class="fl">1.0</span>)</span>
<span id="cb28-172"><a href="#cb28-172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some biological and technical variation</span></span>
<span id="cb28-173"><a href="#cb28-173" aria-hidden="true" tabindex="-1"></a>    intensity_matrix[i, j] <span class="ot">&lt;-</span> metabolite_data<span class="sc">$</span>intensity_mean[j] <span class="sc">*</span> group_effect <span class="sc">*</span> </span>
<span id="cb28-174"><a href="#cb28-174" aria-hidden="true" tabindex="-1"></a>                              <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.3</span>)  <span class="co"># 30% CV</span></span>
<span id="cb28-175"><a href="#cb28-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-176"><a href="#cb28-176" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-177"><a href="#cb28-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-178"><a href="#cb28-178" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Created synthetic metabolomics dataset with"</span>, <span class="fu">nrow</span>(sample_info), <span class="st">"samples and"</span>, </span>
<span id="cb28-179"><a href="#cb28-179" aria-hidden="true" tabindex="-1"></a>    <span class="fu">nrow</span>(metabolite_data), <span class="st">"metabolites</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-180"><a href="#cb28-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-181"><a href="#cb28-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-182"><a href="#cb28-182" aria-hidden="true" tabindex="-1"></a><span class="fu">### Peak Quality Assessment</span></span>
<span id="cb28-183"><a href="#cb28-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-186"><a href="#cb28-186" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-187"><a href="#cb28-187" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to assess peak quality</span></span>
<span id="cb28-188"><a href="#cb28-188" aria-hidden="true" tabindex="-1"></a>assess_peak_quality <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, sample_info) {</span>
<span id="cb28-189"><a href="#cb28-189" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate QC metrics</span></span>
<span id="cb28-190"><a href="#cb28-190" aria-hidden="true" tabindex="-1"></a>  quality_metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-191"><a href="#cb28-191" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_id =</span> <span class="fu">colnames</span>(intensity_matrix),</span>
<span id="cb28-192"><a href="#cb28-192" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-193"><a href="#cb28-193" aria-hidden="true" tabindex="-1"></a>    <span class="at">median_intensity =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-194"><a href="#cb28-194" aria-hidden="true" tabindex="-1"></a>    <span class="at">cv_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb28-195"><a href="#cb28-195" aria-hidden="true" tabindex="-1"></a>    <span class="at">missing_percent =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>),</span>
<span id="cb28-196"><a href="#cb28-196" aria-hidden="true" tabindex="-1"></a>    <span class="at">detection_rate =</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(x <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">length</span>(x) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb28-197"><a href="#cb28-197" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-198"><a href="#cb28-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-199"><a href="#cb28-199" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(quality_metrics)</span>
<span id="cb28-200"><a href="#cb28-200" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-201"><a href="#cb28-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-202"><a href="#cb28-202" aria-hidden="true" tabindex="-1"></a>peak_quality <span class="ot">&lt;-</span> <span class="fu">assess_peak_quality</span>(intensity_matrix, sample_info)</span>
<span id="cb28-203"><a href="#cb28-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-204"><a href="#cb28-204" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize peak quality metrics</span></span>
<span id="cb28-205"><a href="#cb28-205" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(peak_quality, <span class="fu">aes</span>(<span class="at">x =</span> cv_percent)) <span class="sc">+</span></span>
<span id="cb28-206"><a href="#cb28-206" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">fill =</span> <span class="st">"skyblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb28-207"><a href="#cb28-207" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">30</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb28-208"><a href="#cb28-208" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of Coefficient of Variation"</span>,</span>
<span id="cb28-209"><a href="#cb28-209" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Red line indicates 30% CV threshold"</span>,</span>
<span id="cb28-210"><a href="#cb28-210" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb28-211"><a href="#cb28-211" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-212"><a href="#cb28-212" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-213"><a href="#cb28-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-214"><a href="#cb28-214" aria-hidden="true" tabindex="-1"></a><span class="fu">### Peak Filtering</span></span>
<span id="cb28-215"><a href="#cb28-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-218"><a href="#cb28-218" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-219"><a href="#cb28-219" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply quality filters</span></span>
<span id="cb28-220"><a href="#cb28-220" aria-hidden="true" tabindex="-1"></a>filter_peaks <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, quality_metrics, </span>
<span id="cb28-221"><a href="#cb28-221" aria-hidden="true" tabindex="-1"></a>                        <span class="at">cv_threshold =</span> <span class="dv">30</span>, </span>
<span id="cb28-222"><a href="#cb28-222" aria-hidden="true" tabindex="-1"></a>                        <span class="at">detection_threshold =</span> <span class="dv">80</span>,</span>
<span id="cb28-223"><a href="#cb28-223" aria-hidden="true" tabindex="-1"></a>                        <span class="at">min_intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb28-224"><a href="#cb28-224" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-225"><a href="#cb28-225" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define filters</span></span>
<span id="cb28-226"><a href="#cb28-226" aria-hidden="true" tabindex="-1"></a>  cv_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>cv_percent <span class="sc">&lt;</span> cv_threshold</span>
<span id="cb28-227"><a href="#cb28-227" aria-hidden="true" tabindex="-1"></a>  detection_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>detection_rate <span class="sc">&gt;=</span> detection_threshold</span>
<span id="cb28-228"><a href="#cb28-228" aria-hidden="true" tabindex="-1"></a>  intensity_filter <span class="ot">&lt;-</span> quality_metrics<span class="sc">$</span>mean_intensity <span class="sc">&gt;=</span> min_intensity</span>
<span id="cb28-229"><a href="#cb28-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-230"><a href="#cb28-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine filters</span></span>
<span id="cb28-231"><a href="#cb28-231" aria-hidden="true" tabindex="-1"></a>  pass_filter <span class="ot">&lt;-</span> cv_filter <span class="sc">&amp;</span> detection_filter <span class="sc">&amp;</span> intensity_filter</span>
<span id="cb28-232"><a href="#cb28-232" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-233"><a href="#cb28-233" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Filtering results:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-234"><a href="#cb28-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  CV filter:"</span>, <span class="fu">sum</span>(cv_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-235"><a href="#cb28-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Detection rate filter:"</span>, <span class="fu">sum</span>(detection_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-236"><a href="#cb28-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Intensity filter:"</span>, <span class="fu">sum</span>(intensity_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-237"><a href="#cb28-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  Combined filter:"</span>, <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"passed</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-238"><a href="#cb28-238" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-239"><a href="#cb28-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Apply filter</span></span>
<span id="cb28-240"><a href="#cb28-240" aria-hidden="true" tabindex="-1"></a>  filtered_matrix <span class="ot">&lt;-</span> intensity_matrix[, pass_filter]</span>
<span id="cb28-241"><a href="#cb28-241" aria-hidden="true" tabindex="-1"></a>  filtered_metabolites <span class="ot">&lt;-</span> metabolite_data[pass_filter, ]</span>
<span id="cb28-242"><a href="#cb28-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-243"><a href="#cb28-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb28-244"><a href="#cb28-244" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity_matrix =</span> filtered_matrix,</span>
<span id="cb28-245"><a href="#cb28-245" aria-hidden="true" tabindex="-1"></a>    <span class="at">metabolite_data =</span> filtered_metabolites,</span>
<span id="cb28-246"><a href="#cb28-246" aria-hidden="true" tabindex="-1"></a>    <span class="at">filter_summary =</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-247"><a href="#cb28-247" aria-hidden="true" tabindex="-1"></a>      <span class="at">total_features =</span> <span class="fu">ncol</span>(intensity_matrix),</span>
<span id="cb28-248"><a href="#cb28-248" aria-hidden="true" tabindex="-1"></a>      <span class="at">passed_filter =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-249"><a href="#cb28-249" aria-hidden="true" tabindex="-1"></a>      <span class="at">filter_rate =</span> <span class="fu">sum</span>(pass_filter, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">ncol</span>(intensity_matrix) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb28-250"><a href="#cb28-250" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-251"><a href="#cb28-251" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-252"><a href="#cb28-252" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-253"><a href="#cb28-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-254"><a href="#cb28-254" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="ot">&lt;-</span> <span class="fu">filter_peaks</span>(intensity_matrix, peak_quality)</span>
<span id="cb28-255"><a href="#cb28-255" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered_data<span class="sc">$</span>filter_summary)</span>
<span id="cb28-256"><a href="#cb28-256" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-257"><a href="#cb28-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-258"><a href="#cb28-258" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Normalization and Scaling</span></span>
<span id="cb28-259"><a href="#cb28-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-260"><a href="#cb28-260" aria-hidden="true" tabindex="-1"></a><span class="fu">### Different Normalization Methods</span></span>
<span id="cb28-261"><a href="#cb28-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-264"><a href="#cb28-264" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-265"><a href="#cb28-265" aria-hidden="true" tabindex="-1"></a><span class="co"># Implement various normalization methods</span></span>
<span id="cb28-266"><a href="#cb28-266" aria-hidden="true" tabindex="-1"></a>normalize_data <span class="ot">&lt;-</span> <span class="cf">function</span>(intensity_matrix, <span class="at">method =</span> <span class="st">"median"</span>) {</span>
<span id="cb28-267"><a href="#cb28-267" aria-hidden="true" tabindex="-1"></a>  normalized_matrix <span class="ot">&lt;-</span> intensity_matrix</span>
<span id="cb28-268"><a href="#cb28-268" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-269"><a href="#cb28-269" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"median"</span>) {</span>
<span id="cb28-270"><a href="#cb28-270" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Median normalization</span></span>
<span id="cb28-271"><a href="#cb28-271" aria-hidden="true" tabindex="-1"></a>    sample_medians <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, median, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-272"><a href="#cb28-272" aria-hidden="true" tabindex="-1"></a>    global_median <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_medians, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-273"><a href="#cb28-273" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_median <span class="sc">/</span> sample_medians</span>
<span id="cb28-274"><a href="#cb28-274" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-275"><a href="#cb28-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb28-276"><a href="#cb28-276" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb28-277"><a href="#cb28-277" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-278"><a href="#cb28-278" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-279"><a href="#cb28-279" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"tic"</span>) {</span>
<span id="cb28-280"><a href="#cb28-280" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Total ion current normalization</span></span>
<span id="cb28-281"><a href="#cb28-281" aria-hidden="true" tabindex="-1"></a>    sample_sums <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">1</span>, sum, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-282"><a href="#cb28-282" aria-hidden="true" tabindex="-1"></a>    global_sum <span class="ot">&lt;-</span> <span class="fu">median</span>(sample_sums, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-283"><a href="#cb28-283" aria-hidden="true" tabindex="-1"></a>    normalization_factors <span class="ot">&lt;-</span> global_sum <span class="sc">/</span> sample_sums</span>
<span id="cb28-284"><a href="#cb28-284" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-285"><a href="#cb28-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(intensity_matrix)) {</span>
<span id="cb28-286"><a href="#cb28-286" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[i, ] <span class="ot">&lt;-</span> intensity_matrix[i, ] <span class="sc">*</span> normalization_factors[i]</span>
<span id="cb28-287"><a href="#cb28-287" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-288"><a href="#cb28-288" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-289"><a href="#cb28-289" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"quantile"</span>) {</span>
<span id="cb28-290"><a href="#cb28-290" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Quantile normalization (simplified)</span></span>
<span id="cb28-291"><a href="#cb28-291" aria-hidden="true" tabindex="-1"></a>    ranked_data <span class="ot">&lt;-</span> <span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, rank, <span class="at">na.rm =</span> <span class="cn">TRUE</span>, <span class="at">ties.method =</span> <span class="st">"average"</span>)</span>
<span id="cb28-292"><a href="#cb28-292" aria-hidden="true" tabindex="-1"></a>    sorted_means <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">apply</span>(intensity_matrix, <span class="dv">2</span>, sort, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="dv">1</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-293"><a href="#cb28-293" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-294"><a href="#cb28-294" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(intensity_matrix)) {</span>
<span id="cb28-295"><a href="#cb28-295" aria-hidden="true" tabindex="-1"></a>      normalized_matrix[, i] <span class="ot">&lt;-</span> sorted_means[ranked_data[, i]]</span>
<span id="cb28-296"><a href="#cb28-296" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-297"><a href="#cb28-297" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-298"><a href="#cb28-298" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-299"><a href="#cb28-299" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(normalized_matrix)</span>
<span id="cb28-300"><a href="#cb28-300" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-301"><a href="#cb28-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-302"><a href="#cb28-302" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different normalization methods</span></span>
<span id="cb28-303"><a href="#cb28-303" aria-hidden="true" tabindex="-1"></a>median_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"median"</span>)</span>
<span id="cb28-304"><a href="#cb28-304" aria-hidden="true" tabindex="-1"></a>tic_normalized <span class="ot">&lt;-</span> <span class="fu">normalize_data</span>(filtered_data<span class="sc">$</span>intensity_matrix, <span class="st">"tic"</span>)</span>
<span id="cb28-305"><a href="#cb28-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-306"><a href="#cb28-306" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare normalization effects</span></span>
<span id="cb28-307"><a href="#cb28-307" aria-hidden="true" tabindex="-1"></a>compare_normalization <span class="ot">&lt;-</span> <span class="cf">function</span>(original, normalized, method_name) {</span>
<span id="cb28-308"><a href="#cb28-308" aria-hidden="true" tabindex="-1"></a>  original_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(original, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb28-309"><a href="#cb28-309" aria-hidden="true" tabindex="-1"></a>  normalized_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb28-310"><a href="#cb28-310" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-311"><a href="#cb28-311" aria-hidden="true" tabindex="-1"></a>  comparison_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-312"><a href="#cb28-312" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample =</span> <span class="fu">rownames</span>(original),</span>
<span id="cb28-313"><a href="#cb28-313" aria-hidden="true" tabindex="-1"></a>    <span class="at">original_cv =</span> original_cv,</span>
<span id="cb28-314"><a href="#cb28-314" aria-hidden="true" tabindex="-1"></a>    <span class="at">normalized_cv =</span> normalized_cv,</span>
<span id="cb28-315"><a href="#cb28-315" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> method_name</span>
<span id="cb28-316"><a href="#cb28-316" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-317"><a href="#cb28-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-318"><a href="#cb28-318" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(comparison_df)</span>
<span id="cb28-319"><a href="#cb28-319" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-320"><a href="#cb28-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-321"><a href="#cb28-321" aria-hidden="true" tabindex="-1"></a>normalization_comparison <span class="ot">&lt;-</span> <span class="fu">rbind</span>(</span>
<span id="cb28-322"><a href="#cb28-322" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, median_normalized, <span class="st">"Median"</span>),</span>
<span id="cb28-323"><a href="#cb28-323" aria-hidden="true" tabindex="-1"></a>  <span class="fu">compare_normalization</span>(filtered_data<span class="sc">$</span>intensity_matrix, tic_normalized, <span class="st">"TIC"</span>)</span>
<span id="cb28-324"><a href="#cb28-324" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-325"><a href="#cb28-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-326"><a href="#cb28-326" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize normalization effects</span></span>
<span id="cb28-327"><a href="#cb28-327" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(normalization_comparison, <span class="fu">aes</span>(<span class="at">x =</span> original_cv, <span class="at">y =</span> normalized_cv, <span class="at">color =</span> method)) <span class="sc">+</span></span>
<span id="cb28-328"><a href="#cb28-328" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-329"><a href="#cb28-329" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb28-330"><a href="#cb28-330" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>method) <span class="sc">+</span></span>
<span id="cb28-331"><a href="#cb28-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Effect of Normalization on Sample CV"</span>,</span>
<span id="cb28-332"><a href="#cb28-332" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Original CV (%)"</span>, <span class="at">y =</span> <span class="st">"Normalized CV (%)"</span>,</span>
<span id="cb28-333"><a href="#cb28-333" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb28-334"><a href="#cb28-334" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-335"><a href="#cb28-335" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-336"><a href="#cb28-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-337"><a href="#cb28-337" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Scaling</span></span>
<span id="cb28-338"><a href="#cb28-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-341"><a href="#cb28-341" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-342"><a href="#cb28-342" aria-hidden="true" tabindex="-1"></a><span class="co"># Different scaling methods</span></span>
<span id="cb28-343"><a href="#cb28-343" aria-hidden="true" tabindex="-1"></a>scale_data <span class="ot">&lt;-</span> <span class="cf">function</span>(normalized_matrix, <span class="at">method =</span> <span class="st">"auto"</span>) {</span>
<span id="cb28-344"><a href="#cb28-344" aria-hidden="true" tabindex="-1"></a>  scaled_matrix <span class="ot">&lt;-</span> normalized_matrix</span>
<span id="cb28-345"><a href="#cb28-345" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-346"><a href="#cb28-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"auto"</span>) {</span>
<span id="cb28-347"><a href="#cb28-347" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Auto-scaling (mean-centering + unit variance)</span></span>
<span id="cb28-348"><a href="#cb28-348" aria-hidden="true" tabindex="-1"></a>    scaled_matrix <span class="ot">&lt;-</span> <span class="fu">scale</span>(normalized_matrix)</span>
<span id="cb28-349"><a href="#cb28-349" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-350"><a href="#cb28-350" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"pareto"</span>) {</span>
<span id="cb28-351"><a href="#cb28-351" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Pareto scaling (mean-centering + square root of standard deviation)</span></span>
<span id="cb28-352"><a href="#cb28-352" aria-hidden="true" tabindex="-1"></a>    means <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, mean, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-353"><a href="#cb28-353" aria-hidden="true" tabindex="-1"></a>    sds <span class="ot">&lt;-</span> <span class="fu">apply</span>(normalized_matrix, <span class="dv">2</span>, sd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-354"><a href="#cb28-354" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-355"><a href="#cb28-355" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb28-356"><a href="#cb28-356" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> means[i]) <span class="sc">/</span> <span class="fu">sqrt</span>(sds[i])</span>
<span id="cb28-357"><a href="#cb28-357" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-358"><a href="#cb28-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-359"><a href="#cb28-359" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (method <span class="sc">==</span> <span class="st">"range"</span>) {</span>
<span id="cb28-360"><a href="#cb28-360" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Range scaling (0-1 normalization)</span></span>
<span id="cb28-361"><a href="#cb28-361" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(normalized_matrix)) {</span>
<span id="cb28-362"><a href="#cb28-362" aria-hidden="true" tabindex="-1"></a>      min_val <span class="ot">&lt;-</span> <span class="fu">min</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-363"><a href="#cb28-363" aria-hidden="true" tabindex="-1"></a>      max_val <span class="ot">&lt;-</span> <span class="fu">max</span>(normalized_matrix[, i], <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-364"><a href="#cb28-364" aria-hidden="true" tabindex="-1"></a>      scaled_matrix[, i] <span class="ot">&lt;-</span> (normalized_matrix[, i] <span class="sc">-</span> min_val) <span class="sc">/</span> (max_val <span class="sc">-</span> min_val)</span>
<span id="cb28-365"><a href="#cb28-365" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-366"><a href="#cb28-366" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-367"><a href="#cb28-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-368"><a href="#cb28-368" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(scaled_matrix)</span>
<span id="cb28-369"><a href="#cb28-369" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-370"><a href="#cb28-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-371"><a href="#cb28-371" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply different scaling methods</span></span>
<span id="cb28-372"><a href="#cb28-372" aria-hidden="true" tabindex="-1"></a>auto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"auto"</span>)</span>
<span id="cb28-373"><a href="#cb28-373" aria-hidden="true" tabindex="-1"></a>pareto_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"pareto"</span>)</span>
<span id="cb28-374"><a href="#cb28-374" aria-hidden="true" tabindex="-1"></a>range_scaled <span class="ot">&lt;-</span> <span class="fu">scale_data</span>(median_normalized, <span class="st">"range"</span>)</span>
<span id="cb28-375"><a href="#cb28-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-376"><a href="#cb28-376" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize scaling effects</span></span>
<span id="cb28-377"><a href="#cb28-377" aria-hidden="true" tabindex="-1"></a>scaling_comparison <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-378"><a href="#cb28-378" aria-hidden="true" tabindex="-1"></a>  <span class="at">feature =</span> <span class="fu">rep</span>(<span class="fu">colnames</span>(median_normalized), <span class="dv">3</span>),</span>
<span id="cb28-379"><a href="#cb28-379" aria-hidden="true" tabindex="-1"></a>  <span class="at">variance =</span> <span class="fu">c</span>(</span>
<span id="cb28-380"><a href="#cb28-380" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(auto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-381"><a href="#cb28-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(pareto_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb28-382"><a href="#cb28-382" aria-hidden="true" tabindex="-1"></a>    <span class="fu">apply</span>(range_scaled, <span class="dv">2</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-383"><a href="#cb28-383" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-384"><a href="#cb28-384" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"Auto"</span>, <span class="st">"Pareto"</span>, <span class="st">"Range"</span>), <span class="at">each =</span> <span class="fu">ncol</span>(median_normalized))</span>
<span id="cb28-385"><a href="#cb28-385" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-386"><a href="#cb28-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-387"><a href="#cb28-387" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(scaling_comparison, <span class="fu">aes</span>(<span class="at">x =</span> method, <span class="at">y =</span> variance, <span class="at">fill =</span> method)) <span class="sc">+</span></span>
<span id="cb28-388"><a href="#cb28-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb28-389"><a href="#cb28-389" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>() <span class="sc">+</span></span>
<span id="cb28-390"><a href="#cb28-390" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variance Distribution by Scaling Method"</span>,</span>
<span id="cb28-391"><a href="#cb28-391" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Scaling Method"</span>, <span class="at">y =</span> <span class="st">"Variance (log10 scale)"</span>,</span>
<span id="cb28-392"><a href="#cb28-392" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Method"</span>) <span class="sc">+</span></span>
<span id="cb28-393"><a href="#cb28-393" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-394"><a href="#cb28-394" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-395"><a href="#cb28-395" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-396"><a href="#cb28-396" aria-hidden="true" tabindex="-1"></a><span class="fu">## Multivariate Analysis for Metabolomics</span></span>
<span id="cb28-397"><a href="#cb28-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-398"><a href="#cb28-398" aria-hidden="true" tabindex="-1"></a><span class="fu">### Principal Component Analysis (PCA)</span></span>
<span id="cb28-399"><a href="#cb28-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-402"><a href="#cb28-402" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-403"><a href="#cb28-403" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PCA on scaled data</span></span>
<span id="cb28-404"><a href="#cb28-404" aria-hidden="true" tabindex="-1"></a>perform_metabolomics_pca <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, sample_info) {</span>
<span id="cb28-405"><a href="#cb28-405" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Remove any NA values</span></span>
<span id="cb28-406"><a href="#cb28-406" aria-hidden="true" tabindex="-1"></a>  clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb28-407"><a href="#cb28-407" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-408"><a href="#cb28-408" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform PCA</span></span>
<span id="cb28-409"><a href="#cb28-409" aria-hidden="true" tabindex="-1"></a>  pca_result <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(clean_matrix, <span class="at">center =</span> <span class="cn">FALSE</span>, <span class="at">scale. =</span> <span class="cn">FALSE</span>)</span>
<span id="cb28-410"><a href="#cb28-410" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-411"><a href="#cb28-411" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract scores</span></span>
<span id="cb28-412"><a href="#cb28-412" aria-hidden="true" tabindex="-1"></a>  pca_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(pca_result<span class="sc">$</span>x) <span class="sc">%&gt;%</span></span>
<span id="cb28-413"><a href="#cb28-413" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-414"><a href="#cb28-414" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(clean_matrix),</span>
<span id="cb28-415"><a href="#cb28-415" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)],</span>
<span id="cb28-416"><a href="#cb28-416" aria-hidden="true" tabindex="-1"></a>      <span class="at">batch =</span> <span class="fu">factor</span>(sample_info<span class="sc">$</span>batch[<span class="fu">match</span>(<span class="fu">rownames</span>(clean_matrix), sample_info<span class="sc">$</span>sample_name)])</span>
<span id="cb28-417"><a href="#cb28-417" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-418"><a href="#cb28-418" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-419"><a href="#cb28-419" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate variance explained</span></span>
<span id="cb28-420"><a href="#cb28-420" aria-hidden="true" tabindex="-1"></a>  var_explained <span class="ot">&lt;-</span> (pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span> <span class="sc">/</span> <span class="fu">sum</span>(pca_result<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb28-421"><a href="#cb28-421" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-422"><a href="#cb28-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb28-423"><a href="#cb28-423" aria-hidden="true" tabindex="-1"></a>    <span class="at">pca_result =</span> pca_result,</span>
<span id="cb28-424"><a href="#cb28-424" aria-hidden="true" tabindex="-1"></a>    <span class="at">scores =</span> pca_scores,</span>
<span id="cb28-425"><a href="#cb28-425" aria-hidden="true" tabindex="-1"></a>    <span class="at">variance_explained =</span> var_explained</span>
<span id="cb28-426"><a href="#cb28-426" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-427"><a href="#cb28-427" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-428"><a href="#cb28-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-429"><a href="#cb28-429" aria-hidden="true" tabindex="-1"></a>pca_analysis <span class="ot">&lt;-</span> <span class="fu">perform_metabolomics_pca</span>(auto_scaled, sample_info)</span>
<span id="cb28-430"><a href="#cb28-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-431"><a href="#cb28-431" aria-hidden="true" tabindex="-1"></a><span class="co"># PCA scores plot</span></span>
<span id="cb28-432"><a href="#cb28-432" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pca_analysis<span class="sc">$</span>scores, <span class="fu">aes</span>(<span class="at">x =</span> PC1, <span class="at">y =</span> PC2, <span class="at">color =</span> group, <span class="at">shape =</span> batch)) <span class="sc">+</span></span>
<span id="cb28-433"><a href="#cb28-433" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-434"><a href="#cb28-434" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="fu">aes</span>(<span class="at">group =</span> group), <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb28-435"><a href="#cb28-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PCA Scores Plot - Metabolomics Data"</span>,</span>
<span id="cb28-436"><a href="#cb28-436" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="fu">paste0</span>(<span class="st">"PC1 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">1</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb28-437"><a href="#cb28-437" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="fu">paste0</span>(<span class="st">"PC2 ("</span>, <span class="fu">round</span>(pca_analysis<span class="sc">$</span>variance_explained[<span class="dv">2</span>], <span class="dv">1</span>), <span class="st">"%)"</span>),</span>
<span id="cb28-438"><a href="#cb28-438" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">"Group"</span>, <span class="at">shape =</span> <span class="st">"Batch"</span>) <span class="sc">+</span></span>
<span id="cb28-439"><a href="#cb28-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-440"><a href="#cb28-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-441"><a href="#cb28-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-442"><a href="#cb28-442" aria-hidden="true" tabindex="-1"></a><span class="fu">### Partial Least Squares Discriminant Analysis (PLS-DA)</span></span>
<span id="cb28-443"><a href="#cb28-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-446"><a href="#cb28-446" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-447"><a href="#cb28-447" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform PLS-DA using mixOmics (if available)</span></span>
<span id="cb28-448"><a href="#cb28-448" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb28-449"><a href="#cb28-449" aria-hidden="true" tabindex="-1"></a>  perform_plsda <span class="ot">&lt;-</span> <span class="cf">function</span>(scaled_matrix, groups) {</span>
<span id="cb28-450"><a href="#cb28-450" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean data</span></span>
<span id="cb28-451"><a href="#cb28-451" aria-hidden="true" tabindex="-1"></a>    clean_matrix <span class="ot">&lt;-</span> scaled_matrix[<span class="fu">complete.cases</span>(scaled_matrix), ]</span>
<span id="cb28-452"><a href="#cb28-452" aria-hidden="true" tabindex="-1"></a>    clean_groups <span class="ot">&lt;-</span> groups[<span class="fu">complete.cases</span>(scaled_matrix)]</span>
<span id="cb28-453"><a href="#cb28-453" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-454"><a href="#cb28-454" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Perform PLS-DA</span></span>
<span id="cb28-455"><a href="#cb28-455" aria-hidden="true" tabindex="-1"></a>    plsda_result <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">plsda</span>(clean_matrix, clean_groups, <span class="at">ncomp =</span> <span class="dv">3</span>)</span>
<span id="cb28-456"><a href="#cb28-456" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-457"><a href="#cb28-457" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(plsda_result)</span>
<span id="cb28-458"><a href="#cb28-458" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-459"><a href="#cb28-459" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-460"><a href="#cb28-460" aria-hidden="true" tabindex="-1"></a>  plsda_analysis <span class="ot">&lt;-</span> <span class="fu">perform_plsda</span>(auto_scaled, sample_info<span class="sc">$</span>group)</span>
<span id="cb28-461"><a href="#cb28-461" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-462"><a href="#cb28-462" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract PLS-DA scores</span></span>
<span id="cb28-463"><a href="#cb28-463" aria-hidden="true" tabindex="-1"></a>  plsda_scores <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(plsda_analysis<span class="sc">$</span>variates<span class="sc">$</span>X) <span class="sc">%&gt;%</span></span>
<span id="cb28-464"><a href="#cb28-464" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-465"><a href="#cb28-465" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> <span class="fu">rownames</span>(auto_scaled)[<span class="fu">complete.cases</span>(auto_scaled)],</span>
<span id="cb28-466"><a href="#cb28-466" aria-hidden="true" tabindex="-1"></a>      <span class="at">group =</span> sample_info<span class="sc">$</span>group[<span class="fu">complete.cases</span>(auto_scaled)]</span>
<span id="cb28-467"><a href="#cb28-467" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-468"><a href="#cb28-468" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-469"><a href="#cb28-469" aria-hidden="true" tabindex="-1"></a>  <span class="co"># PLS-DA scores plot</span></span>
<span id="cb28-470"><a href="#cb28-470" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(plsda_scores, <span class="fu">aes</span>(<span class="at">x =</span> comp1, <span class="at">y =</span> comp2, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb28-471"><a href="#cb28-471" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb28-472"><a href="#cb28-472" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_ellipse</span>(<span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb28-473"><a href="#cb28-473" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PLS-DA Scores Plot"</span>,</span>
<span id="cb28-474"><a href="#cb28-474" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Component 1"</span>, <span class="at">y =</span> <span class="st">"Component 2"</span>,</span>
<span id="cb28-475"><a href="#cb28-475" aria-hidden="true" tabindex="-1"></a>         <span class="at">color =</span> <span class="st">"Group"</span>) <span class="sc">+</span></span>
<span id="cb28-476"><a href="#cb28-476" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb28-477"><a href="#cb28-477" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb28-478"><a href="#cb28-478" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-479"><a href="#cb28-479" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: mixOmics package not available. Skipping PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-480"><a href="#cb28-480" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Install with: BiocManager::install('mixOmics')</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-481"><a href="#cb28-481" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-482"><a href="#cb28-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-483"><a href="#cb28-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-484"><a href="#cb28-484" aria-hidden="true" tabindex="-1"></a><span class="fu">### Variable Importance Analysis</span></span>
<span id="cb28-485"><a href="#cb28-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-488"><a href="#cb28-488" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-489"><a href="#cb28-489" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate VIP scores (if mixOmics is available and PLS-DA was run)</span></span>
<span id="cb28-490"><a href="#cb28-490" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">requireNamespace</span>(<span class="st">"mixOmics"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>) <span class="sc">&amp;&amp;</span> <span class="fu">exists</span>(<span class="st">"plsda_analysis"</span>)) {</span>
<span id="cb28-491"><a href="#cb28-491" aria-hidden="true" tabindex="-1"></a>  calculate_vip <span class="ot">&lt;-</span> <span class="cf">function</span>(plsda_result) {</span>
<span id="cb28-492"><a href="#cb28-492" aria-hidden="true" tabindex="-1"></a>    vip_scores <span class="ot">&lt;-</span> mixOmics<span class="sc">::</span><span class="fu">vip</span>(plsda_result)</span>
<span id="cb28-493"><a href="#cb28-493" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-494"><a href="#cb28-494" aria-hidden="true" tabindex="-1"></a>    vip_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-495"><a href="#cb28-495" aria-hidden="true" tabindex="-1"></a>      <span class="at">feature =</span> <span class="fu">rownames</span>(vip_scores),</span>
<span id="cb28-496"><a href="#cb28-496" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp1 =</span> vip_scores[, <span class="dv">1</span>],</span>
<span id="cb28-497"><a href="#cb28-497" aria-hidden="true" tabindex="-1"></a>      <span class="at">vip_comp2 =</span> <span class="cf">if</span>(<span class="fu">ncol</span>(vip_scores) <span class="sc">&gt;</span> <span class="dv">1</span>) vip_scores[, <span class="dv">2</span>] <span class="cf">else</span> <span class="cn">NA</span></span>
<span id="cb28-498"><a href="#cb28-498" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-499"><a href="#cb28-499" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-500"><a href="#cb28-500" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(vip_data)</span>
<span id="cb28-501"><a href="#cb28-501" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-502"><a href="#cb28-502" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-503"><a href="#cb28-503" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="fu">calculate_vip</span>(plsda_analysis)</span>
<span id="cb28-504"><a href="#cb28-504" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-505"><a href="#cb28-505" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot VIP scores</span></span>
<span id="cb28-506"><a href="#cb28-506" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(vip_scores, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(feature, vip_comp1), <span class="at">y =</span> vip_comp1)) <span class="sc">+</span></span>
<span id="cb28-507"><a href="#cb28-507" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"steelblue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb28-508"><a href="#cb28-508" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb28-509"><a href="#cb28-509" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb28-510"><a href="#cb28-510" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Variable Importance in Projection (VIP) Scores"</span>,</span>
<span id="cb28-511"><a href="#cb28-511" aria-hidden="true" tabindex="-1"></a>         <span class="at">subtitle =</span> <span class="st">"Red line indicates VIP &gt; 1 threshold"</span>,</span>
<span id="cb28-512"><a href="#cb28-512" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Features"</span>, <span class="at">y =</span> <span class="st">"VIP Score (Component 1)"</span>) <span class="sc">+</span></span>
<span id="cb28-513"><a href="#cb28-513" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb28-514"><a href="#cb28-514" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>))</span>
<span id="cb28-515"><a href="#cb28-515" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb28-516"><a href="#cb28-516" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-517"><a href="#cb28-517" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"Note: VIP scores require mixOmics package and successful PLS-DA analysis.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-518"><a href="#cb28-518" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create empty vip_scores object for downstream code</span></span>
<span id="cb28-519"><a href="#cb28-519" aria-hidden="true" tabindex="-1"></a>  vip_scores <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb28-520"><a href="#cb28-520" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-521"><a href="#cb28-521" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-522"><a href="#cb28-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-523"><a href="#cb28-523" aria-hidden="true" tabindex="-1"></a><span class="fu">## Metabolite Identification</span></span>
<span id="cb28-524"><a href="#cb28-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-525"><a href="#cb28-525" aria-hidden="true" tabindex="-1"></a><span class="fu">### Accurate Mass Matching</span></span>
<span id="cb28-526"><a href="#cb28-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-529"><a href="#cb28-529" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-530"><a href="#cb28-530" aria-hidden="true" tabindex="-1"></a><span class="co"># Function for accurate mass matching</span></span>
<span id="cb28-531"><a href="#cb28-531" aria-hidden="true" tabindex="-1"></a>accurate_mass_search <span class="ot">&lt;-</span> <span class="cf">function</span>(query_mz, mass_database, <span class="at">tolerance_ppm =</span> <span class="dv">5</span>) {</span>
<span id="cb28-532"><a href="#cb28-532" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create a simple mass database (normally you'd use real databases)</span></span>
<span id="cb28-533"><a href="#cb28-533" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">missing</span>(mass_database)) {</span>
<span id="cb28-534"><a href="#cb28-534" aria-hidden="true" tabindex="-1"></a>    mass_database <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-535"><a href="#cb28-535" aria-hidden="true" tabindex="-1"></a>      <span class="at">compound_name =</span> <span class="fu">c</span>(<span class="st">"Glucose"</span>, <span class="st">"Fructose"</span>, <span class="st">"Sucrose"</span>, <span class="st">"Lactose"</span>, <span class="st">"Maltose"</span>,</span>
<span id="cb28-536"><a href="#cb28-536" aria-hidden="true" tabindex="-1"></a>                       <span class="st">"Alanine"</span>, <span class="st">"Glycine"</span>, <span class="st">"Serine"</span>, <span class="st">"Threonine"</span>, <span class="st">"Valine"</span>),</span>
<span id="cb28-537"><a href="#cb28-537" aria-hidden="true" tabindex="-1"></a>      <span class="at">exact_mass =</span> <span class="fu">c</span>(<span class="fl">180.0634</span>, <span class="fl">180.0634</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>, <span class="fl">342.1162</span>,</span>
<span id="cb28-538"><a href="#cb28-538" aria-hidden="true" tabindex="-1"></a>                    <span class="fl">89.0477</span>, <span class="fl">75.0320</span>, <span class="fl">105.0426</span>, <span class="fl">119.0582</span>, <span class="fl">117.0790</span>),</span>
<span id="cb28-539"><a href="#cb28-539" aria-hidden="true" tabindex="-1"></a>      <span class="at">formula =</span> <span class="fu">c</span>(<span class="st">"C6H12O6"</span>, <span class="st">"C6H12O6"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>, <span class="st">"C12H22O11"</span>,</span>
<span id="cb28-540"><a href="#cb28-540" aria-hidden="true" tabindex="-1"></a>                 <span class="st">"C3H7NO2"</span>, <span class="st">"C2H5NO2"</span>, <span class="st">"C3H7NO3"</span>, <span class="st">"C4H9NO3"</span>, <span class="st">"C5H11NO2"</span>)</span>
<span id="cb28-541"><a href="#cb28-541" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-542"><a href="#cb28-542" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-543"><a href="#cb28-543" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-544"><a href="#cb28-544" aria-hidden="true" tabindex="-1"></a>  matches <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb28-545"><a href="#cb28-545" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-546"><a href="#cb28-546" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(query_mz)) {</span>
<span id="cb28-547"><a href="#cb28-547" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate mass differences</span></span>
<span id="cb28-548"><a href="#cb28-548" aria-hidden="true" tabindex="-1"></a>    mass_diff_ppm <span class="ot">&lt;-</span> <span class="fu">abs</span>(mass_database<span class="sc">$</span>exact_mass <span class="sc">-</span> query_mz[i]) <span class="sc">/</span> query_mz[i] <span class="sc">*</span> <span class="fl">1e6</span></span>
<span id="cb28-549"><a href="#cb28-549" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-550"><a href="#cb28-550" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Find matches within tolerance</span></span>
<span id="cb28-551"><a href="#cb28-551" aria-hidden="true" tabindex="-1"></a>    match_idx <span class="ot">&lt;-</span> <span class="fu">which</span>(mass_diff_ppm <span class="sc">&lt;=</span> tolerance_ppm)</span>
<span id="cb28-552"><a href="#cb28-552" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-553"><a href="#cb28-553" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(match_idx) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-554"><a href="#cb28-554" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (j <span class="cf">in</span> match_idx) {</span>
<span id="cb28-555"><a href="#cb28-555" aria-hidden="true" tabindex="-1"></a>        matches <span class="ot">&lt;-</span> <span class="fu">rbind</span>(matches, <span class="fu">data.frame</span>(</span>
<span id="cb28-556"><a href="#cb28-556" aria-hidden="true" tabindex="-1"></a>          <span class="at">query_mz =</span> query_mz[i],</span>
<span id="cb28-557"><a href="#cb28-557" aria-hidden="true" tabindex="-1"></a>          <span class="at">matched_compound =</span> mass_database<span class="sc">$</span>compound_name[j],</span>
<span id="cb28-558"><a href="#cb28-558" aria-hidden="true" tabindex="-1"></a>          <span class="at">exact_mass =</span> mass_database<span class="sc">$</span>exact_mass[j],</span>
<span id="cb28-559"><a href="#cb28-559" aria-hidden="true" tabindex="-1"></a>          <span class="at">formula =</span> mass_database<span class="sc">$</span>formula[j],</span>
<span id="cb28-560"><a href="#cb28-560" aria-hidden="true" tabindex="-1"></a>          <span class="at">mass_error_ppm =</span> mass_diff_ppm[j]</span>
<span id="cb28-561"><a href="#cb28-561" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb28-562"><a href="#cb28-562" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb28-563"><a href="#cb28-563" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-564"><a href="#cb28-564" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-565"><a href="#cb28-565" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-566"><a href="#cb28-566" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(matches)</span>
<span id="cb28-567"><a href="#cb28-567" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-568"><a href="#cb28-568" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-569"><a href="#cb28-569" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform mass matching for significant features</span></span>
<span id="cb28-570"><a href="#cb28-570" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(vip_scores)) {</span>
<span id="cb28-571"><a href="#cb28-571" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> vip_scores<span class="sc">$</span>feature[vip_scores<span class="sc">$</span>vip_comp1 <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb28-572"><a href="#cb28-572" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-573"><a href="#cb28-573" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use alternative method to identify significant features</span></span>
<span id="cb28-574"><a href="#cb28-574" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Based on highest variance across samples</span></span>
<span id="cb28-575"><a href="#cb28-575" aria-hidden="true" tabindex="-1"></a>  feature_variance <span class="ot">&lt;-</span> <span class="fu">apply</span>(filtered_data<span class="sc">$</span>metabolite_data[, <span class="sc">-</span><span class="dv">1</span>], <span class="dv">1</span>, var, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-576"><a href="#cb28-576" aria-hidden="true" tabindex="-1"></a>  top_features_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(feature_variance, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span><span class="fu">min</span>(<span class="dv">10</span>, <span class="fu">length</span>(feature_variance))]</span>
<span id="cb28-577"><a href="#cb28-577" aria-hidden="true" tabindex="-1"></a>  significant_features <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id[top_features_idx]</span>
<span id="cb28-578"><a href="#cb28-578" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-579"><a href="#cb28-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-580"><a href="#cb28-580" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(significant_features) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-581"><a href="#cb28-581" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract m/z values for significant features</span></span>
<span id="cb28-582"><a href="#cb28-582" aria-hidden="true" tabindex="-1"></a>  significant_mz <span class="ot">&lt;-</span> filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>mz[</span>
<span id="cb28-583"><a href="#cb28-583" aria-hidden="true" tabindex="-1"></a>    filtered_data<span class="sc">$</span>metabolite_data<span class="sc">$</span>metabolite_id <span class="sc">%in%</span> significant_features</span>
<span id="cb28-584"><a href="#cb28-584" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb28-585"><a href="#cb28-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-586"><a href="#cb28-586" aria-hidden="true" tabindex="-1"></a>  mass_matches <span class="ot">&lt;-</span> <span class="fu">accurate_mass_search</span>(significant_mz)</span>
<span id="cb28-587"><a href="#cb28-587" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-588"><a href="#cb28-588" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(mass_matches) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-589"><a href="#cb28-589" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"Potential metabolite identifications:</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-590"><a href="#cb28-590" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(mass_matches)</span>
<span id="cb28-591"><a href="#cb28-591" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-592"><a href="#cb28-592" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">"No matches found in database</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-593"><a href="#cb28-593" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-594"><a href="#cb28-594" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-595"><a href="#cb28-595" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-596"><a href="#cb28-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-597"><a href="#cb28-597" aria-hidden="true" tabindex="-1"></a><span class="fu">### MS/MS Spectrum Matching</span></span>
<span id="cb28-598"><a href="#cb28-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-601"><a href="#cb28-601" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-602"><a href="#cb28-602" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate MS/MS data for demonstration</span></span>
<span id="cb28-603"><a href="#cb28-603" aria-hidden="true" tabindex="-1"></a>simulate_msms_spectrum <span class="ot">&lt;-</span> <span class="cf">function</span>(precursor_mz, <span class="at">intensity =</span> <span class="dv">1000</span>) {</span>
<span id="cb28-604"><a href="#cb28-604" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate realistic fragment ions</span></span>
<span id="cb28-605"><a href="#cb28-605" aria-hidden="true" tabindex="-1"></a>  n_fragments <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">15</span>, <span class="dv">1</span>)</span>
<span id="cb28-606"><a href="#cb28-606" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-607"><a href="#cb28-607" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Common neutral losses for metabolites</span></span>
<span id="cb28-608"><a href="#cb28-608" aria-hidden="true" tabindex="-1"></a>  neutral_losses <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">18.01</span>, <span class="fl">28.01</span>, <span class="fl">44.00</span>, <span class="fl">46.00</span>, <span class="fl">60.02</span>, <span class="fl">62.00</span>)</span>
<span id="cb28-609"><a href="#cb28-609" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-610"><a href="#cb28-610" aria-hidden="true" tabindex="-1"></a>  fragment_mz <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb28-611"><a href="#cb28-611" aria-hidden="true" tabindex="-1"></a>  fragment_intensity <span class="ot">&lt;-</span> <span class="fu">numeric</span>(n_fragments)</span>
<span id="cb28-612"><a href="#cb28-612" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-613"><a href="#cb28-613" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_fragments) {</span>
<span id="cb28-614"><a href="#cb28-614" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">&lt;=</span> <span class="fu">length</span>(neutral_losses) <span class="sc">&amp;&amp;</span> <span class="fu">runif</span>(<span class="dv">1</span>) <span class="sc">&gt;</span> <span class="fl">0.3</span>) {</span>
<span id="cb28-615"><a href="#cb28-615" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Use neutral loss</span></span>
<span id="cb28-616"><a href="#cb28-616" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> precursor_mz <span class="sc">-</span> neutral_losses[i]</span>
<span id="cb28-617"><a href="#cb28-617" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb28-618"><a href="#cb28-618" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Random fragment</span></span>
<span id="cb28-619"><a href="#cb28-619" aria-hidden="true" tabindex="-1"></a>      fragment_mz[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">50</span>, precursor_mz <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb28-620"><a href="#cb28-620" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-621"><a href="#cb28-621" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-622"><a href="#cb28-622" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Random intensity</span></span>
<span id="cb28-623"><a href="#cb28-623" aria-hidden="true" tabindex="-1"></a>    fragment_intensity[i] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.1</span>, <span class="dv">1</span>) <span class="sc">*</span> intensity</span>
<span id="cb28-624"><a href="#cb28-624" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-625"><a href="#cb28-625" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-626"><a href="#cb28-626" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sort by m/z</span></span>
<span id="cb28-627"><a href="#cb28-627" aria-hidden="true" tabindex="-1"></a>  order_idx <span class="ot">&lt;-</span> <span class="fu">order</span>(fragment_mz)</span>
<span id="cb28-628"><a href="#cb28-628" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-629"><a href="#cb28-629" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb28-630"><a href="#cb28-630" aria-hidden="true" tabindex="-1"></a>    <span class="at">mz =</span> fragment_mz[order_idx],</span>
<span id="cb28-631"><a href="#cb28-631" aria-hidden="true" tabindex="-1"></a>    <span class="at">intensity =</span> fragment_intensity[order_idx]</span>
<span id="cb28-632"><a href="#cb28-632" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb28-633"><a href="#cb28-633" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-634"><a href="#cb28-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-635"><a href="#cb28-635" aria-hidden="true" tabindex="-1"></a><span class="co"># Create example MS/MS spectra</span></span>
<span id="cb28-636"><a href="#cb28-636" aria-hidden="true" tabindex="-1"></a>example_msms <span class="ot">&lt;-</span> <span class="fu">simulate_msms_spectrum</span>(<span class="fl">180.0634</span>)  <span class="co"># Glucose-like spectrum</span></span>
<span id="cb28-637"><a href="#cb28-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-638"><a href="#cb28-638" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot MS/MS spectrum</span></span>
<span id="cb28-639"><a href="#cb28-639" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(example_msms, <span class="fu">aes</span>(<span class="at">x =</span> mz, <span class="at">y =</span> intensity)) <span class="sc">+</span></span>
<span id="cb28-640"><a href="#cb28-640" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> mz, <span class="at">yend =</span> <span class="dv">0</span>), <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb28-641"><a href="#cb28-641" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb28-642"><a href="#cb28-642" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Simulated MS/MS Spectrum"</span>,</span>
<span id="cb28-643"><a href="#cb28-643" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"m/z"</span>, <span class="at">y =</span> <span class="st">"Relative Intensity"</span>) <span class="sc">+</span></span>
<span id="cb28-644"><a href="#cb28-644" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-645"><a href="#cb28-645" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-646"><a href="#cb28-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-647"><a href="#cb28-647" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pathway Analysis</span></span>
<span id="cb28-648"><a href="#cb28-648" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-649"><a href="#cb28-649" aria-hidden="true" tabindex="-1"></a><span class="fu">### Metabolite Set Enrichment</span></span>
<span id="cb28-650"><a href="#cb28-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-653"><a href="#cb28-653" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-654"><a href="#cb28-654" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate pathway database</span></span>
<span id="cb28-655"><a href="#cb28-655" aria-hidden="true" tabindex="-1"></a>create_pathway_database <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb28-656"><a href="#cb28-656" aria-hidden="true" tabindex="-1"></a>  pathways <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-657"><a href="#cb28-657" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Glycolysis"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_1"</span>, <span class="st">"Met_3"</span>, <span class="st">"Met_5"</span>, <span class="st">"Met_7"</span>, <span class="st">"Met_9"</span>),</span>
<span id="cb28-658"><a href="#cb28-658" aria-hidden="true" tabindex="-1"></a>    <span class="st">"TCA_Cycle"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_2"</span>, <span class="st">"Met_4"</span>, <span class="st">"Met_6"</span>, <span class="st">"Met_8"</span>, <span class="st">"Met_10"</span>),</span>
<span id="cb28-659"><a href="#cb28-659" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Amino_Acid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_11"</span>, <span class="st">"Met_12"</span>, <span class="st">"Met_13"</span>, <span class="st">"Met_14"</span>, <span class="st">"Met_15"</span>),</span>
<span id="cb28-660"><a href="#cb28-660" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Lipid_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_16"</span>, <span class="st">"Met_17"</span>, <span class="st">"Met_18"</span>, <span class="st">"Met_19"</span>, <span class="st">"Met_20"</span>),</span>
<span id="cb28-661"><a href="#cb28-661" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nucleotide_Metabolism"</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"Met_21"</span>, <span class="st">"Met_22"</span>, <span class="st">"Met_23"</span>, <span class="st">"Met_24"</span>, <span class="st">"Met_25"</span>)</span>
<span id="cb28-662"><a href="#cb28-662" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-663"><a href="#cb28-663" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-664"><a href="#cb28-664" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(pathways)</span>
<span id="cb28-665"><a href="#cb28-665" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-666"><a href="#cb28-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-667"><a href="#cb28-667" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform pathway enrichment</span></span>
<span id="cb28-668"><a href="#cb28-668" aria-hidden="true" tabindex="-1"></a>pathway_enrichment <span class="ot">&lt;-</span> <span class="cf">function</span>(significant_metabolites, pathway_db, total_metabolites) {</span>
<span id="cb28-669"><a href="#cb28-669" aria-hidden="true" tabindex="-1"></a>  enrichment_results <span class="ot">&lt;-</span> <span class="fu">data.frame</span>()</span>
<span id="cb28-670"><a href="#cb28-670" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-671"><a href="#cb28-671" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (pathway_name <span class="cf">in</span> <span class="fu">names</span>(pathway_db)) {</span>
<span id="cb28-672"><a href="#cb28-672" aria-hidden="true" tabindex="-1"></a>    pathway_metabolites <span class="ot">&lt;-</span> pathway_db[[pathway_name]]</span>
<span id="cb28-673"><a href="#cb28-673" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-674"><a href="#cb28-674" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate overlap</span></span>
<span id="cb28-675"><a href="#cb28-675" aria-hidden="true" tabindex="-1"></a>    overlap <span class="ot">&lt;-</span> <span class="fu">intersect</span>(significant_metabolites, pathway_metabolites)</span>
<span id="cb28-676"><a href="#cb28-676" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-677"><a href="#cb28-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate contingency table values</span></span>
<span id="cb28-678"><a href="#cb28-678" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; in pathway</span></span>
<span id="cb28-679"><a href="#cb28-679" aria-hidden="true" tabindex="-1"></a>    b <span class="ot">&lt;-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># significant &amp; not in pathway</span></span>
<span id="cb28-680"><a href="#cb28-680" aria-hidden="true" tabindex="-1"></a>    c <span class="ot">&lt;-</span> <span class="fu">length</span>(pathway_metabolites) <span class="sc">-</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; in pathway</span></span>
<span id="cb28-681"><a href="#cb28-681" aria-hidden="true" tabindex="-1"></a>    d <span class="ot">&lt;-</span> total_metabolites <span class="sc">-</span> <span class="fu">length</span>(significant_metabolites) <span class="sc">-</span> </span>
<span id="cb28-682"><a href="#cb28-682" aria-hidden="true" tabindex="-1"></a>         <span class="fu">length</span>(pathway_metabolites) <span class="sc">+</span> <span class="fu">length</span>(overlap)  <span class="co"># not significant &amp; not in pathway</span></span>
<span id="cb28-683"><a href="#cb28-683" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-684"><a href="#cb28-684" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure all values are non-negative</span></span>
<span id="cb28-685"><a href="#cb28-685" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (d <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">||</span> <span class="fu">any</span>(<span class="fu">c</span>(a, b, c, d) <span class="sc">&lt;</span> <span class="dv">0</span>)) {</span>
<span id="cb28-686"><a href="#cb28-686" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Skip this pathway if contingency table is invalid</span></span>
<span id="cb28-687"><a href="#cb28-687" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb28-688"><a href="#cb28-688" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-689"><a href="#cb28-689" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-690"><a href="#cb28-690" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fisher's exact test</span></span>
<span id="cb28-691"><a href="#cb28-691" aria-hidden="true" tabindex="-1"></a>    contingency_table <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(a, b, c, d), <span class="at">nrow =</span> <span class="dv">2</span>)</span>
<span id="cb28-692"><a href="#cb28-692" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-693"><a href="#cb28-693" aria-hidden="true" tabindex="-1"></a>    fisher_test <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb28-694"><a href="#cb28-694" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fisher.test</span>(contingency_table, <span class="at">alternative =</span> <span class="st">"greater"</span>)</span>
<span id="cb28-695"><a href="#cb28-695" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb28-696"><a href="#cb28-696" aria-hidden="true" tabindex="-1"></a>      <span class="fu">list</span>(<span class="at">p.value =</span> <span class="dv">1</span>, <span class="at">estimate =</span> <span class="dv">1</span>)</span>
<span id="cb28-697"><a href="#cb28-697" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb28-698"><a href="#cb28-698" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb28-699"><a href="#cb28-699" aria-hidden="true" tabindex="-1"></a>    enrichment_results <span class="ot">&lt;-</span> <span class="fu">rbind</span>(enrichment_results, <span class="fu">data.frame</span>(</span>
<span id="cb28-700"><a href="#cb28-700" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> pathway_name,</span>
<span id="cb28-701"><a href="#cb28-701" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">length</span>(overlap),</span>
<span id="cb28-702"><a href="#cb28-702" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">length</span>(pathway_metabolites),</span>
<span id="cb28-703"><a href="#cb28-703" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">length</span>(significant_metabolites),</span>
<span id="cb28-704"><a href="#cb28-704" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> fisher_test<span class="sc">$</span>p.value,</span>
<span id="cb28-705"><a href="#cb28-705" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">as.numeric</span>(fisher_test<span class="sc">$</span>estimate)</span>
<span id="cb28-706"><a href="#cb28-706" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb28-707"><a href="#cb28-707" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-708"><a href="#cb28-708" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-709"><a href="#cb28-709" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multiple testing correction</span></span>
<span id="cb28-710"><a href="#cb28-710" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-711"><a href="#cb28-711" aria-hidden="true" tabindex="-1"></a>    enrichment_results<span class="sc">$</span>p_adjusted <span class="ot">&lt;-</span> <span class="fu">p.adjust</span>(enrichment_results<span class="sc">$</span>p_value, <span class="at">method =</span> <span class="st">"fdr"</span>)</span>
<span id="cb28-712"><a href="#cb28-712" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(enrichment_results[<span class="fu">order</span>(enrichment_results<span class="sc">$</span>p_value), ])</span>
<span id="cb28-713"><a href="#cb28-713" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb28-714"><a href="#cb28-714" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">data.frame</span>(</span>
<span id="cb28-715"><a href="#cb28-715" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway =</span> <span class="fu">character</span>(<span class="dv">0</span>),</span>
<span id="cb28-716"><a href="#cb28-716" aria-hidden="true" tabindex="-1"></a>      <span class="at">overlap_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb28-717"><a href="#cb28-717" aria-hidden="true" tabindex="-1"></a>      <span class="at">pathway_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb28-718"><a href="#cb28-718" aria-hidden="true" tabindex="-1"></a>      <span class="at">significant_size =</span> <span class="fu">integer</span>(<span class="dv">0</span>),</span>
<span id="cb28-719"><a href="#cb28-719" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_value =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb28-720"><a href="#cb28-720" aria-hidden="true" tabindex="-1"></a>      <span class="at">odds_ratio =</span> <span class="fu">numeric</span>(<span class="dv">0</span>),</span>
<span id="cb28-721"><a href="#cb28-721" aria-hidden="true" tabindex="-1"></a>      <span class="at">p_adjusted =</span> <span class="fu">numeric</span>(<span class="dv">0</span>)</span>
<span id="cb28-722"><a href="#cb28-722" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb28-723"><a href="#cb28-723" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-724"><a href="#cb28-724" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-725"><a href="#cb28-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-726"><a href="#cb28-726" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform enrichment analysis</span></span>
<span id="cb28-727"><a href="#cb28-727" aria-hidden="true" tabindex="-1"></a>pathway_db <span class="ot">&lt;-</span> <span class="fu">create_pathway_database</span>()</span>
<span id="cb28-728"><a href="#cb28-728" aria-hidden="true" tabindex="-1"></a>significant_metabolites <span class="ot">&lt;-</span> significant_features</span>
<span id="cb28-729"><a href="#cb28-729" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-730"><a href="#cb28-730" aria-hidden="true" tabindex="-1"></a>enrichment_results <span class="ot">&lt;-</span> <span class="fu">pathway_enrichment</span>(</span>
<span id="cb28-731"><a href="#cb28-731" aria-hidden="true" tabindex="-1"></a>  significant_metabolites, </span>
<span id="cb28-732"><a href="#cb28-732" aria-hidden="true" tabindex="-1"></a>  pathway_db, </span>
<span id="cb28-733"><a href="#cb28-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ncol</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb28-734"><a href="#cb28-734" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-735"><a href="#cb28-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-736"><a href="#cb28-736" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(enrichment_results) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-737"><a href="#cb28-737" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(enrichment_results)</span>
<span id="cb28-738"><a href="#cb28-738" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-739"><a href="#cb28-739" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Visualize enrichment results</span></span>
<span id="cb28-740"><a href="#cb28-740" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(enrichment_results, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pathway, <span class="sc">-</span><span class="fu">log10</span>(p_value)), </span>
<span id="cb28-741"><a href="#cb28-741" aria-hidden="true" tabindex="-1"></a>                                <span class="at">y =</span> <span class="sc">-</span><span class="fu">log10</span>(p_value))) <span class="sc">+</span></span>
<span id="cb28-742"><a href="#cb28-742" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">fill =</span> <span class="st">"coral"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb28-743"><a href="#cb28-743" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="sc">-</span><span class="fu">log10</span>(<span class="fl">0.05</span>), <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb28-744"><a href="#cb28-744" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb28-745"><a href="#cb28-745" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Pathway Enrichment Analysis"</span>,</span>
<span id="cb28-746"><a href="#cb28-746" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Pathway"</span>, <span class="at">y =</span> <span class="st">"-log10(P-value)"</span>) <span class="sc">+</span></span>
<span id="cb28-747"><a href="#cb28-747" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb28-748"><a href="#cb28-748" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p)</span>
<span id="cb28-749"><a href="#cb28-749" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-750"><a href="#cb28-750" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"No significant pathway enrichment found.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-751"><a href="#cb28-751" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-752"><a href="#cb28-752" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-753"><a href="#cb28-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-754"><a href="#cb28-754" aria-hidden="true" tabindex="-1"></a><span class="fu">## Quality Control and Batch Correction</span></span>
<span id="cb28-755"><a href="#cb28-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-756"><a href="#cb28-756" aria-hidden="true" tabindex="-1"></a><span class="fu">### QC Sample Analysis</span></span>
<span id="cb28-757"><a href="#cb28-757" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-760"><a href="#cb28-760" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb28-761"><a href="#cb28-761" aria-hidden="true" tabindex="-1"></a><span class="co"># Simulate QC samples</span></span>
<span id="cb28-762"><a href="#cb28-762" aria-hidden="true" tabindex="-1"></a>simulate_qc_samples <span class="ot">&lt;-</span> <span class="cf">function</span>(original_matrix, <span class="at">n_qc =</span> <span class="dv">5</span>) {</span>
<span id="cb28-763"><a href="#cb28-763" aria-hidden="true" tabindex="-1"></a>  <span class="co"># QC samples are typically pooled samples with intermediate values</span></span>
<span id="cb28-764"><a href="#cb28-764" aria-hidden="true" tabindex="-1"></a>  qc_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> n_qc, <span class="at">ncol =</span> <span class="fu">ncol</span>(original_matrix))</span>
<span id="cb28-765"><a href="#cb28-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"QC_"</span>, <span class="dv">1</span><span class="sc">:</span>n_qc)</span>
<span id="cb28-766"><a href="#cb28-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(qc_matrix) <span class="ot">&lt;-</span> <span class="fu">colnames</span>(original_matrix)</span>
<span id="cb28-767"><a href="#cb28-767" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-768"><a href="#cb28-768" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_qc) {</span>
<span id="cb28-769"><a href="#cb28-769" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(original_matrix)) {</span>
<span id="cb28-770"><a href="#cb28-770" aria-hidden="true" tabindex="-1"></a>      <span class="co"># QC intensity as mean of original samples with some variation</span></span>
<span id="cb28-771"><a href="#cb28-771" aria-hidden="true" tabindex="-1"></a>      qc_matrix[i, j] <span class="ot">&lt;-</span> <span class="fu">mean</span>(original_matrix[, j], <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> </span>
<span id="cb28-772"><a href="#cb28-772" aria-hidden="true" tabindex="-1"></a>                         <span class="fu">rlnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="fl">0.1</span>)  <span class="co"># 10% variation</span></span>
<span id="cb28-773"><a href="#cb28-773" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-774"><a href="#cb28-774" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-775"><a href="#cb28-775" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-776"><a href="#cb28-776" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(qc_matrix)</span>
<span id="cb28-777"><a href="#cb28-777" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-778"><a href="#cb28-778" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-779"><a href="#cb28-779" aria-hidden="true" tabindex="-1"></a>qc_matrix <span class="ot">&lt;-</span> <span class="fu">simulate_qc_samples</span>(filtered_data<span class="sc">$</span>intensity_matrix)</span>
<span id="cb28-780"><a href="#cb28-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-781"><a href="#cb28-781" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate QC stability</span></span>
<span id="cb28-782"><a href="#cb28-782" aria-hidden="true" tabindex="-1"></a>calculate_qc_stability <span class="ot">&lt;-</span> <span class="cf">function</span>(qc_matrix) {</span>
<span id="cb28-783"><a href="#cb28-783" aria-hidden="true" tabindex="-1"></a>  qc_cv <span class="ot">&lt;-</span> <span class="fu">apply</span>(qc_matrix, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">/</span> <span class="fu">mean</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">*</span> <span class="dv">100</span>)</span>
<span id="cb28-784"><a href="#cb28-784" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-785"><a href="#cb28-785" aria-hidden="true" tabindex="-1"></a>  stability_summary <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-786"><a href="#cb28-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">feature =</span> <span class="fu">names</span>(qc_cv),</span>
<span id="cb28-787"><a href="#cb28-787" aria-hidden="true" tabindex="-1"></a>    <span class="at">qc_cv =</span> qc_cv,</span>
<span id="cb28-788"><a href="#cb28-788" aria-hidden="true" tabindex="-1"></a>    <span class="at">stable =</span> qc_cv <span class="sc">&lt;</span> <span class="dv">20</span>  <span class="co"># 20% CV threshold for stability</span></span>
<span id="cb28-789"><a href="#cb28-789" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb28-790"><a href="#cb28-790" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb28-791"><a href="#cb28-791" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(stability_summary)</span>
<span id="cb28-792"><a href="#cb28-792" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-793"><a href="#cb28-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-794"><a href="#cb28-794" aria-hidden="true" tabindex="-1"></a>qc_stability <span class="ot">&lt;-</span> <span class="fu">calculate_qc_stability</span>(qc_matrix)</span>
<span id="cb28-795"><a href="#cb28-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-796"><a href="#cb28-796" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize QC stability</span></span>
<span id="cb28-797"><a href="#cb28-797" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(qc_stability, <span class="fu">aes</span>(<span class="at">x =</span> qc_cv, <span class="at">fill =</span> stable)) <span class="sc">+</span></span>
<span id="cb28-798"><a href="#cb28-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(<span class="at">bins =</span> <span class="dv">20</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb28-799"><a href="#cb28-799" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"TRUE"</span> <span class="ot">=</span> <span class="st">"green"</span>, <span class="st">"FALSE"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb28-800"><a href="#cb28-800" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">20</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb28-801"><a href="#cb28-801" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"QC Sample Stability Assessment"</span>,</span>
<span id="cb28-802"><a href="#cb28-802" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"QC CV (%)"</span>, <span class="at">y =</span> <span class="st">"Count"</span>,</span>
<span id="cb28-803"><a href="#cb28-803" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">"Stable (CV &lt; 20%)"</span>) <span class="sc">+</span></span>
<span id="cb28-804"><a href="#cb28-804" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb28-805"><a href="#cb28-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-806"><a href="#cb28-806" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Percentage of stable features:"</span>, </span>
<span id="cb28-807"><a href="#cb28-807" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">sum</span>(qc_stability<span class="sc">$</span>stable) <span class="sc">/</span> <span class="fu">nrow</span>(qc_stability) <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-808"><a href="#cb28-808" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb28-809"><a href="#cb28-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-810"><a href="#cb28-810" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercises</span></span>
<span id="cb28-811"><a href="#cb28-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-812"><a href="#cb28-812" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Process real metabolomics data using XCMS</span>
<span id="cb28-813"><a href="#cb28-813" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Compare different normalization methods on your dataset</span>
<span id="cb28-814"><a href="#cb28-814" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Implement a complete identification workflow using spectral databases</span>
<span id="cb28-815"><a href="#cb28-815" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Perform time-course metabolomics analysis</span>
<span id="cb28-816"><a href="#cb28-816" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Build a metabolomics data processing pipeline with quality control</span>
<span id="cb28-817"><a href="#cb28-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-818"><a href="#cb28-818" aria-hidden="true" tabindex="-1"></a><span class="fu">## Summary</span></span>
<span id="cb28-819"><a href="#cb28-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-820"><a href="#cb28-820" aria-hidden="true" tabindex="-1"></a>This chapter covered comprehensive metabolomics data analysis workflows, including peak detection, data normalization, multivariate analysis, metabolite identification, and pathway analysis. These methods form the foundation for extracting biological insights from metabolomics experiments.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>